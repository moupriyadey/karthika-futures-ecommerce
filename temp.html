def calculate_cart_totals(current_cart_session, artworks_data):
    cart_items_for_display = []
    subtotal_before_gst = 0
    total_gst_amount = 0
    
    # Create a lookup dictionary for artworks by SKU for efficient access
    artworks_dict_by_sku = {art.get('sku'): art for art in artworks_data}

    for item_id, item_data in current_cart_session.items():
        sku = item_data.get('sku')
        artwork_info = artworks_dict_by_sku.get(sku)

        if not artwork_info:
            print(f"WARNING: Artwork with SKU {sku} not found while calculating cart totals. Skipping item: {item_id}")
            continue # Skip this item if artwork data is missing

        # Ensure all necessary fields exist, provide defaults
        item_name = artwork_info.get('name', 'Unknown Artwork')
        item_image = artwork_info.get('images')[0] if artwork_info.get('images') else 'images/placeholder.png'
        item_quantity = int(item_data.get('quantity', 1))
        
        # Calculate unit price including options based on current artwork data
        unit_price_before_gst = artwork_info.get('original_price', 0.0)
        
        # Add option prices based on artwork data and selected options
        selected_size = item_data.get('size', 'Original')
        selected_frame = item_data.get('frame', 'None')
        selected_glass = item_data.get('glass', 'None')

        if selected_size == 'A4': unit_price_before_gst += artwork_info.get('size_a4', 0.0)
        elif selected_size == 'A5': unit_price_before_gst += artwork_info.get('size_a5', 0.0)
        elif selected_size == 'Letter': unit_price_before_gst += artwork_info.get('size_letter', 0.0)
        elif selected_size == 'Legal': unit_price_before_gst += artwork_info.get('size_legal', 0.0)

        if selected_frame == 'Wooden': unit_price_before_gst += artwork_info.get('frame_wooden', 0.0)
        elif selected_frame == 'Metal': unit_price_before_gst += artwork_info.get('frame_metal', 0.0)
        elif selected_frame == 'PVC': unit_price_before_gst += artwork_info.get('frame_pvc', 0.0)
        
        if selected_glass == 'Standard': unit_price_before_gst += artwork_info.get('glass_price', 0.0)

        # Apply GST percentage from artwork info, not from cart item data (to always use latest)
        gst_percentage = artwork_info.get('gst_percentage', DEFAULT_GST_RATE_PERCENTAGE)

        item_total_price_before_gst = unit_price_before_gst * item_quantity
        item_gst_amount = item_total_price_before_gst * (gst_percentage / 100)
        item_total_price_with_gst = item_total_price_before_gst + item_gst_amount

        subtotal_before_gst += item_total_price_before_gst
        total_gst_amount += item_gst_amount

        cart_items_for_display.append({
            'id': item_id,
            'sku': sku,
            'name': item_name,
            'image': item_image,
            'unit_price': round(unit_price_before_gst, 2), # Unit price before GST, with options
            'quantity': item_quantity,
            'size': selected_size,
            'frame': selected_frame,
            'glass': selected_glass,
            'gst_percentage': gst_percentage,
            'gst_amount': round(item_gst_amount, 2),
            'total_price_before_gst': round(item_total_price_before_gst, 2),
            'total_price': round(item_total_price_with_gst, 2),
            'stock_available': artwork_info.get('stock', 0) # Pass stock to frontend for max quantity
        })

    cgst_amount = round(total_gst_amount / 2, 2)
    sgst_amount = round(total_gst_amount / 2, 2)

    shipping_charge = DEFAULT_SHIPPING_CHARGE
    if subtotal_before_gst >= MAX_SHIPPING_COST_FREE_THRESHOLD:
        shipping_charge = 0

    grand_total = round(subtotal_before_gst + total_gst_amount + shipping_charge, 2)

    return {
        'cart_items': cart_items_for_display,
        'subtotal_before_gst': round(subtotal_before_gst, 2),
        'total_gst_amount': round(total_gst_amount, 2),
        'cgst_amount': cgst_amount,
        'sgst_amount': sgst_amount,
        'shipping_charge': round(shipping_charge, 2),
        'grand_total': round(grand_total, 2)
    }

# --- Cart View Route (updated to use helper) ---
@app.route('/cart')
def cart():
    # Load all artworks once for calculations
    artworks_data = load_artworks()
    
    # Get cart from session, default to empty dict if not present
    current_cart_session = session.get('cart', {})
    
    # Calculate all cart totals using the helper function
    cart_summary = calculate_cart_totals(current_cart_session, artworks_data)

    # Ensure all expected variables are passed to the template
    return render_template('cart.html',
                           cart_items=cart_summary['cart_items'],
                           subtotal_before_gst=cart_summary['subtotal_before_gst'],
                           total_gst_amount=cart_summary['total_gst_amount'],
                           cgst_amount=cart_summary['cgst_amount'],
                           sgst_amount=cart_summary['sgst_amount'],
                           shipping_charge=cart_summary['shipping_charge'],
                           grand_total=cart_summary['grand_total'],
                           MAX_SHIPPING_COST_FREE_THRESHOLD=MAX_SHIPPING_COST_FREE_THRESHOLD) # Pass constant

# --- AJAX Endpoint: Update Cart Item Quantity ---
@app.route('/update_cart_item_quantity', methods=['POST'])
def update_cart_item_quantity():
    try:
        data = request.get_json()
        item_id = data.get('itemId')
        new_quantity = int(data.get('newQuantity'))

        if not item_id or new_quantity is None:
            return jsonify(success=False, message="Invalid request data."), 400

        current_cart_session = session.get('cart', {})
        if item_id not in current_cart_session:
            return jsonify(success=False, message="Item not found in cart."), 404

        # Validate new_quantity against artwork stock
        artworks_data = load_artworks()
        artwork_sku = current_cart_session[item_id].get('sku')
        artwork_info = next((a for a in artworks_data if a.get('sku') == artwork_sku), None)

        if not artwork_info:
            return jsonify(success=False, message="Artwork details not found for cart item."), 404
        
        available_stock = artwork_info.get('stock', 0)

        if new_quantity < 1:
            # If quantity is 0 or less, effectively remove the item
            del current_cart_session[item_id]
            session['cart'] = current_cart_session # Update session immediately
            flash("Item removed from cart.", "info") # Flash message for removal

        elif new_quantity > available_stock:
            # Clamp quantity to available stock and inform user
            current_cart_session[item_id]['quantity'] = available_stock
            session['cart'] = current_cart_session
            flash(f"Only {available_stock} of {artwork_info.get('name')} available. Quantity adjusted.", "warning")
            print(f"WARNING: Requested quantity {new_quantity} for {item_id} exceeds stock {available_stock}. Adjusted to {available_stock}.")

        else:
            current_cart_session[item_id]['quantity'] = new_quantity
            session['cart'] = current_cart_session

        # Recalculate totals after modification
        updated_cart_summary = calculate_cart_totals(current_cart_session, artworks_data)
        
        return jsonify(success=True, message="Cart updated.", **updated_cart_summary), 200

    except Exception as e:
        print(f"ERROR: update_cart_item_quantity: {e}")
        return jsonify(success=False, message=f"Error updating cart quantity: {e}"), 500

# --- AJAX Endpoint: Remove From Cart ---
@app.route('/remove_from_cart', methods=['POST'])
def remove_from_cart():
    try:
        data = request.get_json()
        item_id = data.get('itemId')

        if not item_id:
            return jsonify(success=False, message="Item ID is required."), 400

        current_cart_session = session.get('cart', {})
        if item_id in current_cart_session:
            del current_cart_session[item_id]
            session['cart'] = current_cart_session # Update session
            flash("Item removed from cart.", "info") # Flash message for removal
        else:
            return jsonify(success=False, message="Item not found in cart."), 404
        
        # Recalculate totals after removal
        artworks_data = load_artworks()
        updated_cart_summary = calculate_cart_totals(current_cart_session, artworks_data)

        return jsonify(success=True, message="Item removed.", **updated_cart_summary), 200

    except Exception as e:
        print(f"ERROR: remove_from_cart: {e}")
        return jsonify(success=False, message=f"Error removing item from cart: {e}"), 500

# ... (rest of your app.py routes and functions) ...
