{% extends '_base.html' %}

{% block title %}Manage Orders - Karthika Futures{% endblock %}

{% block content %}
<div class="container-fluid py-4 main-content-area">
    <h2 class="mb-4 text-center">Manage Orders</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="container mt-2">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% include 'admin_navbar.html' %}

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">All Orders   admin_orders_view.html</h5>
        </div>
        <div class="card-body">
            <form class="row g-3 mb-3" action="{{ url_for('admin_orders_view') }}" method="GET">
                <div class="col-md-4">
                    <input type="text" class="form-control" name="search_query" placeholder="Search by Order ID, Customer Name, Email" value="{{ current_search_query }}">
                </div>
                <div class="col-md-4">
                    <select class="form-select" name="status">
                        <option value="">All Statuses</option>
                        <option value="Pending Payment" {% if current_filter_status == 'Pending Payment' %}selected{% endif %}>Pending Payment</option>
                        <option value="Payment Submitted - Awaiting Verification" {% if current_filter_status == 'Payment Submitted - Awaiting Verification' %}selected{% endif %}>Payment Submitted - Awaiting Verification</option>
                        <option value="Payment Verified – Preparing Order" {% if current_filter_status == 'Payment Verified – Preparing Order' %}selected{% endif %}>Payment Verified – Preparing Order</option>
                        <option value="Shipped" {% if current_filter_status == 'Shipped' %}selected{% endif %}>Shipped</option>
                        <option value="Delivered" {% if current_filter_status == 'Delivered' %}selected{% endif %}>Delivered</option>
                        <option value="Cancelled by User" {% if current_filter_status == 'Cancelled by User' %}selected{% endif %}>Cancelled by User</option>
                        <option value="Cancelled by Admin" {% if current_filter_status == 'Cancelled by Admin' %}selected{% endif %}>Cancelled by Admin</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select" name="invoice_status">
                        <option value="">All Invoice Statuses</option>
                        <option value="Not Applicable" {% if current_filter_invoice_status == 'Not Applicable' %}selected{% endif %}>Not Applicable</option>
                        <option value="Prepared" {% if current_filter_invoice_status == 'Prepared' %}selected{% endif %}>Prepared</option>
                        <option value="Sent" {% if current_filter_invoice_status == 'Sent' %}selected{% endif %}>Sent</option>
                        <option value="Edited" {% if current_filter_invoice_status == 'Edited' %}selected{% endif %}>Edited</option>
                        <option value="Email Failed" {% if current_filter_invoice_status == 'Email Failed' %}selected{% endif %}>Email Failed</option>
                        <option value="Held" {% if current_filter_invoice_status == 'Held' %}selected{% endif %}>Held by Admin</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                </div>
                <div class="col-md-2">
                    <a href="{{ url_for('admin_orders_view') }}" class="btn btn-outline-secondary w-100">Clear Filters</a>
                </div>
                <div class="col-md-2">
                    <a href="{{ url_for('export_orders_csv') }}" class="btn btn-success w-100"><i class="fas fa-file-csv me-2"></i>Export CSV</a>
                </div>
            </form>

            <!-- New Form for deleting selected orders -->
            <form method="POST" action="{{ url_for('delete_selected_orders') }}" id="bulkDeleteForm">
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllOrders"></th>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Cancellation Details</th>
                                <th>Invoice</th>
                                <th>Courier</th>
                                <th>Tracking ID</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr>
                                <td><input type="checkbox" name="selected_orders[]" value="{{ order.id }}"></td>
                                <td style="max-width: 180px; white-space: nowrap; overflow-x: auto;" title="{{ order.id }}">{{ order.id }}</td>
                                <td>{{ order.customer_name }} ({{ order.customer_email }})</td>
                                <td>{{ order.order_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>₹{{ order.total_amount | floatformat(2) }}</td>
                                <td>
                                    <span class="badge {% if order.status == 'Delivered' %}bg-success{% elif order.status == 'Shipped' %}bg-primary{% elif 'Pending' in order.status or 'Awaiting' in order.status %}bg-warning text-dark{% elif 'Cancelled' in order.status %}bg-danger{% else %}bg-secondary{% endif %}">{{ order.status }}</span>
                                </td>
                                <td>
                                    {% if 'Cancelled' in order.status %}
                                        <div class="text-muted small">
                                            On: {{ order.cancellation_timestamp.strftime('%Y-%m-%d %H:%M') if order.cancellation_timestamp else 'N/A' }}<br>
                                            By: {% if order.cancelled_by_admin %}<span class="badge bg-danger">Admin</span>{% elif order.cancelled_by_user %}<span class="badge bg-warning text-dark">User</span>{% else %}Unknown{% endif %}<br>
                                            Reason: {{ order.cancellation_reason or 'No reason provided.' }}
                                        </div>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>
                                    {% set invoice_det = order.get_invoice_details() %}
                                    {% if invoice_det.get('is_held_by_admin') %}
                                        <span class="badge bg-danger">Held</span>
                                    {% elif invoice_det.get('invoice_status') == 'Sent' %}
                                        <span class="badge bg-success">Sent</span>
                                    {% elif invoice_det.get('invoice_status') == 'Prepared' %}
                                        <span class="badge bg-info">Prepared</span>
                                    {% elif invoice_det.get('invoice_status') == 'Email Failed' %}
                                        <span class="badge bg-danger">Email Failed</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ invoice_det.get('invoice_status', 'N/A') }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ order.courier or 'N/A' }}</td>
                                <td>{{ order.tracking_number or 'N/A' }}</td>
                                <td>
                                    <a href="{{ url_for('admin_order_details', order_id=order.id) }}" class="btn btn-sm btn-info me-1">View</a>
                                    <button type="button" class="btn btn-sm btn-danger delete-order-btn" data-order-id="{{ order.id }}">Delete</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <button type="submit" class="btn btn-danger mt-2" onclick="return confirm('Are you sure you want to delete selected orders?')">Delete Selected Orders</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('selectAllOrders')?.addEventListener('change', function () {
        document.querySelectorAll('input[name="selected_orders[]"]').forEach(cb => {
            cb.checked = this.checked;
        });
    });
</script>
{% endblock %}
