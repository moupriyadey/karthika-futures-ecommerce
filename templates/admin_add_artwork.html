{% extends '_base.html' %}

{% block title %}Add New Artwork - Karthika Futures{% endblock %}

{% block content %}
<div class="container main-content-area py-5">
<!-- ðŸ”¥ FLOATING LIVE PRICE PREVIEW (ADMIN ADD) -->
<div id="livePriceBox"
     style="
        position: fixed;
        top: 120px;
        right: 20px;
        width: 270px;
        background: #ffffff;
        border: 2px solid #0d6efd;
        border-radius: 14px;
        padding: 15px;
        z-index: 9999;
        box-shadow: 0 10px 26px rgba(0,0,0,0.18);
     ">

  <h6 style="font-weight: 800; margin-bottom: 10px; color:#0d6efd;">
    ðŸ’° Live Price Preview
  </h6>

  <div class="text-sm mb-1">
    Base / Discount Price: â‚¹ <span id="lp-base">0.00</span>
  </div>

  <div class="text-sm mb-1">
    GST + CESS: â‚¹ <span id="lp-gst">0.00</span>
  </div>

  <div class="text-sm mb-1">
    Shipping: â‚¹ <span id="lp-shipping">0.00</span>
  </div>

  <div class="text-sm mb-1">
    Options (Max): â‚¹ <span id="lp-options">0.00</span>
  </div>

  <hr>

  <div style="font-size: 19px; font-weight: 900; color:#198754;">
    Final Price: â‚¹ <span id="lp-final">0.00</span>
  </div>

  <div class="text-muted text-xs mt-2">
    Updates in real-time while editing
  </div>
</div>

    <!-- Page Title -->
    <h2 class="text-center mb-4 text-primary fw-bold">
        <i class="fas fa-plus-circle me-2"></i>Add New Artwork
    </h2>

    <!-- Main Card -->
    <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
        
        <!-- Header -->
        <div class="card-header bg-primary text-white py-3">
            <h4 class="mb-0"><i class="fas fa-image me-2"></i>Artwork Information</h4>
        </div>

        <!-- Body -->
        <div class="card-body p-4">

            <form action="{{ url_for('admin_add_artwork') }}" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <!-- ============================
                     SECTION 1 â€“ BASIC DETAILS
                ============================= -->
                <div class="section-title mt-3 mb-2 text-primary fw-bold">
                    <i class="fas fa-info-circle me-2"></i>Basic Details
                </div>
                <div class="row g-3">

                    <div class="col-md-4">
                        <label class="form-label fw-bold">SKU <span class="text-danger">*</span></label>
                        <input type="text" class="form-control shadow-sm"
                               id="sku"
                               name="sku" required
                               placeholder="Unique Code (e.g., KRISH001)"
                               value="{{ form_data.sku if form_data.sku is defined else '' }}">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">HSN Code <span class="text-danger">*</span></label>
                        <input type="text" class="form-control shadow-sm"
                               id="hsn_code"
                               name="hsn_code" required
                               placeholder="e.g., 9701"
                               value="{{ form_data.hsn_code if form_data.hsn_code is defined else '' }}">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">HSN Description</label>
                        <input type="text" class="form-control shadow-sm"
                               id="hsn_description"
                               name="hsn_description"
                               placeholder="e.g., Paintings, Drawings"
                               value="{{ form_data.hsn_description if form_data.hsn_description is defined else '' }}">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">Artwork Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control shadow-sm"
                               id="name"
                               name="name" required placeholder="e.g., Krishna on Lotus"
                               value="{{ form_data.name if form_data.name is defined else '' }}">
                    </div>

                    <div class="col-12">
                        <label class="form-label fw-bold">
                            Description
                            <span class="text-primary fw-bold">(Supports Multi-Section)</span>
                        </label>

                        <textarea class="form-control shadow-sm" rows="4"
                                  id="description"
                                  name="description"
                                  placeholder="Example:
USP: Used to remove extensions ||
Weight: 120 ml ||
Offers: Free shipping above â‚¹999">{{ form_data.description if form_data.description is defined else '' }}</textarea>

                        <div class="form-text text-muted small mt-1">
                            <strong>Tip:</strong> Use <code>||</code> to separate sections.<br>
                            <strong>Format:</strong> <code>Title: description || Title 2: description 2</code><br>
                            Example:
                            <code>USP: Used to remove extensions || Weight: 120 ml || Offers: Free shipping above â‚¹999</code>
                        </div>
                    </div>

                </div>

                <hr class="my-4">

                <!-- ============================
                     SECTION 2 â€“ PRICE + STOCK
                ============================= -->
                <div class="section-title mt-3 mb-2 text-primary fw-bold">
                    <i class="fas fa-tag me-2"></i>Pricing & Stock
                </div>

                <div class="row g-3">

                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            Base Price (Before GST) <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control shadow-sm"
                               id="original_price"
                               name="original_price" step="0.01" min="0"
                               placeholder="e.g., 450.00"
                               value="{{ form_data.original_price if form_data.original_price is defined else '' }}" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            Discount Price <i class="fas fa-info-circle text-muted"
                            title="Optional. If lower than base price, this becomes the selling price."></i>
                        </label>
                        <input type="number" class="form-control shadow-sm"
                               id="discount_price"
                               name="discount_price" step="0.01" min="0"
                               placeholder="e.g., 399.00"
                               value="{{ form_data.discount_price if form_data.discount_price is defined else '' }}">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">Stock <span class="text-danger">*</span></label>
                        <input type="number" class="form-control shadow-sm"
                               id="stock"
                               name="stock" min="0"
                               placeholder="Available quantity"
                               value="{{ form_data.stock if form_data.stock is defined else '' }}" required>
                    </div>
                </div>

                <hr class="my-4">

                <!-- ============================
                     SECTION 3 â€“ SHIPPING DETAILS
                ============================= -->
                <div class="section-title mt-3 mb-2 text-primary fw-bold">
                    <i class="fas fa-shipping-fast me-2"></i>Shipping Details
                </div>

                <div class="row g-3">

                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            Shipping Charge (â‚¹)
                            <i class="fas fa-info-circle text-muted"
                               title="Enter 0 for free shipping."></i>
                        </label>
                        <input type="number" class="form-control shadow-sm"
                               id="shipping_charge"
                               name="shipping_charge" step="0.01" min="0"
                               placeholder="e.g., 60"
                               value="{{ form_data.shipping_charge if form_data.shipping_charge is defined else '0.00' }}" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            Shipping Slab Size
                            <i class="fas fa-info-circle text-muted"
                               title="e.g., 3 â†’ charge applies once for up to 3 items."></i>
                        </label>
                        <input type="number" class="form-control shadow-sm"
                               id="shipping_slab_size"
                               name="shipping_slab_size" min="1"
                               value="{{ form_data.shipping_slab_size if form_data.shipping_slab_size is defined else '3' }}" required>
                    </div>
                </div>

                <!-- Admin-only package details -->
                <div class="alert alert-warning mt-4">
                    <strong>Admin-only:</strong> Package weight & dimensions help estimate courier costs.
                </div>

                <div class="row g-3 mt-2">

                    <div class="col-md-3">
                        <label class="form-label fw-bold">Weight (grams)</label>
                        <input type="number" class="form-control shadow-sm"
                               id="package_weight_grams"
                               name="package_weight_grams" placeholder="e.g., 450">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold">Length (cm)</label>
                        <input type="number" class="form-control shadow-sm"
                               id="package_length_cm"
                               name="package_length_cm" placeholder="e.g., 30">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold">Width (cm)</label>
                        <input type="number" class="form-control shadow-sm"
                               id="package_width_cm"
                               name="package_width_cm" placeholder="e.g., 20">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold">Height (cm)</label>
                        <input type="number" class="form-control shadow-sm"
                               id="package_height_cm"
                               name="package_height_cm" placeholder="e.g., 5">
                    </div>
                </div>

                <hr class="my-4">

                <!-- ============================
                     SECTION 4 â€“ CATEGORY
                ============================= -->
                <div class="section-title mt-3 mb-2 text-primary fw-bold">
                    <i class="fas fa-folder-open me-2"></i>Category
                </div>

                <select class="form-select shadow-sm" id="category_id" name="category_id" required>
                    <option value="">-- Select Category --</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}"
                            {% if form_data.category_id is defined and form_data.category_id|string == category.id|string %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>

                <hr class="my-4">

                <!-- ============================
                     SECTION 5 â€“ GST DETAILS
                ============================= -->
                <div class="section-title mt-3 mb-2 text-primary fw-bold">
                    <i class="fas fa-file-invoice me-2"></i>GST Details
                </div>

                <div class="row g-3">

                    <div class="col-12">
                        <label class="form-label fw-bold">GST Type</label>
                        <select class="form-select shadow-sm" id="gst_type" name="gst_type" required>
                            <option value="intra_state"
                                {% if form_data.gst_type == 'intra_state' %}selected{% endif %}>
                                Intra-State (CGST + SGST)
                            </option>
                            <option value="inter_state"
                                {% if form_data.gst_type == 'inter_state' %}selected{% endif %}>
                                Inter-State (IGST)
                            </option>
                            <option value="union_territory"
                                {% if form_data.gst_type == 'union_territory' %}selected{% endif %}>
                                Union Territory (CGST + UGST)
                            </option>
                        </select>
                    </div>

                    <!-- GST percentages -->
                    {% set gst_fields = [
                        ('cgst_percentage','CGST (%)'),
                        ('sgst_percentage','SGST (%)'),
                        ('igst_percentage','IGST (%)'),
                        ('ugst_percentage','UGST (%)'),
                        ('cess_percentage','CESS (%)')
                    ] %}

                    {% for field, label in gst_fields %}
                    <div class="col-md-2">
                        <label class="form-label fw-bold">{{ label }}</label>
                        <input type="number" class="form-control shadow-sm"
                               id="{{ field }}"
                               name="{{ field }}" step="0.01" min="0" max="100"
                               value="{{ form_data[field] if form_data[field] is defined else '0.00' }}" required>
                    </div>
                    {% endfor %}
                </div>

                <hr class="my-4">

                <!-- ============================
                     SECTION 6 â€“ CUSTOM OPTIONS
                ============================= -->
                <div class="section-title mt-3 mb-2 text-primary fw-bold">
                    <i class="fas fa-cog me-2"></i>Custom Options (Size, Frame, etc.)
                </div>

                <div id="custom-options-builder" class="p-3 border bg-light rounded-3 shadow-sm mb-3">
                    <button type="button" class="btn btn-success btn-sm mb-3" id="add-option-group-btn">
                        <i class="fas fa-plus me-2"></i>Add Option Group
                    </button>
                    <input type="hidden" name="custom_options_json" id="custom_options_json">

                    {% if form_data.custom_option_groups %}
                    <script>
                        const initialCustomOptionsData = {{ form_data.custom_option_groups | tojson }};
                    </script>
                    {% endif %}
                </div>

                <hr class="my-4">

                <!-- ============================
                     SECTION 7 â€“ IMAGE UPLOAD
                ============================= -->
                <div class="section-title mt-3 mb-2 text-primary fw-bold">
                    <i class="fas fa-images me-2"></i>Artwork Images
                </div>

                <div class="mb-4">
                    <input type="file" name="images" id="images"
                           class="form-control shadow-sm" multiple required>
                    <small class="text-muted">Upload clear images. First image becomes the primary display.</small>
                </div>

                <div class="form-check mb-4">
                    <input type="checkbox" name="is_featured" id="is_featured"
                           class="form-check-input"
                           {% if form_data.is_featured %}checked{% endif %}>
                    <label class="form-check-label fw-bold" for="is_featured">
                        Feature this artwork
                    </label>
                </div>

                <!-- ============================
                     FINAL PRICE (Floating Card)
                ============================= -->
                <div class="card shadow border mt-4 mb-4 bg-light price-summary-sticky">
                    <div class="card-body">
                        <h4 class="text-success fw-bold mb-2">
                            <i class="fas fa-indian-rupee-sign me-2"></i>Estimated Final Price
                        </h4>

                        <div class="d-flex justify-content-between mb-1">
                            <span class="fw-bold">
                                Price incl. GST <span class="text-muted">(without delivery)</span>:
                            </span>
                            <span class="fw-bold" id="price-without-shipping">â‚¹ 0.00</span>
                        </div>

                        <div class="d-flex justify-content-between mb-1">
                            <span>Delivery charge:</span>
                            <span id="price-delivery">â‚¹ 0.00</span>
                        </div>

                        <hr class="my-2">

                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">Customer Pays (incl. delivery):</span>
                            <span class="fw-bold text-success" id="final-price-display">â‚¹ 0.00</span>
                        </div>

                        <small class="text-muted d-block mt-2">
                            Calculated from base/discount price + highest custom options + GST + CESS + delivery.
                        </small>
                    </div>
                </div>

                <!-- ============================
                     SUBMIT BUTTON
                ============================= -->
                <button type="submit" class="btn btn-primary btn-lg w-100 mt-3 shadow-sm">
                    <i class="fas fa-save me-2"></i>Add Artwork
                </button>
            </form>

        </div>
    </div>
</div>

<style>
@media (min-width: 992px) {
    .price-summary-sticky {
        position: sticky;
        bottom: 1rem;
        z-index: 10;
    }
}
</style>

{% endblock %}

{% block extra_js %}
    {{ super() }}
    <script>
     
document.addEventListener("DOMContentLoaded", function () {

  function val(id) {
    const el = document.getElementById(id);
    return el ? parseFloat(el.value || 0) : 0;
  }

  function calculateFloatingPrice() {

    const originalPrice = val("original_price");
    const discountPrice = val("discount_price");
    const shipping = val("shipping_charge");

    let basePrice = originalPrice;
    if (discountPrice > 0 && discountPrice < originalPrice) {
      basePrice = discountPrice;
    }

    const cgst = val("cgst_percentage");
    const sgst = val("sgst_percentage");
    const igst = val("igst_percentage");
    const ugst = val("ugst_percentage");
    const cess = val("cess_percentage");

    const gstType = document.getElementById("gst_type")?.value;

    let gstPercent = 0;
    if (gstType === "intra_state") gstPercent = cgst + sgst;
    else if (gstType === "inter_state") gstPercent = igst;
    else if (gstType === "union_territory") gstPercent = cgst + ugst;

    gstPercent += cess;

    /* ðŸ”¹ Max option price per group */
    let optionsPrice = 0;
    document.querySelectorAll(".option-group").forEach(group => {
      let max = 0;
      group.querySelectorAll('input[type="number"]').forEach(inp => {
        const v = parseFloat(inp.value) || 0;
        if (v > max) max = v;
      });
      optionsPrice += max;
    });

    const subtotal = basePrice + optionsPrice;
    const gstAmount = subtotal * (gstPercent / 100);
    const finalPrice = subtotal + gstAmount + shipping;

    document.getElementById("lp-base").innerText = basePrice.toFixed(2);
    document.getElementById("lp-gst").innerText = gstAmount.toFixed(2);
    document.getElementById("lp-shipping").innerText = shipping.toFixed(2);
    document.getElementById("lp-options").innerText = optionsPrice.toFixed(2);
    document.getElementById("lp-final").innerText = finalPrice.toFixed(2);
  }

  const watchIds = [
    "original_price","discount_price","shipping_charge",
    "cgst_percentage","sgst_percentage",
    "igst_percentage","ugst_percentage","cess_percentage","gst_type"
  ];

  watchIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener("input", calculateFloatingPrice);
      el.addEventListener("change", calculateFloatingPrice);
    }
  });

  document.addEventListener("input", e => {
    if (e.target.closest(".option-group")) {
      calculateFloatingPrice();
    }
  });

  calculateFloatingPrice(); // initial
});


    document.addEventListener('DOMContentLoaded', function() {
        const customOptionsBuilder = document.getElementById('custom-options-builder');
        const addOptionGroupBtn = document.getElementById('add-option-group-btn');
        const form = document.querySelector('form');
        const customOptionsJsonInput = document.getElementById('custom_options_json');
        
        let optionGroupCount = 0;

        // --- Price Calculation Logic ---
        const priceInputs = [
            'original_price', 'discount_price', 'shipping_charge',
            'cgst_percentage', 'sgst_percentage',
            'igst_percentage', 'ugst_percentage', 'cess_percentage'
        ];
        const gstTypeSelect = document.getElementById('gst_type');
        const finalPriceDisplay = document.getElementById('final-price-display');

        function calculateTotalPrice() {
            const originalPrice = parseFloat(document.getElementById('original_price').value) || 0;
            const discountPrice = parseFloat(document.getElementById('discount_price').value) || 0;

            let basePrice = originalPrice;
            if (discountPrice > 0 && discountPrice < originalPrice) {
                basePrice = discountPrice;
            }
            
            const shippingCharge = parseFloat(document.getElementById('shipping_charge').value) || 0;
            const gstType = gstTypeSelect ? gstTypeSelect.value : 'intra_state';
            let gstPercentage = 0;

            if (gstType === 'intra_state') {
                const cgst = parseFloat(document.getElementById('cgst_percentage').value) || 0;
                const sgst = parseFloat(document.getElementById('sgst_percentage').value) || 0;
                gstPercentage = cgst + sgst;
            } else if (gstType === 'inter_state') {
                gstPercentage = parseFloat(document.getElementById('igst_percentage').value) || 0;
            } else if (gstType === 'union_territory') {
                const cgst = parseFloat(document.getElementById('cgst_percentage').value) || 0;
                const ugst = parseFloat(document.getElementById('ugst_percentage').value) || 0;
                gstPercentage = cgst + ugst;
            }

            const cessPercentage = parseFloat(document.getElementById('cess_percentage').value) || 0;

            // Calculate additional price from custom options
            let customOptionsPrice = 0;
            const optionGroupsEls = customOptionsBuilder.querySelectorAll('.option-group');
            optionGroupsEls.forEach(group => {
                const priceInputsEls = group.querySelectorAll('.option-values-container input[type="number"]');
                let maxOptionPrice = 0;
                priceInputsEls.forEach(input => {
                    const price = parseFloat(input.value) || 0;
                    if (price > maxOptionPrice) {
                        maxOptionPrice = price;
                    }
                });
                customOptionsPrice += maxOptionPrice;
            });
            
            const subtotal = basePrice + customOptionsPrice;
            const gstAmount = subtotal * (gstPercentage / 100);
            const cessAmount = subtotal * (cessPercentage / 100);

            const totalWithoutShipping = subtotal + gstAmount + cessAmount;
            const totalWithShipping = totalWithoutShipping + shippingCharge;

            const priceWithoutShippingEl = document.getElementById('price-without-shipping');
            const priceDeliveryEl = document.getElementById('price-delivery');

            if (priceWithoutShippingEl) {
                priceWithoutShippingEl.textContent = `â‚¹ ${totalWithoutShipping.toFixed(2)}`;
            }
            if (priceDeliveryEl) {
                priceDeliveryEl.textContent = `â‚¹ ${shippingCharge.toFixed(2)}`;
            }

            if (finalPriceDisplay) {
                finalPriceDisplay.textContent = `â‚¹ ${totalWithShipping.toFixed(2)}`;
            }
        }

        // Attach event listeners to all price-related fields
        priceInputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', calculateTotalPrice);
            }
        });
        if (gstTypeSelect) {
            gstTypeSelect.addEventListener('change', calculateTotalPrice);
        }

        // --- Custom Options Builder Logic ---
        function createOptionValueElement(container, valueName = '', priceImpact = '0.00') {
            const valueDiv = document.createElement('div');
            valueDiv.classList.add('input-group', 'mb-2');
            valueDiv.innerHTML = `
                <input type="text" class="form-control form-control-sm" placeholder="Value (e.g., A4)" value="${valueName}" required>
                <span class="input-group-text">â‚¹</span>
                <input type="number" class="form-control form-control-sm price-input" placeholder="Price Impact (e.g., 500)" step="0.01" min="0" value="${priceImpact}" required>
                <button type="button" class="btn btn-danger btn-sm remove-option-value-btn">âœ•</button>
            `;
            valueDiv.querySelector('.remove-option-value-btn').addEventListener('click', () => {
                valueDiv.remove();
                calculateTotalPrice(); // Re-calc when an option is removed
            });
            valueDiv.querySelector('.price-input').addEventListener('input', calculateTotalPrice);
            container.appendChild(valueDiv);
        }

        function createOptionGroupElement(groupName = '', values = {}) {
            const groupId = optionGroupCount++;
            const groupDiv = document.createElement('div');
            groupDiv.classList.add('option-group', 'mb-3', 'p-3', 'border', 'rounded-3', 'bg-white');
            groupDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control me-2" placeholder="Option Group Name (e.g., Size)" value="${groupName}" required>
                    <button type="button" class="btn btn-sm btn-danger remove-option-group-btn">Remove Group</button>
                </div>
                <div class="option-values-container"></div>
                <button type="button" class="btn btn-sm btn-success add-option-value-btn mt-2"><i class="fas fa-plus me-2"></i>Add Option Value</button>
            `;

            const addOptionValueBtn = groupDiv.querySelector('.add-option-value-btn');
            const valuesContainer = groupDiv.querySelector('.option-values-container');

            addOptionValueBtn.addEventListener('click', () => {
                createOptionValueElement(valuesContainer);
            });

            groupDiv.querySelector('.remove-option-group-btn').addEventListener('click', () => {
                groupDiv.remove();
                calculateTotalPrice(); // Re-calc when a group is removed
            });

            if (Object.keys(values).length > 0) {
                for (const [key, value] of Object.entries(values)) {
                    createOptionValueElement(valuesContainer, key, value);
                }
            } else {
                createOptionValueElement(valuesContainer);
            }

            customOptionsBuilder.insertBefore(groupDiv, addOptionGroupBtn);
        }

        addOptionGroupBtn.addEventListener('click', () => {
            createOptionGroupElement();
            calculateTotalPrice();
        });
        
        let initialData = {};
        try {
            initialData = initialCustomOptionsData;
        } catch (e) {}

        if (Object.keys(initialData).length > 0) {
            for (const [groupName, values] of Object.entries(initialData)) {
                createOptionGroupElement(groupName, values);
            }
        }

        form.addEventListener('submit', function(event) {
            const customOptionsData = {};
            const optionGroupsEls = customOptionsBuilder.querySelectorAll('.option-group');

            optionGroupsEls.forEach(group => {
                const groupNameInput = group.querySelector('input[type="text"]');
                const groupName = groupNameInput.value.trim();
                
                if (groupName) {
                    const optionValues = {};
                    const valueInputs = group.querySelectorAll('.option-values-container .input-group');
                    
                    valueInputs.forEach(valueInput => {
                        const nameInput = valueInput.querySelector('input[type="text"]');
                        const priceInput = valueInput.querySelector('input[type="number"]');

                        const optionName = nameInput.value.trim();
                        const priceImpact = parseFloat(priceInput.value);

                        if (optionName && !isNaN(priceImpact)) {
                            optionValues[optionName] = priceImpact;
                        }
                    });

                    if (Object.keys(optionValues).length > 0) {
                        customOptionsData[groupName] = optionValues;
                    }
                }
            });

            customOptionsJsonInput.value = JSON.stringify(customOptionsData);
        });

        // Initial calculation on page load
        calculateTotalPrice();
    });
    </script>
{% endblock %}
