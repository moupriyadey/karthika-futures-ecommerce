{% extends '_base.html' %}

{% block title %}Add New Artwork - Karthika Futures{% endblock %}

{% block content %}
<div class="container main-content-area py-5">
    <h2 class="text-center mb-4 text-primary">Add New Artwork</h2>

    <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Artwork Details</h4>
        </div>
        <div class="card-body p-4">
            <form action="{{ url_for('admin_add_artwork') }}" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="sku" class="form-label">SKU <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="sku" name="sku" required value="{{ form_data.sku if form_data.sku is defined else '' }}">
                    </div>
                    <div class="col-md-6">
    <label for="hsn_code" class="form-label">HSN Code <span class="text-danger">*</span></label>
    <input type="text" class="form-control" id="hsn_code" name="hsn_code" required value="{{ form_data.hsn_code if form_data.hsn_code is defined else artwork.hsn_code if artwork is defined else '' }}">
</div>
<div class="col-md-6">
    <label for="hsn_description" class="form-label">HSN Description</label>
    <input type="text" class="form-control" id="hsn_description" name="hsn_description" value="{{ form_data.hsn_description if form_data.hsn_description is defined else artwork.hsn_description if artwork is defined else '' }}">
</div>
                    <div class="col-md-6">
                        <label for="name" class="form-label">Artwork Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" required value="{{ form_data.name if form_data.name is defined else '' }}">
                    </div>
                    
                    <div class="col-12">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="5">{{ form_data.description if form_data.description is defined else '' }}</textarea>
                    </div>


                    <div class="card mb-4 bg-light shadow-sm">
                    <div class="card-body">
                        <h4 class="card-title text-success mb-3">Estimated Final Price</h4>
                        <div class="d-flex justify-content-between">
                            <strong>Total Price (including GST & Shipping):</strong>
                            <strong class="text-success" id="final-price-display">₹ 0.00</strong>
                        </div>
                        <small class="text-muted mt-2 d-block">This is an estimated price based on the highest-priced custom options and all other charges.</small>
                    </div>
                </div>

                    <div class="col-md-6">
                        <label for="original_price" class="form-label">Original Price (₹, Before GST) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="original_price" name="original_price" step="0.01" min="0" required value="{{ form_data.original_price if form_data.original_price is defined else '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="stock" class="form-label">Stock Quantity <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="stock" name="stock" min="0" required value="{{ form_data.stock if form_data.stock is defined else '' }}">
                    </div>

                    <div class="col-12">
                        <label for="category_id" class="form-label">Category <span class="text-danger">*</span></label>
                        <select class="form-select" id="category_id" name="category_id" required>
                            <option value="">Select a Category</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" {% if form_data.category_id is defined and form_data.category_id|string == category.id|string %}selected{% endif %}>{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label for="shipping_charge" class="form-label">Shipping Charge (₹) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="shipping_charge" name="shipping_charge" step="0.01" min="0" value="{{ form_data.shipping_charge if form_data.shipping_charge is defined else '0.00' }}" required>
                        <div class="form-text text-muted">Enter 0 for free shipping.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="shipping_slab_size" class="form-label">Shipping Slab Size <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="shipping_slab_size" name="shipping_slab_size" min="1" value="{{ form_data.shipping_slab_size if form_data.shipping_slab_size is defined else '3' }}" required>
                        <div class="form-text text-muted">Items per charge (e.g., 3 means 1 shipping fee covers up to 3 items).</div>
                    </div>
                </div>

                <hr class="my-4">
                <h5 class="text-primary">GST Details</h5>
                <div class="row g-3">
                    <div class="col-12">
                        <label for="gst_type" class="form-label">GST Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="gst_type" name="gst_type" required>
                            <option value="intra_state" {% if form_data.gst_type is defined and form_data.gst_type == 'intra_state' %}selected{% endif %}>Intra-State (CGST + SGST)</option>
                            <option value="inter_state" {% if form_data.gst_type is defined and form_data.gst_type == 'inter_state' %}selected{% endif %}>Inter-State (IGST)</option>
                            <option value="union_territory" {% if form_data.gst_type is defined and form_data.gst_type == 'union_territory' %}selected{% endif %}>Union Territory (CGST + UGST)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="cgst_percentage" class="form-label">CGST (%) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="cgst_percentage" name="cgst_percentage" step="0.01" min="0" max="100" value="{{ form_data.cgst_percentage if form_data.cgst_percentage is defined else '0.00' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label for="sgst_percentage" class="form-label">SGST (%) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="sgst_percentage" name="sgst_percentage" step="0.01" min="0" max="100" value="{{ form_data.sgst_percentage if form_data.sgst_percentage is defined else '0.00' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label for="igst_percentage" class="form-label">IGST (%) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="igst_percentage" name="igst_percentage" step="0.01" min="0" max="100" value="{{ form_data.igst_percentage if form_data.igst_percentage is defined else '0.00' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label for="ugst_percentage" class="form-label">UGST (%) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="ugst_percentage" name="ugst_percentage" step="0.01" min="0" max="100" value="{{ form_data.ugst_percentage if form_data.ugst_percentage is defined else '0.00' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label for="cess_percentage" class="form-label">CESS (%) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="cess_percentage" name="cess_percentage" step="0.01" min="0" max="100" value="{{ form_data.cess_percentage if form_data.cess_percentage is defined else '0.00' }}" required>
                    </div>
                </div>

                <hr class="my-4">
                <h5 class="text-primary">Custom Options (e.g., Size, Frame)</h5>
                <div id="custom-options-builder" class="mb-3 p-3 border rounded-3 bg-light">
                    <button type="button" class="btn btn-secondary btn-sm mb-3" id="add-option-group-btn"><i class="fas fa-plus me-2"></i>Add Option Group</button>
                    <input type="hidden" name="custom_options_json" id="custom_options_json">
                    {% if form_data.custom_options is defined %}
                    <script>
                        const initialCustomOptionsData = {{ form_data.custom_options | tojson }};
                    </script>
                    {% endif %}
                </div>

                <hr class="my-4">
                <h5 class="text-primary">Artwork Images</h5>
                <div class="mb-3">
                    <label for="images" class="form-label">Upload Images <span class="text-danger">*</span></label>
                    <input type="file" class="form-control" id="images" name="images" accept="image/*" multiple required>
                </div>

                <div class="form-check mb-4">
                    <input type="checkbox" class="form-check-input" id="is_featured" name="is_featured" {% if form_data.is_featured is defined and form_data.is_featured %}checked{% endif %}>
                    <label class="form-check-label" for="is_featured">Mark as Featured Artwork</label>
                </div>

                
                
                <button type="submit" class="btn btn-primary btn-lg w-100"><i class="fas fa-save me-2"></i>Add Artwork</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const customOptionsBuilder = document.getElementById('custom-options-builder');
        const addOptionGroupBtn = document.getElementById('add-option-group-btn');
        const form = document.querySelector('form');
        const customOptionsJsonInput = document.getElementById('custom_options_json');
        
        let optionGroupCount = 0;

        // --- NEW: Price Calculation Logic ---
        const priceInputs = [
            'original_price', 'shipping_charge', 'cgst_percentage', 'sgst_percentage',
            'igst_percentage', 'ugst_percentage', 'cess_percentage'
        ];
        const gstTypeSelect = document.getElementById('gst_type');
        const finalPriceDisplay = document.getElementById('final-price-display');

        function calculateTotalPrice() {
            let basePrice = parseFloat(document.getElementById('original_price').value) || 0;
            const shippingCharge = parseFloat(document.getElementById('shipping_charge').value) || 0;
            const gstType = gstTypeSelect.value;
            let gstPercentage = 0;

            if (gstType === 'intra_state') {
                const cgst = parseFloat(document.getElementById('cgst_percentage').value) || 0;
                const sgst = parseFloat(document.getElementById('sgst_percentage').value) || 0;
                gstPercentage = cgst + sgst;
            } else if (gstType === 'inter_state') {
                gstPercentage = parseFloat(document.getElementById('igst_percentage').value) || 0;
            } else if (gstType === 'union_territory') {
                const cgst = parseFloat(document.getElementById('cgst_percentage').value) || 0;
                const ugst = parseFloat(document.getElementById('ugst_percentage').value) || 0;
                gstPercentage = cgst + ugst;
            }

            const cessPercentage = parseFloat(document.getElementById('cess_percentage').value) || 0;

            // Calculate additional price from custom options
            let customOptionsPrice = 0;
            const optionGroups = customOptionsBuilder.querySelectorAll('.option-group');
            optionGroups.forEach(group => {
                const priceInputs = group.querySelectorAll('.option-values-container input[type="number"]');
                let maxOptionPrice = 0;
                priceInputs.forEach(input => {
                    const price = parseFloat(input.value) || 0;
                    if (price > maxOptionPrice) {
                        maxOptionPrice = price;
                    }
                });
                customOptionsPrice += maxOptionPrice;
            });
            
            const subtotal = basePrice + customOptionsPrice;
            const gstAmount = subtotal * (gstPercentage / 100);
            const cessAmount = subtotal * (cessPercentage / 100);
            
            const total = subtotal + gstAmount + cessAmount + shippingCharge;
            finalPriceDisplay.textContent = `₹ ${total.toFixed(2)}`;
        }

        // Attach event listeners to all price-related fields
        priceInputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', calculateTotalPrice);
            }
        });
        gstTypeSelect.addEventListener('change', calculateTotalPrice);

        // --- Custom Options Builder Logic ---
        function createOptionValueElement(container, valueName = '', priceImpact = '0.00') {
            const valueDiv = document.createElement('div');
            valueDiv.classList.add('input-group', 'mb-2');
            valueDiv.innerHTML = `
                <input type="text" class="form-control form-control-sm" placeholder="Value (e.g., A4)" value="${valueName}" required>
                <span class="input-group-text">₹</span>
                <input type="number" class="form-control form-control-sm price-input" placeholder="Price Impact (e.g., 500)" step="0.01" min="0" value="${priceImpact}" required>
                <button type="button" class="btn btn-danger btn-sm remove-option-value-btn">✕</button>
            `;
            valueDiv.querySelector('.remove-option-value-btn').addEventListener('click', () => {
                valueDiv.remove();
                calculateTotalPrice(); // Re-calculate when an option is removed
            });
            valueDiv.querySelector('.price-input').addEventListener('input', calculateTotalPrice); // NEW: Listen for price changes
            container.appendChild(valueDiv);
        }

        function createOptionGroupElement(groupName = '', values = {}) {
            const groupId = optionGroupCount++;
            const groupDiv = document.createElement('div');
            groupDiv.classList.add('option-group', 'mb-3', 'p-3', 'border', 'rounded-3', 'bg-white');
            groupDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control me-2" placeholder="Option Group Name (e.g., Size)" value="${groupName}" required>
                    <button type="button" class="btn btn-sm btn-danger remove-option-group-btn">Remove Group</button>
                </div>
                <div class="option-values-container"></div>
                <button type="button" class="btn btn-sm btn-success add-option-value-btn mt-2"><i class="fas fa-plus me-2"></i>Add Option Value</button>
            `;

            const addOptionValueBtn = groupDiv.querySelector('.add-option-value-btn');
            const valuesContainer = groupDiv.querySelector('.option-values-container');

            addOptionValueBtn.addEventListener('click', () => {
                createOptionValueElement(valuesContainer);
            });

            groupDiv.querySelector('.remove-option-group-btn').addEventListener('click', () => {
                groupDiv.remove();
                calculateTotalPrice(); // Re-calculate when a group is removed
            });

            if (Object.keys(values).length > 0) {
                for (const [key, value] of Object.entries(values)) {
                    createOptionValueElement(valuesContainer, key, value);
                }
            } else {
                createOptionValueElement(valuesContainer);
            }

            customOptionsBuilder.insertBefore(groupDiv, addOptionGroupBtn);
        }

        addOptionGroupBtn.addEventListener('click', () => {
            createOptionGroupElement();
            calculateTotalPrice(); // Recalculate on adding a new group
        });
        
        let initialData = {};
        try {
            initialData = initialCustomOptionsData;
        } catch (e) {}

        if (Object.keys(initialData).length > 0) {
            for (const [groupName, values] of Object.entries(initialData)) {
                createOptionGroupElement(groupName, values);
            }
        }

        form.addEventListener('submit', function(event) {
            const customOptionsData = {};
            const optionGroups = customOptionsBuilder.querySelectorAll('.option-group');

            optionGroups.forEach(group => {
                const groupNameInput = group.querySelector('input[type="text"]');
                const groupName = groupNameInput.value.trim();
                
                if (groupName) {
                    const optionValues = {};
                    const valueInputs = group.querySelectorAll('.option-values-container .input-group');
                    
                    valueInputs.forEach(valueInput => {
                        const nameInput = valueInput.querySelector('input[type="text"]');
                        const priceInput = valueInput.querySelector('input[type="number"]');

                        const optionName = nameInput.value.trim();
                        const priceImpact = parseFloat(priceInput.value);

                        if (optionName && !isNaN(priceImpact)) {
                            optionValues[optionName] = priceImpact;
                        }
                    });

                    if (Object.keys(optionValues).length > 0) {
                        customOptionsData[groupName] = optionValues;
                    }
                }
            });

            customOptionsJsonInput.value = JSON.stringify(customOptionsData);
        });

        // Initial calculation on page load
        calculateTotalPrice();
    });
</script>
{% endblock %}