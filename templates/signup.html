{% extends '_base.html' %}

{% block title %}Sign Up - Karthika Futures{% endblock %}

{% block content %}
<div class="flex items-center justify-center min-h-screen pt-32">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md bg-opacity-95 border border-gray-200">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Create Your Account</h2>
        <form id="signup-form" method="POST" action="{{ url_for('signup') }}" class="space-y-5">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div>
                <label for="full_name" class="block text-gray-700 text-sm font-semibold mb-2">Full Name</label>
                <input type="text" id="full_name" name="full_name" value="{{ form_data.full_name if form_data.full_name is defined else '' }}"
                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                       placeholder="Enter your full name">
            </div>
            <div>
                <label for="email" class="block text-gray-700 text-sm font-semibold mb-2">Email Address</label>
                <input type="email" id="email" name="email" value="{{ form_data.email if form_data.email is defined else '' }}" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                       placeholder="Enter your email">
            </div>
            <div>
                <label for="phone" class="block text-gray-700 text-sm font-semibold mb-2">Phone Number (Optional)</label>
                <input type="tel" id="phone" name="phone"
                       pattern="[0-9]{10}" minlength="10" maxlength="10" title="Enter a valid 10-digit phone number"
                       value="{{ form_data.phone if form_data.phone is defined else '' }}"
                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                       placeholder="e.g., 9876543210">
            </div>

            <div class="relative">
                <label for="password" class="block text-gray-700 text-sm font-semibold mb-2">Password</label>
                <input type="password" id="password" name="password" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 pr-10"
                       placeholder="Enter your password">
                <span class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer"
                      style="top: calc(50% + 10px); transform: translateY(-50%);"
                      onclick="togglePasswordVisibility('password', this)">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-500" id="password_toggle_icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    </svg>
                </span>
            </div>
            
            <div class="relative">
                <label for="confirm_password" class="block text-gray-700 text-sm font-semibold mb-2">Confirm Password</label>
                <input type="password" id="confirm_password" name="confirm_password" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 pr-10"
                       placeholder="Confirm your password">
                <span class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer"
                      style="top: calc(50% + 10px); transform: translateY(-50%);"
                      onclick="togglePasswordVisibility('confirm_password', this)">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-500" id="confirm_password_toggle_icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    </svg>
                </span>
            </div>
            
            <div class="g-recaptcha" data-sitekey="6LeoTq4rAAAAAI6iQm9z604XN0xMAM4ASYJFOVqJ"></div>

            <div class="text-center">
                
    <button type="submit" class="btn btn-primary" id="signup-button" style="width: 100%;">
        <span class="btn-text">Sign Up</span>
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
    </button>
</div>

        </form>
        <p class="text-center text-gray-600 mt-6">
            Already have an account? <a href="{{ url_for('user_login') }}" class="text-blue-600 hover:underline font-semibold">Login here</a>
        </p>
    </div>
</div>

<style>
.btn-primary {
        background-color: #3b82f6 !important;
        border-color: #3b82f6 !important;
        color: white !important;
    }
    .spinner {
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-left-color: #fff;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const signupForm = document.getElementById('signup-form');
        const signupButton = document.getElementById('signup-button');
        const buttonText = signupButton.querySelector('.btn-text');
        const spinner = signupButton.querySelector('.spinner-border');

        // Function to show the loading state
        function showLoadingState() {
            if (buttonText) {
                buttonText.style.display = 'none';
            }
            if (spinner) {
                spinner.style.display = 'inline-block';
            }
            signupButton.disabled = true;
        }

        // Function to reset the button state
        function hideLoadingState() {
            if (buttonText) {
                buttonText.style.display = 'inline';
            }
            if (spinner) {
                spinner.style.display = 'none';
            }
            signupButton.disabled = false;
        }

        // Intercept form submission
        signupForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            showLoadingState();

            const formData = new FormData(signupForm);
            const url = signupForm.action;

            fetch(url, {
                method: signupForm.method,
                body: formData
            })
            .then(response => {
                // If there's a problem with the response, stop the spinner and show an error
                if (!response.ok) {
                    hideLoadingState();
                    // You might want to handle specific error messages here
                    return response.json().then(data => {
                        console.error('Error:', data.message);
                        alert(data.message || 'An unexpected error occurred. Please try again.');
                    }).catch(() => {
                        alert('An unexpected error occurred. Please try again.');
                    });
                }
                
                // If the response is a redirect, just follow it
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    // Otherwise, parse the JSON
                    return response.json().then(data => {
                        if (data.status === 'exists') {
                            alert(data.message);
                            const loginUrl = '{{ url_for("user_login") }}' + '?prefill_email=' + encodeURIComponent(data.email);
                            window.location.href = loginUrl;
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                hideLoadingState();
                alert('An unexpected error occurred. Please try again.');
            });
        });
    });

    // Your password visibility function remains the same
    function togglePasswordVisibility(fieldId, iconElement) {
        const passwordField = document.getElementById(fieldId);
        const iconContainer = iconElement.querySelector('svg');

        if (passwordField.type === "password") {
            passwordField.type = "text";
            iconContainer.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.981 8.877a1.012 1.012 0 0 0 0 1.246c.94 2.18 3.121 4.225 5.25 5.568.188.12.393.216.602.285.311.103.642.17.981.195.27.022.54.022.81 0a20.806 20.806 0 0 0 1.255-.389c.79-.228 1.54-.485 2.274-.757C17.653 10.428 19.467 9.07 20.158 8.43a1.01 1.01 0 0 0 0-1.246c-.94-2.18-3.121-4.225-5.25-5.568A20.806 20.806 0 0 0 12 2.5c-4.638 0-8.573 3.007-9.963 7.178Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 12a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18" />
            `;
        } else {
            passwordField.type = "password";
            iconContainer.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            `;
        }
    }
</script>
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
{% endblock %}
