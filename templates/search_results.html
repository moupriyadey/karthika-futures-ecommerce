{% extends '_base.html' %}

{% block title %}Search Results - Karthika Futures{% endblock %}

{% block content %}
<div class="container main-content-area py-5">
    <h1 class="text-center mb-4">
        Search Results {% if query %}for "{{ query }}"{% endif %}
        {% if category_filter %} in Category: "{{ category_filter }}"{% endif %}
    </h1>

    {% if artworks %}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
        {% for artwork in artworks %}
        <div class="col">
            <div class="card h-100 shadow-sm border-0 rounded-lg overflow-hidden d-flex flex-column">
                {% if artwork.images %}
                <img src="{{ url_for('static', filename=artwork.images[0]) }}" 
                     alt="{{ artwork.name }}" 
                     class="card-img-top object-fit-cover w-100" style="height: 180px;"
                     onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/placeholder.png') }}';"
                     loading="lazy">
                {% else %}
                <img src="{{ url_for('static', filename='images/placeholder.png') }}" 
                     alt="Placeholder Image" 
                     class="card-img-top object-fit-cover w-100" style="height: 180px;">
                {% endif %}

                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-truncate" title="{{ artwork.name }}">{{ artwork.name }}</h5>
                    <p class="card-text text-muted small mb-2">Category: {{ artwork.category }}</p>
                    
                    {# Description Section #}
                    <div class="card-text small text-secondary mb-3 flex-grow-1 overflow-hidden">
                        <p class="line-clamp-3">{{ artwork.description | default("No description available.") }}</p>
                    </div>

                    <div class="d-flex justify-content-between align-items-baseline mb-3 mt-auto">
                        <p class="h4 fw-bold text-primary mb-0">â‚¹{{ artwork.original_price | format("%.2f") }}</p>
                        <p class="text-muted small mb-0">Stock: {{ artwork.stock }}</p>
                    </div>

                    {# Buttons Section #}
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('product_detail', sku=artwork.sku) }}" 
                           class="btn btn-outline-info btn-sm">
                            View Details
                        </a>
                        <button class="add-to-cart-btn-listing btn btn-success btn-sm
                                     {% if artwork.stock == 0 %} disabled {% endif %}"
                                data-sku="{{ artwork.sku }}" 
                                data-name="{{ artwork.name }}" 
                                data-original-price="{{ artwork.original_price }}"
                                data-image="{{ url_for('static', filename=artwork.images[0]) if artwork.images else url_for('static', filename='images/placeholder.png') }}"
                                {% if artwork.stock == 0 %} disabled {% endif %}>
                            Add to Cart
                        </button>
                        <button class="buy-now-btn-listing btn btn-warning btn-sm
                                     {% if artwork.stock == 0 %} disabled {% endif %}"
                                data-sku="{{ artwork.sku }}" 
                                data-name="{{ artwork.name }}" 
                                data-original-price="{{ artwork.original_price }}"
                                data-image="{{ url_for('static', filename=artwork.images[0]) if artwork.images else url_for('static', filename='images/placeholder.png') }}"
                                {% if artwork.stock == 0 %} disabled {% endif %}>
                            Buy Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info text-center" role="alert">
        No artworks found matching your criteria.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Event listener for Add to Cart buttons on listing pages
        document.querySelectorAll('.add-to-cart-btn-listing').forEach(button => {
            button.addEventListener('click', async (event) => {
                const sku = event.target.dataset.sku;
                const name = event.target.dataset.name;
                const originalPrice = parseFloat(event.target.dataset.originalPrice);
                const imageUrl = event.target.dataset.image;

                // For listing pages, default options to 'Original', 'None', 'None' with 0 additional price
                const options = {
                    size: 'Original',
                    frame: 'None',
                    glass: 'None',
                    sizePrice: 0,
                    framePrice: 0,
                    glassPrice: 0
                };
                const quantity = 1; // Always add 1 from listing page

                if (typeof addToCart === 'function') {
                    await addToCart(sku, name, imageUrl, originalPrice, options, quantity);
                } else {
                    console.error("Global addToCart function not found. Cannot add to cart.");
                    showCustomAlert("Cart functionality is not available. Please contact support.", 'danger');
                }
            });
        });

        // Event listener for Buy Now buttons on listing pages
        document.querySelectorAll('.buy-now-btn-listing').forEach(button => {
            button.addEventListener('click', async (event) => {
                const sku = event.target.dataset.sku;
                const name = event.target.dataset.name;
                const originalPrice = parseFloat(event.target.dataset.originalPrice);
                const imageUrl = event.target.dataset.image;

                // For listing pages, default options to 'Original', 'None', 'None' with 0 additional price
                const selectedSize = 'Original';
                const selectedFrame = 'None';
                const selectedGlass = 'None';
                const quantity = 1; // Always buy 1 from listing page

                // Construct a temporary cart object for direct purchase
                const itemId = `${sku}-${selectedSize}-${selectedFrame}-${selectedGlass}`;
                const buyNowCart = {};
                buyNowCart[itemId] = {
                    id: itemId,
                    sku: sku,
                    name: name,
                    image: imageUrl, 
                    unit_price: originalPrice, // This will be recalculated on server for options/GST
                    unit_price_before_gst: originalPrice, 
                    quantity: quantity,
                    size: selectedSize,
                    frame: selectedFrame,
                    glass: selectedGlass,
                    gst_percentage: 0, // Placeholder, actual GST from server
                    gst_amount: 0, // Placeholder, actual GST from server
                    total_price_before_gst: originalPrice * quantity, 
                    total_price: originalPrice * quantity // Placeholder, actual total from server
                };

                // Send this temporary cart to the server
                try {
                    const response = await fetch('{{ url_for("create_direct_order") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.csrfToken // Include CSRF token
                        },
                        body: JSON.stringify({ cart: buyNowCart })
                    });
                    const data = await response.json();
                    if (data.success) {
                        showCustomAlert(data.message, 'success');
                        window.location.href = data.redirect_url; // Redirect to my_orders
                    } else {
                        showCustomAlert(`Failed to place order: ${data.message}`, 'danger');
                        console.error("ERROR: Failed to create direct order:", data.message);
                    }
                } catch (error) {
                    console.error("ERROR: Network error placing direct order:", error);
                    showCustomAlert("Network error. Please check your connection or try again later.", 'danger');
                }
            });
        });
    });
</script>
{% endblock %}
