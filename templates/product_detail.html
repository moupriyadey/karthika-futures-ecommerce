{% extends '_base.html' %}

{% block title %}{{ artwork.name }} - Karthika Futures{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-8 main-content-area">
    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Product Image Gallery -->
        <div class="lg:w-1/2">
            <div class="relative mb-4">
                <img id="mainProductImage" src="{{ url_for('static', filename=artwork.get_images_list()[0] if artwork.get_images_list() else 'images/placeholder.png') }}" 
                     alt="{{ artwork.name }}" 
                     class="w-full h-auto rounded-lg shadow-lg object-cover max-h-[600px]">
                {% if artwork.get_images_list()|length > 1 %}
                <button id="prevImage" class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white rounded-full p-2 shadow-md hover:bg-gray-100 focus:outline-none">
                    <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <button id="nextImage" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-white rounded-full p-2 shadow-md hover:bg-gray-100 focus:outline-none">
                    <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
                {% endif %}
            </div>
            <div class="flex space-x-2 overflow-x-auto pb-2">
                {% for image_url in artwork.get_images_list() %}
                <img src="{{ url_for('static', filename=image_url) }}" 
                     alt="{{ artwork.name }} thumbnail" 
                     class="w-24 h-24 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-primary transition-all duration-200 thumbnail-image"
                     data-index="{{ loop.index0 }}">
                {% endfor %}
            </div>
        </div>

        <!-- Product Details -->
        <div class="lg:w-1/2 bg-white p-6 rounded-lg shadow-md">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-4">{{ artwork.name }}</h1>
            <p class="text-xl text-gray-600 mb-6">SKU: {{ artwork.sku }}</p>
            
            <div class="flex items-baseline mb-4">
                <span class="text-4xl font-extrabold text-primary mr-2">{{ artwork.selling_price_incl_gst | currency }}</span>
                <span class="text-lg text-gray-500 line-through">{{ artwork.original_price | currency }}</span>
            </div>

            <p class="text-gray-700 leading-relaxed mb-6">{{ artwork.description }}</p>

            <!-- Custom Options -->
            {% if artwork.get_custom_options_dict() %}
            <div class="mb-6 space-y-4" id="customOptionsContainer">
                {% for group_name, options in artwork.get_custom_options_dict().items() %}
                <div>
                    <label class="block text-gray-800 text-lg font-semibold mb-2">{{ group_name }}:</label>
                    <div class="flex flex-wrap gap-3">
                        {% for option_label, price_impact in options.items() %}
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="option-{{ group_name | slugify }}" value="{{ option_label }}" 
                                   data-price-impact="{{ price_impact }}" 
                                   class="form-radio h-5 w-5 text-primary option-radio"
                                   {% if loop.first %}checked{% endif %}>
                            <span class="ml-2 text-gray-700 text-base">{{ option_label }} 
                                {% if price_impact != 0 %}
                                    ({{ price_impact | currency(signed=True) }})
                                {% endif %}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="flex items-center mb-6">
                <label for="quantity" class="text-gray-800 text-lg font-semibold mr-4">Quantity:</label>
                <input type="number" id="quantity" name="quantity" value="1" min="1" max="{{ artwork.stock }}" 
                       class="w-24 px-4 py-2 border border-gray-300 rounded-md text-center text-lg focus:outline-none focus:ring-2 focus:ring-primary">
                <span class="ml-4 text-gray-600 text-sm">({{ artwork.stock }} in stock)</span>
            </div>

            <div class="flex gap-4">
                <button id="addToCartBtn" 
                        class="flex-1 btn btn-primary py-3 text-xl rounded-md flex items-center justify-center space-x-2"
                        data-sku="{{ artwork.sku }}"
                        data-name="{{ artwork.name }}"
                        data-image-url="{{ artwork.get_images_list()[0] if artwork.get_images_list() else 'images/placeholder.png' }}"
                        data-original-price="{{ artwork.original_price }}"
                        data-cgst-percentage="{{ artwork.cgst_percentage }}"
                        data-sgst-percentage="{{ artwork.sgst_percentage }}"
                        data-igst-percentage="{{ artwork.igst_percentage }}"
                        data-ugst-percentage="{{ artwork.ugst_percentage }}"
                        >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                    <span>Add to Cart</span>
                </button>
                <button id="buyNowBtn" 
                        class="flex-1 btn btn-success py-3 text-xl rounded-md flex items-center justify-center space-x-2"
                        data-sku="{{ artwork.sku }}"
                        data-name="{{ artwork.name }}"
                        data-image-url="{{ artwork.get_images_list()[0] if artwork.get_images_list() else 'images/placeholder.png' }}"
                        data-original-price="{{ artwork.original_price }}"
                        data-cgst-percentage="{{ artwork.cgst_percentage }}"
                        data-sgst-percentage="{{ artwork.sgst_percentage }}"
                        data-igst-percentage="{{ artwork.igst_percentage }}"
                        data-ugst-percentage="{{ artwork.ugst_percentage }}"
                        >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.001 12.001 0 002.92 12c0 3.072 1.47 5.862 3.813 7.747A12.004 12.004 0 0012 21c3.072 0 5.862-1.47 7.747-3.813A12.002 12.002 0 0021.08 12c0-3.072-1.47-5.862-3.813-7.747z"></path></svg>
                    <span>Buy Now</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mainProductImage = document.getElementById('mainProductImage');
        const thumbnailImages = document.querySelectorAll('.thumbnail-image');
        const prevImageBtn = document.getElementById('prevImage');
        const nextImageBtn = document.getElementById('nextImage');
        let currentImageIndex = 0;
        const imageUrls = Array.from(thumbnailImages).map(img => img.src);

        function updateMainImage(index) {
            if (mainProductImage) {
                mainProductImage.src = imageUrls[index];
                currentImageIndex = index;
                // Update active thumbnail border
                thumbnailImages.forEach((img, idx) => {
                    if (idx === index) {
                        img.classList.add('border-primary');
                        img.classList.remove('border-transparent');
                    } else {
                        img.classList.remove('border-primary');
                        img.classList.add('border-transparent');
                    }
                });
            }
        }

        thumbnailImages.forEach(img => {
            img.addEventListener('click', function() {
                updateMainImage(parseInt(this.dataset.index));
            });
        });

        if (prevImageBtn) {
            prevImageBtn.addEventListener('click', function() {
                let newIndex = currentImageIndex - 1;
                if (newIndex < 0) {
                    newIndex = imageUrls.length - 1;
                }
                updateMainImage(newIndex);
            });
        }

        if (nextImageBtn) {
            nextImageBtn.addEventListener('click', function() {
                let newIndex = currentImageIndex + 1;
                if (newIndex >= imageUrls.length) {
                    newIndex = 0;
                }
                updateMainImage(newIndex);
            });
        }

        // Initialize first image as active
        if (thumbnailImages.length > 0) {
            updateMainImage(0);
        }


        // Custom Options and Price Calculation
        const quantityInput = document.getElementById('quantity');
        const addToCartBtn = document.getElementById('addToCartBtn');
        const buyNowBtn = document.getElementById('buyNowBtn');
        const optionRadios = document.querySelectorAll('.option-radio');

        // Function to get selected options
        function getSelectedOptions() {
            const selectedOptions = {};
            document.querySelectorAll('#customOptionsContainer input[type="radio"]:checked').forEach(radio => {
                const groupName = radio.name.replace('option-', '');
                selectedOptions[groupName] = radio.value;
            });
            return selectedOptions;
        }

        // Function to calculate unit price before GST based on selected options
        function calculateUnitPriceBeforeGst() {
            let basePrice = parseFloat(addToCartBtn.dataset.originalPrice);
            const selectedOptions = getSelectedOptions();

            optionRadios.forEach(radio => {
                if (radio.checked) {
                    const priceImpact = parseFloat(radio.dataset.priceImpact);
                    basePrice += priceImpact;
                }
            });
            return basePrice;
        }

        // Function to update the "data-unit-price-before-gst" on buttons
        function updateButtonPrices() {
            const unitPriceBeforeGst = calculateUnitPriceBeforeGst();
            addToCartBtn.dataset.unitPriceBeforeGst = unitPriceBeforeGst.toFixed(2);
            buyNowBtn.dataset.unitPriceBeforeGst = unitPriceBeforeGst.toFixed(2);
        }

        // Add event listeners for option changes
        optionRadios.forEach(radio => {
            radio.addEventListener('change', updateButtonPrices);
        });

        // Initial price calculation on load
        updateButtonPrices();


        // Add to Cart functionality
        addToCartBtn.addEventListener('click', async function() {
            const sku = this.dataset.sku;
            const name = this.dataset.name;
            const imageUrl = this.dataset.imageUrl;
            const quantity = parseInt(quantityInput.value);
            const unitPriceBeforeGst = parseFloat(this.dataset.unitPriceBeforeGst);
            const cgstPercentage = parseFloat(this.dataset.cgstPercentage);
            const sgstPercentage = parseFloat(this.dataset.sgstPercentage);
            const igstPercentage = parseFloat(this.dataset.igstPercentage);
            const ugstPercentage = parseFloat(this.dataset.ugstPercentage);
            const selectedOptions = getSelectedOptions();

            if (quantity <= 0 || quantity > parseInt(quantityInput.max)) {
                showCustomAlert(`Please enter a valid quantity between 1 and ${quantityInput.max}.`, 'danger');
                return;
            }

            try {
                const response = await fetch('/add-to-cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrfToken // Use the global CSRF token
                    },
                    body: JSON.stringify({ 
                        sku: sku, 
                        quantity: quantity, 
                        options: selectedOptions,
                        unitPriceBeforeGst: unitPriceBeforeGst, // Pass calculated price
                        cgstPercentage: cgstPercentage,
                        sgstPercentage: sgstPercentage,
                        igstPercentage: igstPercentage,
                        ugstPercentage: ugstPercentage
                    })
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    showCustomAlert(data.message, 'success');
                    // Update cart count in navbar
                    const cartCountElement = document.getElementById('cart-total-quantity');
                    if (cartCountElement) {
                        cartCountElement.textContent = data.cart_count;
                        cartCountElement.style.display = data.cart_count > 0 ? 'inline-block' : 'none';
                    }
                } else {
                    showCustomAlert(data.message || 'Failed to add item to cart.', 'danger');
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                showCustomAlert('An error occurred. Please try again.', 'danger');
            }
        });

        // Buy Now functionality
        buyNowBtn.addEventListener('click', async function() {
            const sku = this.dataset.sku;
            const name = this.dataset.name;
            const imageUrl = this.dataset.imageUrl;
            const quantity = parseInt(quantityInput.value);
            const unitPriceBeforeGst = parseFloat(this.dataset.unitPriceBeforeGst);
            const cgstPercentage = parseFloat(this.dataset.cgstPercentage);
            const sgstPercentage = parseFloat(this.dataset.sgstPercentage);
            const igstPercentage = parseFloat(this.dataset.igstPercentage);
            const ugstPercentage = parseFloat(this.dataset.ugstPercentage);
            const selectedOptions = getSelectedOptions();

            if (quantity <= 0 || quantity > parseInt(quantityInput.max)) {
                showCustomAlert(`Please enter a valid quantity between 1 and ${quantityInput.max}.`, 'danger');
                return;
            }

            const itemToBuyNow = {
                sku: sku,
                name: name,
                imageUrl: imageUrl,
                quantity: quantity,
                unitPriceBeforeGst: unitPriceBeforeGst, // Pass calculated price
                cgstPercentage: cgstPercentage,
                sgstPercentage: sgstPercentage,
                igstPercentage: igstPercentage,
                ugstPercentage: ugstPercentage,
                selectedOptions: selectedOptions
            };

            try {
                const response = await fetch('/create_direct_order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrfToken // Use the global CSRF token
                    },
                    body: JSON.stringify(itemToBuyNow)
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    showCustomAlert(data.message, 'info');
                    window.location.href = data.redirect_url; // Redirect to login or purchase form
                } else {
                    showCustomAlert(data.message || 'Failed to initiate direct purchase.', 'danger');
                }
            } catch (error) {
                console.error('Error initiating direct purchase:', error);
                showCustomAlert('An error occurred. Please try again.', 'danger');
            }
        });
    });
</script>
{% endblock %}
