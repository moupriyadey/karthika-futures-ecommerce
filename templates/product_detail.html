{% extends '_base.html' %}

{% block title %}{{ artwork.name }} - Karthika Futures{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-8 main-content-area">
    <div class="bg-white rounded-lg shadow-md overflow-hidden flex flex-col lg:flex-row">
        <!-- Image Gallery -->
        <div class="lg:w-1/2 p-4 flex flex-col items-center">
            <div class="w-full max-w-md mb-4">
                {% set images = artwork.get_images_list() %}
                {% if images %}
                    <img id="mainArtworkImage" src="{{ url_for('static', filename=images[0]) }}" alt="{{ artwork.name }}" class="w-full h-auto rounded-lg shadow-lg object-contain max-h-96">
                {% else %}
                    <img id="mainArtworkImage" src="{{ url_for('static', filename='images/placeholder.png') }}" alt="Placeholder" class="w-full h-auto rounded-lg shadow-lg object-contain max-h-96">
                {% endif %}
            </div>
            {% if images|length > 1 %}
            <div class="flex space-x-2 overflow-x-auto pb-2">
                {% for image_path in images %}
                <img src="{{ url_for('static', filename=image_path) }}" 
                     alt="{{ artwork.name }} thumbnail" 
                     class="w-20 h-20 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-primary transition-all duration-200"
                     onclick="document.getElementById('mainArtworkImage').src = this.src;">
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Product Details -->
        <div class="lg:w-1/2 p-6 lg:p-8">
            <h1 class="text-3xl lg:text-4xl font-extrabold text-gray-800 mb-3">{{ artwork.name }}</h1>
            {# Removed Category Name/ID and GST Type & GST Rate as per user request #}

            <div class="flex items-baseline mb-4">
                <span id="currentCalculatedPrice" class="text-4xl font-bold text-primary mr-3">{{ artwork.selling_price_incl_gst | currency }}</span>
                {% if artwork.selling_price_incl_gst != artwork.original_price %}
                    <span class="text-xl text-gray-500 line-through">{{ artwork.original_price | currency }}</span>
                {% endif %}
            </div>

            <p class="text-gray-700 mb-6 leading-relaxed">{{ artwork.description }}</p>

            <div class="mb-6">
                <p class="text-gray-700 font-semibold mb-2">Availability: 
                    {% if artwork.stock > 0 %}
                        <span class="text-green-600">In Stock ({{ artwork.stock }} units)</span>
                    {% else %}
                        <span class="text-red-600">Out of Stock</span>
                    {% endif %}
                </p>
                <p class="text-gray-700 font-semibold mb-2">Shipping: 
                    {% if artwork.shipping_charge == 0 %}
                        <span class="text-green-600">Free Delivery</span>
                    {% else %}
                        {{ artwork.shipping_charge | currency }}
                    {% endif %}
                </p>
            </div>

            <!-- Custom Options -->
            <div id="custom-options-container" class="mb-6 space-y-4">
                {% for group_name, options in artwork.get_custom_options_dict().items() %}
                <div>
                    <label for="option-{{ loop.index }}" class="block text-gray-700 font-bold mb-2">{{ group_name }}:</label>
                    <select id="option-{{ loop.index }}" class="form-select w-full modal-option-select" data-group-name="{{ group_name }}">
                        <option value="default" disabled selected>Select {{ group_name }}</option>
                        {% for label, price in options.items() %}
                        <option value="{{ label }}|{{ price }}">{{ label }} (+{{ price | currency }})</option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}
            </div>

            <!-- Quantity & Buttons -->
            <div class="flex items-center mb-6 space-x-4">
                <label for="quantity" class="text-gray-700 font-bold">Quantity:</label>
                <input type="number" id="quantity" value="1" min="1" max="{{ artwork.stock }}" 
                       class="form-control w-24 text-center">
            </div>

            <div class="flex flex-col sm:flex-row gap-4">
                <button id="addToCartBtn" 
                        class="btn btn-primary flex-1 py-3 text-lg rounded-md {% if artwork.stock == 0 %}opacity-50 cursor-not-allowed{% endif %}"
                        {% if artwork.stock == 0 %}disabled{% endif %}>
                    <i class="fas fa-shopping-cart mr-2"></i> Add to Cart
                </button>
                <button id="buyNowBtn" 
                        class="btn btn-secondary flex-1 py-3 text-lg rounded-md {% if artwork.stock == 0 %}opacity-50 cursor-not-allowed{% endif %}"
                        {% if artwork.stock == 0 %}disabled{% endif %}>
                    <i class="fas fa-money-bill-wave mr-2"></i> Buy Now
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Use setInterval to repeatedly check if global functions are available
        const checkGlobals = setInterval(() => {
            if (typeof window.addToCart === 'function' && typeof window.buyNow === 'function' && typeof window.showCustomAlert === 'function') {
                clearInterval(checkGlobals); // Stop checking once functions are found
                console.log("product_detail.html: Global functions (addToCart, buyNow, showCustomAlert) are available.");

                // Pass artwork data to JavaScript
                const artworkData = {{ artwork_data | tojson | safe }};
                console.log("product_detail.html: Artwork Data:", artworkData); // Debugging: Check the data passed from Flask

                const quantityInput = document.getElementById('quantity');
                const addToCartBtn = document.getElementById('addToCartBtn');
                const buyNowBtn = document.getElementById('buyNowBtn');
                const customOptionSelects = document.querySelectorAll('.modal-option-select');
                const currentCalculatedPriceSpan = document.getElementById('currentCalculatedPrice'); // New span for price display

                function updateButtonStates() {
                    console.log("product_detail.html: updateButtonStates called.");
                    const currentStock = artworkData.stock;
                    const quantity = parseInt(quantityInput.value);

                    if (currentStock === 0 || quantity > currentStock) {
                        addToCartBtn.disabled = true;
                        buyNowBtn.disabled = true;
                        addToCartBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        buyNowBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        addToCartBtn.disabled = false;
                        buyNowBtn.disabled = false;
                        addToCartBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        buyNowBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                    updateDisplayedPrice(); // Call price update whenever buttons state changes
                }

                function getSelectedOptions() {
                    console.log("product_detail.html: getSelectedOptions called.");
                    const selectedOptions = {};
                    customOptionSelects.forEach(selectElement => {
                        const groupName = selectElement.dataset.groupName;
                        const selectedValue = selectElement.value;
                        if (selectedValue && selectedValue !== 'default') {
                            const parts = selectedValue.split('|');
                            const optionLabel = parts[0];
                            selectedOptions[groupName] = optionLabel;
                        }
                    });
                    console.log("product_detail.html: Selected Options:", selectedOptions); // Debugging
                    return selectedOptions;
                }

                function calculateCurrentPriceAndGST() {
                    console.log("product_detail.html: calculateCurrentPriceAndGST called.");
                    let currentBasePrice = artworkData.original_price;
                    const selectedOptions = getSelectedOptions();
                    
                    for (const groupName in selectedOptions) {
                        if (artworkData.custom_options && artworkData.custom_options.hasOwnProperty(groupName)) {
                            const optionLabel = selectedOptions[groupName];
                            if (artworkData.custom_options[groupName].hasOwnProperty(optionLabel)) {
                                currentBasePrice += artworkData.custom_options[groupName][optionLabel];
                            }
                        }
                    }
                    console.log("product_detail.html: Base Price (with options):", currentBasePrice); // Debugging

                    const quantity = parseInt(quantityInput.value);
                    console.log("product_detail.html: Current Quantity:", quantity); // Debugging
                    const totalBeforeGst = currentBasePrice * quantity;
                    console.log("product_detail.html: Total Before GST (for quantity):", totalBeforeGst); // Debugging

                    // Determine the correct GST percentages based on gst_type
                    let cgst = 0, sgst = 0, igst = 0, ugst = 0;
                    if (artworkData.gst_type === 'intra_state') {
                        cgst = artworkData.cgst_percentage;
                        sgst = artworkData.sgst_percentage;
                    } else if (artworkData.gst_type === 'inter_state') {
                        igst = artworkData.igst_percentage;
                    } else if (artworkData.gst_type === 'union_territory') {
                        cgst = artworkData.cgst_percentage;
                        ugst = artworkData.ugst_percentage;
                    }
                    console.log(`product_detail.html: GST: CGST=${cgst}%, SGST=${sgst}%, IGST=${igst}%, UGST=${ugst}%`); // Debugging

                    const cgstAmount = (totalBeforeGst * cgst) / 100;
                    const sgstAmount = (totalBeforeGst * sgst) / 100;
                    const igstAmount = (totalBeforeGst * igst) / 100;
                    const ugstAmount = (totalBeforeGst * ugst) / 100;

                    const totalGstAmount = cgstAmount + sgstAmount + igstAmount + ugstAmount;
                    console.log("product_detail.html: Total GST Amount:", totalGstAmount); // Debugging

                    let finalPrice = totalBeforeGst + totalGstAmount;
                    
                    // Add shipping charge
                    finalPrice += artworkData.shipping_charge;
                    console.log("product_detail.html: Final Price (with shipping):", finalPrice); // Debugging

                    return {
                        unitPriceBeforeGst: currentBasePrice, // This is the unit price including options, before GST
                        cgstPercentage: cgst,
                        sgstPercentage: sgst,
                        igstPercentage: igst,
                        ugstPercentage: ugst,
                        totalPriceInclGst: finalPrice, // This is the final price for the current quantity and options
                        shippingCharge: artworkData.shipping_charge
                    };
                }

                function updateDisplayedPrice() {
                    console.log("product_detail.html: updateDisplayedPrice called.");
                    const { totalPriceInclGst } = calculateCurrentPriceAndGST();
                    currentCalculatedPriceSpan.textContent = `â‚¹${totalPriceInclGst.toFixed(2)}`;
                    console.log("product_detail.html: Displayed Price Updated to:", currentCalculatedPriceSpan.textContent); // Debugging
                }

                // Event listeners
                quantityInput.addEventListener('input', updateButtonStates);
                customOptionSelects.forEach(select => {
                    select.addEventListener('change', updateButtonStates);
                });

                addToCartBtn.addEventListener('click', function() {
                    console.log("product_detail.html: Add to Cart button clicked.");
                    const quantity = parseInt(quantityInput.value);
                    const selectedOptions = getSelectedOptions();
                    const { unitPriceBeforeGst, cgstPercentage, sgstPercentage, igstPercentage, ugstPercentage } = calculateCurrentPriceAndGST();

                    if (quantity > 0 && artworkData.stock >= quantity) {
                        window.addToCart(
                            artworkData.sku, 
                            artworkData.name, 
                            artworkData.image_url, 
                            unitPriceBeforeGst, // Pass unit price including options, before GST
                            cgstPercentage,
                            sgstPercentage,
                            igstPercentage,
                            ugstPercentage,
                            quantity, 
                            selectedOptions
                        );
                    } else {
                        window.showCustomAlert('Please enter a valid quantity or check stock.', 'danger');
                    }
                });

                buyNowBtn.addEventListener('click', function() {
                    console.log("product_detail.html: Buy Now button clicked.");
                    const quantity = parseInt(quantityInput.value);
                    const selectedOptions = getSelectedOptions();
                    const { unitPriceBeforeGst, cgstPercentage, sgstPercentage, igstPercentage, ugstPercentage, shippingCharge } = calculateCurrentPriceAndGST();

                    if (quantity > 0 && artworkData.stock >= quantity) {
                        window.buyNow(
                            artworkData.sku, 
                            artworkData.name, 
                            artworkData.image_url, 
                            selectedOptions, 
                            quantity, 
                            unitPriceBeforeGst, // Pass unit price including options, before GST
                            cgstPercentage,
                            sgstPercentage,
                            igstPercentage,
                            ugstPercentage,
                            shippingCharge
                        );
                    } else {
                        window.showCustomAlert('Please enter a valid quantity or check stock for direct purchase.', 'danger');
                    }
                });

                // Initial state update and price display
                updateButtonStates();
                updateDisplayedPrice(); // Ensure price is displayed correctly on load
            } else {
                console.log("product_detail.html: Waiting for global functions to be available...");
            }
        }, 100); // Check every 100ms
    });
</script>
{% endblock %}
