{% extends '_base.html' %}

{% block title %}{{ artwork.name }} - Karthika Futures{% endblock %}

{% block content %}
<main class="pt-24">
  <div class="container mx-auto p-4 md:p-8">
    <div class="bg-white rounded-lg shadow-xl overflow-hidden flex flex-col lg:flex-row gap-6">

      <!-- Gallery -->
      <div class="w-full lg:w-2/3 flex flex-row">
        <div class="artwork-gallery-container w-full h-full">

          <!-- Thumbnails Desktop -->
          <div class="artwork-thumbnails hidden lg:flex flex-col space-y-2 p-2 sticky top-24 max-h-[70vh] overflow-y-auto">
            {% for image in artwork.get_images_list() %}
            <img src="{{ image }}" 
                 alt="Thumbnail {{ loop.index }}" 
                 class="w-20 h-20 object-cover rounded-lg cursor-pointer border-2 border-transparent hover:border-gradient-to-r from-purple-500 to-pink-500 transition duration-300"
                 onclick="updateSwiperSlide({{ loop.index0 }})">
            {% endfor %}
            {% if not artwork.get_images_list() %}
            <img src="{{ url_for('static', filename='images/placeholder.png') }}" 
                 alt="Thumbnail"
                 class="w-20 h-20 object-cover rounded-lg border-2 border-gradient-to-r from-purple-500 to-pink-500 cursor-default">
            {% endif %}
          </div>

          <!-- Main Swiper -->
          <div class="swiper mySwiper w-full h-full max-h-[70vh]">
            <div class="swiper-wrapper">
              {% for image in artwork.get_images_list() %}
              <div class="swiper-slide flex items-center justify-center">
                <img src="{{ image }}" 
                     alt="{{ artwork.name }}" 
                     class="object-contain w-full h-auto max-h-[70vh] cursor-zoom-in"
                     onclick="openFullImage(this.src)">
              </div>
              {% endfor %}
              {% if not artwork.get_images_list() %}
              <div class="swiper-slide flex items-center justify-center">
                <img src="{{ url_for('static', filename='images/placeholder.png') }}" 
                     alt="{{ artwork.name }}" 
                     class="object-contain w-full h-auto max-h-[70vh] cursor-zoom-in"
                     onclick="openFullImage(this.src)">
              </div>
              {% endif %}
            </div>
            <div class="swiper-pagination lg:hidden"></div>
            <div class="swiper-button-next hidden sm:flex"></div>
            <div class="swiper-button-prev hidden sm:flex"></div>
          </div>

          <!-- Thumbnails Mobile -->
          <div class="artwork-thumbnails-mobile flex lg:hidden flex-row space-x-2 mt-2 overflow-x-auto">
            {% for image in artwork.get_images_list() %}
            <img src="{{ image }}" 
                 alt="Thumbnail {{ loop.index }}" 
                 class="w-16 h-16 object-cover rounded-lg cursor-pointer border-2 border-transparent hover:border-gradient-to-r from-purple-500 to-pink-500 transition duration-300"
                 onclick="updateSwiperSlide({{ loop.index0 }})">
            {% endfor %}
            {% if not artwork.get_images_list() %}
            <img src="{{ url_for('static', filename='images/placeholder.png') }}" 
                 alt="Thumbnail"
                 class="w-16 h-16 object-cover rounded-lg border-2 border-gradient-to-r from-purple-500 to-pink-500 cursor-default">
            {% endif %}
          </div>

        </div>
      </div>

      <!-- Artwork Details & Buttons -->
      <div class="w-full lg:w-1/3 flex flex-col justify-start p-4 lg:p-6 space-y-4">

        <div>
          <h1 class="text-3xl font-extrabold text-gray-900 mb-1">{{ artwork.name }}</h1>
          <p class="text-sm text-gray-600 mb-1">SKU: {{ artwork.sku }}</p>
          {% if artwork.stock == 0 %}
            <span class="inline-block bg-red-100 text-red-700 font-semibold px-3 py-1 rounded-full mb-2">Out of Stock</span>
          {% else %}
            <span class="inline-block bg-green-100 text-green-700 font-semibold px-3 py-1 rounded-full mb-2">Available</span>
          {% endif %}

          <div class="flex items-baseline mb-2">
            <span class="text-3xl font-bold text-primary-dark mr-2" id="displayPrice">{{ artwork.selling_price_incl_gst | currency }}</span>
          </div>

          <p class="text-gray-700 mb-3 leading-relaxed">{{ artwork.description }}</p>

          <!-- Custom Options -->
          <div id="customOptionsContainer" class="mb-3 space-y-3">
            {% for group_name, options_dict in artwork.get_custom_options_dict().items() %}
            <div>
              <label for="{{ group_name | slugify }}" class="block text-gray-700 font-semibold mb-1">{{ group_name }}:</label>
              <select id="{{ group_name | slugify }}" 
                      name="option_{{ group_name | slugify }}" 
                      class="form-select w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50"
                      data-option-group="{{ group_name }}">
                <option value="default" data-price-impact="0">Select {{ group_name }}...</option>
                {% for option_name, price_impact in options_dict.items() %}
                <option value="{{ option_name }}" data-price-impact="{{ price_impact }}">
                    {{ option_name }} ({% if price_impact >= 0 %}+{% endif %}{{ price_impact | currency }})
                </option>
                {% endfor %}
              </select>
            </div>
            {% endfor %}
          </div>

          <!-- Quantity -->
          <div class="flex items-center mb-3">
            <label for="quantity" class="text-gray-700 font-semibold mr-3">Quantity:</label>
            <input type="number" id="quantity" name="quantity" value="{% if artwork.stock > 0 %}1{% else %}0{% endif %}"
                    min="1" max="{{ artwork.stock }}"
                    class="form-input w-20 text-center rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50"
                    {% if artwork.stock == 0 %}disabled{% endif %}>
            <span class="text-sm ml-3 {% if artwork.stock > 0 %}text-gray-500{% else %}text-red-600 font-semibold{% endif %}">({{ artwork.stock }} in stock)</span>
          </div>

          <!-- Delivery Date -->
          <div class="mb-3">
            <label for="pinInputProduct" class="font-semibold">Check Delivery Date:</label>
            <div class="flex items-center gap-2 mt-1">
              <input type="text" id="pinInputProduct" maxlength="6" placeholder="Enter Pincode" class="form-input w-40 px-2 py-1 border rounded">
              <button type="button" onclick="checkEDD('pinInputProduct', 'eddProduct')" 
                      class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition duration-300">
                      Check
              </button>
            </div>
            <p id="eddProduct" class="mt-1 text-sm"></p>
          </div>
        </div>

        <!-- Buttons -->
        <div class="flex flex-col lg:flex-col space-y-2 lg:space-y-3">
          {% if artwork.stock > 0 %}
          ------------------
          <button type="button" id="addToCartBtn" 
    class="w-full py-3 text-lg font-semibold rounded-xl shadow-lg
           bg-gradient-to-r from-purple-500 to-pink-500 text-white
           hover:from-purple-600 hover:to-pink-600 transition-all duration-300 ease-in-out">
    <span class="btn-text"><i class="fas fa-shopping-cart mr-2"></i> Add to Cart</span>
    <span class="spinner hidden"></span>
</button>

<button type="button" id="buyNowBtn"
    class="w-full py-3 text-lg font-semibold rounded-xl shadow-lg
           bg-gradient-to-r from-green-400 to-green-600 text-white
           hover:from-green-500 hover:to-green-700 transition-all duration-300 ease-in-out">
    <span class="btn-text"><i class="fas fa-money-bill-wave mr-2"></i> Buy Now</span>
    <span class="spinner hidden"></span>
</button>


          <button type="button" onclick="history.back()"
                  class="w-full py-3 text-lg font-semibold rounded-xl shadow-lg
                         bg-gray-300 text-gray-800 hover:bg-gray-400 transition-all duration-300 ease-in-out">
                    Back
          </button>
          {% else %}
          <button class="w-full py-3 text-lg font-semibold rounded-xl shadow-lg
                         bg-gray-300 text-gray-400 opacity-50 cursor-not-allowed" disabled>
              <i class="fas fa-ban mr-2"></i> Out of Stock
          </button>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<!-- Full Image Modal -->
<div id="fullImageModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden justify-center items-center">
  <button onclick="closeFullImage()"
            class="absolute top-4 right-4 z-50 bg-white text-black rounded-full p-2 font-bold shadow-lg hover:bg-gray-200 transition-all duration-200">âœ•</button>

  <div class="relative max-w-[90vw] max-h-[90vh] bg-white rounded-lg flex items-center justify-center">
    <img id="fullImagePreview"
          class="max-w-full max-h-full object-contain rounded-lg"
          src="" alt="">
    <div class="absolute inset-0 pointer-events-none watermark-grid rounded-lg"></div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

<style>
<style>
/* ... your existing styles ... */

.spinner {
    display: none;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.5);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: auto;
}

.loading .btn-text {
    display: none;
}
.loading .spinner {
    display: inline-block;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

  .watermark-grid {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Ctext x='0' y='20' font-size='20' fill='rgba(255,255,255,0.2)' font-family='Arial'%3EKarthikafutures%3C/text%3E%3C/svg%3E");
    background-size: 140px 140px;
    background-repeat: repeat;
    opacity: 1;
  }

  /* Main artwork image optimization for desktop */
.swiper-slide img {
    max-width: 100%;       /* Full width of container, but not more */
    max-height: 60vh;      /* Limit vertical height for professional look */
    object-fit: contain;   /* Maintain aspect ratio */
}

.flex-col.sm\:flex-row.space-y-3.sm\:space-y-0.sm\:space-x-4.mb-6 {
    margin-top: 0.5rem;   /* Reduce top gap */
}


/* Optional: container width */
.artwork-gallery-container > .swiper {
    width: 100%;           /* Fill available space */
    max-width: 600px;      /* Limit main image width on large screens */
    margin: auto;
}

  .swiper-pagination-bullet-active {
    background: #9333ea !important;
  }
  .artwork-gallery-container {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 1rem;
      align-items: start;
  }
  @media (max-width: 1023px) {
    .artwork-gallery-container {
        display: block;
    }
    .artwork-thumbnails-mobile {
      display: flex;
      flex-direction: row;
      overflow-x: auto;
      gap: 0.5rem;
      padding-bottom: 0.5rem;
    }
    .artwork-thumbnails-mobile img {
      width: 60px;
      height: 60px;
      flex-shrink: 0;
    }
  }
</style>

<script>
  function openFullImage(src) {
    document.getElementById('fullImagePreview').src = src;
    document.getElementById('fullImageModal').classList.remove('hidden');
    document.getElementById('fullImageModal').classList.add('flex');
  }
  function closeFullImage() {
    document.getElementById('fullImageModal').classList.remove('flex');
    document.getElementById('fullImageModal').classList.add('hidden');
    document.getElementById('fullImagePreview').src = '';
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script>
let swiper;

// This event runs when the page is first loaded AND when navigating back.
// We use it to reset the button states.
window.addEventListener('pageshow', function (event) {
    const addToCartBtn = document.getElementById('addToCartBtn');
    const buyNowBtn = document.getElementById('buyNowBtn');

    if (addToCartBtn) {
        addToCartBtn.classList.remove('loading');
        addToCartBtn.disabled = false;
    }
    if (buyNowBtn) {
        buyNowBtn.classList.remove('loading');
        buyNowBtn.disabled = false;
    }
});

document.addEventListener('DOMContentLoaded', function() {
    swiper = new Swiper(".mySwiper", {
      loop: true,
      pagination: {
        el: ".swiper-pagination",
        clickable: true,
      },
      navigation: {
        nextEl: ".swiper-button-next",
        prevEl: ".swiper-button-prev",
      },
    });

    const artworkData = {{ artwork_data | tojson }};
    const quantityInput = document.getElementById('quantity');
    const customOptionsContainer = document.getElementById('customOptionsContainer');
    const displayPriceElement = document.getElementById('displayPrice');
    const addToCartBtn = document.getElementById('addToCartBtn');
    const buyNowBtn = document.getElementById('buyNowBtn');

    const currencyFormatter = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' });

    function updatePrice() {
        let currentPrice = artworkData.original_price;
        const selectedOptions = {};
        const quantity = parseInt(quantityInput.value);

        customOptionsContainer.querySelectorAll('select[data-option-group]').forEach(select => {
            const selectedOption = select.options[select.selectedIndex];
            const groupName = select.dataset.optionGroup;
            if (selectedOption.value !== "default") {
                const priceImpact = parseFloat(selectedOption.dataset.priceImpact);
                if (!isNaN(priceImpact)) {
                    currentPrice += priceImpact;
                    selectedOptions[groupName] = selectedOption.value;
                }
            }
        });

        let totalGstRate = 0;
        if (artworkData.gst_type === 'intra_state') {
            totalGstRate = artworkData.cgst_percentage + artworkData.sgst_percentage;
        } else if (artworkData.gst_type === 'inter_state') {
            totalGstRate = artworkData.igst_percentage;
        } else if (artworkData.gst_type === 'union_territory') {
            totalGstRate = artworkData.cgst_percentage + artworkData.ugst_percentage;
        }
        totalGstRate += artworkData.cess_percentage;

        const totalPriceBeforeGst = currentPrice * quantity;
        const gstAmount = (totalPriceBeforeGst * totalGstRate) / 100;
        let finalPrice = totalPriceBeforeGst + gstAmount + (artworkData.shipping_charge * quantity);

        displayPriceElement.textContent = currencyFormatter.format(finalPrice);

        artworkData.current_unit_price_before_gst = currentPrice;
        artworkData.selected_options = selectedOptions;
    }

    quantityInput.addEventListener('change', updatePrice);
    quantityInput.addEventListener('input', updatePrice);
    customOptionsContainer.querySelectorAll('select[data-option-group]').forEach(select => select.addEventListener('change', updatePrice));
    updatePrice();

    addToCartBtn.addEventListener('click', function() {
        this.classList.add('loading');
        this.disabled = true;

        const quantity = parseInt(quantityInput.value);
        if (quantity < 1 || quantity > artworkData.stock) {
            this.classList.remove('loading');
            this.disabled = false;
            return window.showCustomAlert(`Please enter a quantity between 1 and ${artworkData.stock}.`, 'danger');
        }

        // Use a timeout to ensure the spinner is visible before the function call
        setTimeout(() => {
            window.addToCart(
                artworkData.sku,
                artworkData.name,
                artworkData.image_url, 
                artworkData.current_unit_price_before_gst, 
                artworkData.cgst_percentage,
                artworkData.sgst_percentage,
                artworkData.igst_percentage,
                artworkData.ugst_percentage,
                artworkData.cess_percentage, 
                quantity, 
                artworkData.selected_options
            );
        }, 0);
    });

    buyNowBtn.addEventListener('click', function() {
        this.classList.add('loading');
        this.disabled = true;

        const quantity = parseInt(quantityInput.value);
        if (quantity < 1 || quantity > artworkData.stock) {
            this.classList.remove('loading');
            this.disabled = false;
            return window.showCustomAlert(`Please enter a quantity between 1 and ${artworkData.stock}.`, 'danger');
        }

        // Use a timeout to ensure the spinner is visible before redirecting
        setTimeout(() => {
            window.buyNow(
                artworkData.sku,
                artworkData.name,
                artworkData.image_url,
                artworkData.selected_options,
                quantity,
                artworkData.current_unit_price_before_gst,
                artworkData.cgst_percentage,
                artworkData.sgst_percentage,
                artworkData.igst_percentage,
                artworkData.ugst_percentage,
                artworkData.cess_percentage, 
                artworkData.shipping_charge
            );
        }, 0);
    });
});

window.updateSwiperSlide = function(index) {
    if (swiper) {
        swiper.slideToLoop(index);
    }
};
</script>
{% endblock %}
