{% extends '_base.html' %}

{% block title %}Edit Invoice - Karthika Futures{% endblock %}

{% block content %}
<div class="container main-content-area py-4">
    <h2 class="text-center mb-4">Edit Invoice for Order: {{ order.id }}</h2>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm border-0 rounded-lg p-4">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin_edit_invoice', order_id=order.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        {% set invoice_det = order.get_invoice_details() %}

                        <h5 class="mb-3">Business Details (Seller)</h5>
                        <div class="mb-3">
                            <label for="business_name" class="form-label">Business Name</label>
                            <input type="text" class="form-control" id="business_name" name="business_name"
                                   value="{{ invoice_det.get('business_name', our_business_name) }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="gst_number" class="form-label">GST Number</label>
                            <input type="text" class="form-control" id="gst_number" name="gst_number"
                                   value="{{ invoice_det.get('gst_number', our_gstin) }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="pan_number" class="form-label">PAN Number</label>
                            <input type="text" class="form-control" id="pan_number" name="pan_number"
                                   value="{{ invoice_det.get('pan_number', our_pan) }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="business_address" class="form-label">Business Address</label>
                            <textarea class="form-control" id="business_address" name="business_address" rows="3" required>{{ invoice_det.get('business_address', our_business_address) }}</textarea>
                        </div>

                        <hr class="my-4">

                        <h5 class="mb-3">Invoice Details</h5>
                        <div class="mb-3">
                            <label for="invoice_number" class="form-label">Invoice Number</label>
                            <input type="text" class="form-control" id="invoice_number" name="invoice_number"
                                   value="{{ invoice_det.get('invoice_number', 'INV-' + order.id + '-' + now().strftime('%Y%m%d')) }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="invoice_date" class="form-label">Invoice Date</label>
                            <input type="date" class="form-control" id="invoice_date" name="invoice_date"
                                   value="{{ invoice_det.get('invoice_date', now().strftime('%Y-%m-%d')) }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="billing_address" class="form-label">Billing Address (Customer)</label>
                            <textarea class="form-control" id="billing_address" name="billing_address" rows="3" required>{{ invoice_det.get('billing_address', order.get_shipping_address().get('address_line1', '')) }}</textarea>
                        </div>

                        <hr class="my-4">

                        <h5 class="mb-3">Financial Details</h5>
                        <div class="mb-3">
                            <label for="subtotal_before_gst" class="form-label">Subtotal (Before GST)</label>
                            <input type="text" class="form-control" id="subtotal_before_gst" name="subtotal_before_gst"
                                   value="{{ order.subtotal_before_gst | floatformat(2) }}" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="gst_rate" class="form-label">GST Rate Applied (%)</label>
                            <input type="number" step="0.01" class="form-control" id="gst_rate" name="gst_rate"
                                   value="{{ invoice_det.get('gst_rate_applied', default_gst_rate) | floatformat(2) }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="shipping_charge" class="form-label">Shipping Charge (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="shipping_charge" name="shipping_charge"
                                   value="{{ invoice_det.get('shipping_charge', order.shipping_charge) | floatformat(2) }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="final_invoice_amount" class="form-label">Final Invoice Amount (₹)</label>
                            <input type="text" class="form-control" id="final_invoice_amount" name="final_invoice_amount"
                                   value="{{ invoice_det.get('final_invoice_amount', order.total_amount) | floatformat(2) }}" readonly>
                        </div>

                        <hr class="my-4">

                        <div class="mb-3">
                            <label for="invoice_status" class="form-label">Invoice Status</label>
                            <input type="text" class="form-control" id="invoice_status" name="invoice_status"
                                   value="{{ invoice_det.get('invoice_status', 'Not Applicable') }}" readonly>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="is_held_by_admin" name="is_held_by_admin"
                                   {% if invoice_det.get('is_held_by_admin') %}checked{% endif %}>
                            <label class="form-check-label" for="is_held_by_admin">Hold Invoice (Admin Review)</label>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">Save Invoice Details</button>
                            <a href="{{ url_for('admin_orders_view') }}" class="btn btn-outline-secondary btn-lg">Back to Orders</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const gstRateInput = document.getElementById('gst_rate');
        const shippingChargeInput = document.getElementById('shipping_charge');
        const subtotalBeforeGstInput = document.getElementById('subtotal_before_gst');
        const finalInvoiceAmountInput = document.getElementById('final_invoice_amount');

        function calculateFinalAmount() {
            const subtotal = parseFloat(subtotalBeforeGstInput.value) || 0;
            const gstRate = parseFloat(gstRateInput.value) || 0;
            const shippingCharge = parseFloat(shippingChargeInput.value) || 0;

            const gstAmount = subtotal * (gstRate / 100);
            const finalAmount = subtotal + gstAmount + shippingCharge;
            finalInvoiceAmountInput.value = finalAmount.toFixed(2);
        }

        gstRateInput.addEventListener('input', calculateFinalAmount);
        shippingChargeInput.addEventListener('input', calculateFinalAmount);

        // Initial calculation on page load
        calculateFinalAmount();
    });
</script>
{% endblock %}
