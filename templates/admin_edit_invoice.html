{% extends '_base.html' %}

{% block title %}Edit Invoice for Order {{ order.order_id }} - Karthika Futures{% endblock %}

{% block extra_css %}
<style>
    .invoice-edit-container {
        padding: 2rem;
        background-color: #ffffff;
        border-radius: 0.75rem;
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.1);
        margin-top: 5rem; /* Adjust from fixed navbar */
        margin-bottom: 2rem;
    }
    h2 {
        color: #333;
        margin-bottom: 1.5rem;
    }
    .form-section {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e0e0e0;
    }
    .form-section h4 {
        color: #007bff;
        margin-bottom: 1rem;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 0.5rem;
    }
    .form-control[readonly] {
        background-color: #e9ecef;
        cursor: not-allowed;
    }
    .text-muted small {
        font-size: 0.8em;
    }
    .table th, .table td {
        vertical-align: middle;
    }
    .table-sm th, .table-sm td {
        padding: 0.3rem;
    }
    .table-items td:first-child {
        width: 5%;
    }
    .table-items td:nth-child(2) {
        width: 50%;
    }
    .table-items td:nth-child(3),
    .table-items td:nth-child(4),
    .table-items td:nth-child(5) {
        width: 15%;
        text-align: right;
    }

    /* Responsive adjustments */
    @media (max-width: 767.98px) {
        .invoice-edit-container {
            padding: 1rem;
            margin-top: 4.5rem;
        }
        .form-section {
            padding: 1rem;
        }
        .form-section h4 {
            font-size: 1.25rem;
        }
        .btn-group {
            flex-direction: column;
            gap: 0.5rem;
        }
        .btn {
            width: 100%;
        }
        .table thead {
            display: none;
        }
        .table, .table tbody, .table tr, .table td {
            display: block;
            width: 100%;
        }
        .table tr {
            margin-bottom: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-start;
        }
        .table td {
            text-align: right;
            padding-left: 50%;
            position: relative;
            border: none;
        }
        .table td::before {
            content: attr(data-label);
            position: absolute;
            left: 0;
            width: 45%;
            padding-left: 0.75rem;
            font-weight: bold;
            text-align: left;
        }
        .table-items td:first-child,
        .table-items td:nth-child(2),
        .table-items td:nth-child(3),
        .table-items td:nth-child(4),
        .table-items td:nth-child(5) {
            width: 100%; /* Make all item columns full width on small screens */
            text-align: right;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container invoice-edit-container">
    <h2 class="text-center mb-4">✍️ Edit Invoice for Order #{{ order.order_id }}</h2>

    <div class="row mb-4">
        <div class="col-12 text-end">
            <a href="{{ url_for('admin_panel') }}" class="btn btn-secondary">Back to Admin Panel</a>
        </div>
    </div>

    <form method="POST">
        <div class="form-section">
            <h4>Business Details (Sold By)</h4>
            <div class="mb-3">
                <label for="business_name" class="form-label">Business Name:</label>
                <input type="text" class="form-control" id="business_name" name="business_name" value="{{ order.invoice_details.business_name | default(our_business_name) }}" required>
            </div>
            <div class="mb-3">
                <label for="business_address" class="form-label">Business Address:</label>
                <textarea class="form-control" id="business_address" name="business_address" rows="3" required>{{ order.invoice_details.business_address | default(our_business_address) }}</textarea>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="gst_number" class="form-label">GSTIN:</label>
                    <input type="text" class="form-control" id="gst_number" name="gst_number" value="{{ order.invoice_details.gst_number | default(our_gstin) }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="pan_number" class="form-label">PAN No:</label>
                    <input type="text" class="form-control" id="pan_number" name="pan_number" value="{{ order.invoice_details.pan_number | default(our_pan) }}" required>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h4>Invoice & Order Information</h4>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="invoice_number" class="form-label">Invoice Number:</label>
                    <input type="text" class="form-control" id="invoice_number" name="invoice_number" value="{{ order.invoice_details.invoice_number | default('') }}" readonly>
                    <small class="text-muted">Generated automatically.</small>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="invoice_date" class="form-label">Invoice Date:</label>
                    <input type="text" class="form-control" id="invoice_date" name="invoice_date" value="{{ order.invoice_details.invoice_date | default(now().strftime('%Y-%m-%d %H:%M:%S')) }}" readonly>
                    <small class="text-muted">Generated automatically.</small>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Order ID:</label>
                <input type="text" class="form-control" value="{{ order.order_id }}" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Order Date:</label>
                <input type="text" class="form-control" value="{{ order.placed_on }}" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Order Status:</label>
                <input type="text" class="form-control" value="{{ order.status }}" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Invoice Status:</label>
                <input type="text" class="form-control" value="{{ order.invoice_details.invoice_status | default('Not Applicable') }}" readonly>
                <small class="text-muted">Status: {{ 'On Hold' if order.invoice_details.is_held_by_admin | default(false) else 'Not On Hold' }}</small>
            </div>
        </div>

        <div class="form-section">
            <h4>Customer Details (Bill To / Ship To)</h4>
            <div class="mb-3">
                <label class="form-label">Name:</label>
                <input type="text" class="form-control" value="{{ order.customer_name }}" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Email:</label>
                <input type="text" class="form-control" value="{{ order.user_email }}" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Phone:</label>
                <input type="text" class="form-control" value="{{ order.customer_phone | mask_phone_number }}" readonly>
                <small class="text-muted">Camouflaged for privacy.</small>
            </div>
            <div class="mb-3">
                <label class="form-label">Address:</label>
                <textarea class="form-control" rows="3" readonly>{{ order.customer_address }}, Pincode: {{ order.customer_pincode }}</textarea>
            </div>
        </div>

        <div class="form-section">
            <h4>Item Particulars</h4>
            <div class="table-responsive">
                <table class="table table-sm table-striped table-items">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Description</th>
                            <th class="text-end">Qty</th>
                            <th class="text-end">Unit Price (₹)</th>
                            <th class="text-end">Total (₹)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.items %}
                            <tr>
                                <td data-label="#">{{ loop.index }}</td>
                                <td data-label="Description">
                                    {{ item.name }} (SKU: {{ item.sku }})
                                    {% if item.size and item.size != 'Original' %}<br><small class="text-muted">Size: {{ item.size }}</small>{% endif %}
                                    {% if item.frame and item.frame != 'None' %}<br><small class="text-muted">Frame: {{ item.frame }}</small>{% endif %}
                                    {% if item.glass and item.glass != 'None' %}<br><small class="text-muted">Glass: {{ item.glass }}</small>{% endif %}
                                </td>
                                <td data-label="Qty" class="text-end">{{ item.quantity }}</td>
                                <td data-label="Unit Price (₹)" class="text-end">{{ item.unit_price | round(2) }}</td>
                                <td data-label="Total (₹)" class="text-end">{{ item.total_price | round(2) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="4" class="text-end">Subtotal:</th>
                            <th class="text-end">₹{{ order.total_amount | round(2) }}</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="form-section">
            <h4>Charges & Final Amount</h4>
            <div class="mb-3">
                <label for="shipping_charge" class="form-label">Shipping Charges (₹):</label>
                <input type="number" step="0.01" class="form-control" id="shipping_charge" name="shipping_charge" value="{{ order.invoice_details.shipping_charge | default(0.0) | round(2) }}" required>
            </div>
            <div class="mb-3">
                <label for="gst_rate" class="form-label">GST Rate (%):</label>
                <input type="number" step="0.01" class="form-control" id="gst_rate" name="gst_rate" value="{{ (order.invoice_details.total_gst_amount / order.total_amount * 100) | round(2) if order.total_amount else default_gst_rate | round(2) }}" required>
                <small class="text-muted">Calculated based on Subtotal.</small>
            </div>
            <div class="mb-3">
                <label class="form-label">Calculated GST Amount (₹):</label>
                <input type="text" class="form-control" value="{{ order.invoice_details.total_gst_amount | default(0.0) | round(2) }}" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Final Invoice Amount (₹):</label>
                <input type="text" class="form-control" value="{{ order.invoice_details.final_invoice_amount | default(0.0) | round(2) }}" readonly>
            </div>
        </div>

        <div class="d-flex justify-content-end mt-4">
            <button type="submit" class="btn btn-primary btn-lg">Save Changes & Hold Invoice</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const subtotal = parseFloat("{{ order.total_amount | round(2) }}");
        const shippingChargeInput = document.getElementById('shipping_charge');
        const gstRateInput = document.getElementById('gst_rate');
        const calculatedGstAmountInput = document.querySelector('input[value="{{ order.invoice_details.total_gst_amount | default(0.0) | round(2) }}"]');
        const finalInvoiceAmountInput = document.querySelector('input[value="{{ order.invoice_details.final_invoice_amount | default(0.0) | round(2) }}"]');

        function updateCalculatedAmounts() {
            let shipping = parseFloat(shippingChargeInput.value) || 0;
            let gstRate = (parseFloat(gstRateInput.value) || 0) / 100;

            let calculatedGst = subtotal * gstRate;
            let finalAmount = subtotal + calculatedGst + shipping;

            calculatedGstAmountInput.value = calculatedGst.toFixed(2);
            finalInvoiceAmountInput.value = finalAmount.toFixed(2);
        }

        shippingChargeInput.addEventListener('input', updateCalculatedAmounts);
        gstRateInput.addEventListener('input', updateCalculatedAmounts);

        updateCalculatedAmounts(); // Call on load to ensure initial values are correctly displayed/calculated
    });

    // Custom Jinja2 filter for phone number masking (client-side only for display)
    // This is defined here for client-side calculation during template rendering.
    // The server-side masking in app.py's `mask_phone_number` function is the authoritative one.
    function maskPhoneNumberFilter(phoneNumber) {
        if (!phoneNumber || phoneNumber.length < 4) {
            return phoneNumber;
        }
        const visiblePrefixLen = 3;
        const visibleSuffixLen = 4;
        
        if (phoneNumber.length <= visiblePrefixLen + visibleSuffixLen) {
            return phoneNumber.substring(0, visiblePrefixLen) + 'X'.repeat(phoneNumber.length - visiblePrefixLen);
        }

        return phoneNumber.substring(0, visiblePrefixLen) + 'X'.repeat(phoneNumber.length - visiblePrefixLen - visibleSuffixLen) + phoneNumber.substring(phoneNumber.length - visibleSuffixLen);
    }

    // Add a custom filter to Jinja2 environment (this is typically done in app.py)
    // For client-side JS demo:
    // This part would typically be handled on the server by Jinja2's environment.
    // For the purpose of making the Javascript for recalculation easier to read,
    // I'm defining a JS equivalent. This is NOT how you add a Jinja2 filter.
    // The mask_phone_number filter is implemented in app.py and applied directly in the template.
    // No need to replicate it here in JS unless there's a dynamic JS need.
    // For displaying on the edit form, it's already rendered via {{ order.customer_phone | mask_phone_number }}
</script>
{% endblock %}
