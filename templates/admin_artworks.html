{% extends '_base.html' %}

{% block title %}Manage Artworks - Karthika Futures{% endblock %}

{% block content %}
<div class="container main-content-area py-5">
    <h2 class="text-center mb-4">Manage Artworks</h2>

    {# Updated admin_navbar.html content directly here to fix the URL #}
    <nav class="nav nav-pills flex-column flex-sm-row bg-light p-3 rounded-lg shadow-sm mb-4">
        <a class="flex-sm-fill text-sm-center nav-link {% if request.endpoint == 'admin_dashboard' and not request.args.get('filter_status') and not request.args.get('search') %}active{% endif %}" href="{{ url_for('admin_dashboard') }}">Dashboard</a>
        <a class="flex-sm-fill text-sm-center nav-link {% if request.endpoint == 'admin_dashboard' and (request.args.get('filter_status') or request.args.get('search')) %}active{% endif %}" href="{{ url_for('admin_dashboard') }}">Orders</a> {# Changed endpoint to admin_dashboard #}
        <a class="flex-sm-fill text-sm-center nav-link {% if request.endpoint == 'admin_artworks' %}active{% endif %}" href="{{ url_for('admin_artworks') }}">Artworks</a>
        <a class="flex-sm-fill text-sm-center nav-link {% if request.endpoint == 'admin_categories' %}active{% endif %}" href="{{ url_for('admin_categories') }}">Categories</a>
        <a class="flex-sm-fill text-sm-center nav-link {% if request.endpoint == 'admin_users' %}active{% endif %}" href="{{ url_for('admin_users') }}">Users</a>
        <a class="flex-sm-fill text-sm-center nav-link" href="{{ url_for('logout') }}">Logout</a> {# Changed admin_logout to user_logout #}
    </nav>
    {# End of admin_navbar.html content #}

    <div class="admin-toolbar mb-4">
       
       <div class="row mb-3">
    <div class="col-md-6">
        <input type="text"
               id="adminSearchInput"
               class="form-control"
               placeholder="Search by SKU, Name, Category, Status, Featured‚Ä¶">
    </div>
    <div class="col-md-6 text-end text-muted small">
        üîç Instant search (client-side)
    </div>
</div>

        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h4 class="mb-0">All Artworks</h4>

    <div class="d-flex gap-2">
        <a href="{{ url_for('admin_add_artwork') }}"
           class="btn btn-success">
            <i class="fas fa-plus me-2"></i>Add New Artwork
        </a>

        <button type="button"
                id="exportCsvBtn"
                class="btn btn-outline-success">
            <i class="fas fa-file-excel me-2"></i>Export CSV
        </button>
    </div>
</div>

    </div>

    {% if artworks %}
    <div class="table-responsive">
        <table class="table table-hover table-striped align-middle">
          <thead class="table-dark">
<tr>
    <th>#</th>
    <th>Image</th>
    <th class="sortable">SKU</th>
    <th class="sortable">Name</th>
    <th class="sortable">Category</th>
    <th class="sortable">Base ‚Çπ</th>
    <th>GST %</th>
    <th class="sortable">Shipping ‚Çπ</th>
    <th class="sortable">Final ‚Çπ</th>
    <th class="sortable">Stock</th>
    <th class="sortable">Status</th>
    <th>Featured</th>
    <th>Actions</th>
</tr>
</thead>

            <tbody>
                {% for artwork in artworks %}
               
               <tr class="{% if not artwork.is_active %}table-secondary{% endif %}">

<td>{{ loop.index }}</td>   <!-- ‚úÖ ROW NUMBER -->

<td>
{% set images = artwork.get_images_list() %}
{% if images %}
<img src="{{ images[0] }}" class="img-thumbnail"
     style="width:70px;height:70px;object-fit:cover;border-radius:0.5rem;">
{% else %}
<img src="{{ url_for('static', filename='images/placeholder.png') }}"
     class="img-thumbnail" style="width:70px;height:70px;">
{% endif %}
</td>

<td>{{ artwork.sku }}</td>

<td>
<strong>{{ artwork.name }}</strong><br>
<small class="text-muted">{{ artwork.category.name if artwork.category else 'N/A' }}</small>
</td>

<td>{{ artwork.category.name if artwork.category else 'N/A' }}</td>

<td class="price">‚Çπ {{ artwork.original_price }}</td>

<td>
{% if artwork.gst_type == 'intra_state' %}
{{ artwork.cgst_percentage + artwork.sgst_percentage }}%
{% elif artwork.gst_type == 'inter_state' %}
{{ artwork.igst_percentage }}%
{% else %}
{{ artwork.cgst_percentage + artwork.ugst_percentage }}%
{% endif %}
</td>

<td>‚Çπ {{ artwork.shipping_charge }}</td>

<td>
{% set gst_rate = (
    artwork.cgst_percentage + artwork.sgst_percentage
    if artwork.gst_type == 'intra_state'
    else artwork.igst_percentage
    if artwork.gst_type == 'inter_state'
    else artwork.cgst_percentage + artwork.ugst_percentage
) %}
{% set gst_amount = ((artwork.original_price * gst_rate) / 100) | round(2) %}
‚Çπ {{ (artwork.original_price + gst_amount + artwork.shipping_charge) | round(2) }}
</td>


<td>
<span class="badge {% if artwork.stock > 5 %}bg-success{% else %}bg-danger{% endif %}">

{{ artwork.stock }}
</span>
</td>

<td>
{% if artwork.is_active %}
<span class="badge badge-visible">Visible</span>
{% else %}
<span class="badge badge-hidden">Hidden</span>
{% endif %}
</td>

<td>
{% if artwork.is_featured %}
<span class="featured-star">‚≠ê</span>
{% else %}
‚Äî
{% endif %}

</td>

<td class="d-flex gap-1 justify-content-center action-btns">

<a href="{{ url_for('admin_edit_artwork', artwork_id=artwork.id) }}"
   class="btn btn-sm btn-primary">
<i class="fas fa-edit"></i>
</a>

<form method="POST"
      action="{{ url_for('toggle_artwork_visibility', artwork_id=artwork.id) }}">
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
<button type="submit"
        class="btn btn-sm {% if artwork.is_active %}btn-warning{% else %}btn-success{% endif %}">
{% if artwork.is_active %}Hide{% else %}Unhide{% endif %}
</button>
</form>

<button type="button"
        class="btn btn-sm btn-danger delete-artwork-btn"
        data-bs-toggle="modal"
        data-bs-target="#deleteArtworkModal"
        data-artwork-id="{{ artwork.id }}"
        data-artwork-name="{{ artwork.name }}">
<i class="fas fa-trash-alt"></i>
</button>

</td>
</tr>

                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info text-center" role="alert">
        No artworks found. <a href="{{ url_for('admin_add_artwork') }}">Add your first artwork!</a>
    </div>
    {% endif %}
</div>

{# Delete Artwork Confirmation Modal #}
<div class="modal fade" id="deleteArtworkModal" tabindex="-1" aria-labelledby="deleteArtworkModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteArtworkModalLabel">Confirm Artwork Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete the artwork "<strong id="artworkNameToDelete"></strong>"? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteArtworkForm" method="POST" action="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">Delete Artwork</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  /* ===============================
     üîç CLIENT-SIDE SEARCH FILTER
     =============================== */
  const searchInput = document.getElementById("adminSearchInput");
  const tableRows = document.querySelectorAll("tbody tr");

  if (searchInput) {
    searchInput.addEventListener("keyup", function () {
      const query = this.value.toLowerCase();

      tableRows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(query)
          ? ""
          : "none";
      });
    });
  }

  /* ===============================
     üîÉ COLUMN SORTING
     =============================== */
  document.querySelectorAll("th.sortable").forEach((header, colIndex) => {
    let asc = true;

    header.addEventListener("click", () => {
      const tbody = header.closest("table").querySelector("tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));

      rows.sort((a, b) => {
        let A = a.children[colIndex].innerText.trim();
        let B = b.children[colIndex].innerText.trim();

        let numA = parseFloat(A.replace(/[‚Çπ,%]/g, ""));
        let numB = parseFloat(B.replace(/[‚Çπ,%]/g, ""));

        if (!isNaN(numA) && !isNaN(numB)) {
          return asc ? numA - numB : numB - numA;
        }

        return asc ? A.localeCompare(B) : B.localeCompare(A);
      });

      asc = !asc;
      rows.forEach(tr => tbody.appendChild(tr));
    });
  });

  /* ===============================
     üì§ CSV EXPORT (FILTERED ONLY)
     =============================== */
  const exportBtn = document.getElementById("exportCsvBtn");

  if (exportBtn) {
    exportBtn.addEventListener("click", function () {

      let csv = [];

      /* ---- CSV HEADER ---- */
      const headerCols = document.querySelectorAll("thead th:not(:last-child)");
      let headerRow = [];
      headerCols.forEach(th => {
        headerRow.push(`"${th.innerText.replace(/,/g, ' ')}"`);
      });
      csv.push(headerRow.join(","));

      /* ---- DATA ROWS (VISIBLE ONLY) ---- */
      const rows = document.querySelectorAll("tbody tr");

      rows.forEach(row => {
        if (row.offsetParent === null) return;

        const cols = row.querySelectorAll("td:not(:last-child)");
        let rowData = [];

        cols.forEach(col => {
          let text = col.innerText
            .replace("‚Çπ", "INR ")
            .replace(/\n/g, " ")
            .replace(/,/g, " ");
          rowData.push(`"${text}"`);
        });

        csv.push(rowData.join(","));
      });

      if (csv.length <= 1) {
        alert("No data to export");
        return;
      }

      const blob = new Blob(
        ["\ufeff" + csv.join("\n")], // UTF-8 BOM for Excel
        { type: "text/csv;charset=utf-8;" }
      );

      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "artworks_filtered_export.csv";
      link.style.display = "none";

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  }

  /* ===============================
     üóë DELETE MODAL HANDLER
     =============================== */
  const deleteArtworkModalElement = document.getElementById("deleteArtworkModal");

  if (deleteArtworkModalElement) {
    const deleteArtworkModal = new bootstrap.Modal(deleteArtworkModalElement);
    const artworkNameToDelete = document.getElementById("artworkNameToDelete");
    const deleteArtworkForm = document.getElementById("deleteArtworkForm");

    document.querySelectorAll(".delete-artwork-btn").forEach(button => {
      button.addEventListener("click", function () {
        artworkNameToDelete.textContent = this.dataset.artworkName;
        deleteArtworkForm.action =
          `/admin/artwork/delete/${this.dataset.artworkId}`;
        deleteArtworkModal.show();
      });
    });
  }

});
</script>
{% endblock %}
<style>
/* ---------- ADMIN TABLE POLISH ---------- */

.table thead th {
  position: sticky;
  top: 0;
  z-index: 5;
  background: #1f2933;
  color: #fff;
  font-weight: 600;
  white-space: nowrap;
}

.table tbody tr:hover {
  background-color: #f8fafc;
}

.table td, .table th {
  vertical-align: middle !important;
  text-align: center;
}

.table td:nth-child(3),
.table th:nth-child(3) {
  text-align: left;
}

/* Price columns */
.price {
  font-weight: 600;
  color: #0f172a;
}

/* Status badges */
.badge-visible {
  background-color: #16a34a;
}
.badge-hidden {
  background-color: #6b7280;
}

/* Featured star */
.featured-star {
  color: #facc15;
  font-size: 1.1rem;
}

/* Action buttons compact */
.action-btns .btn {
  padding: 4px 8px;
}

/* Search box */
#adminSearchInput {
  max-width: 320px;
  border-radius: 10px;
}

/* Toolbar spacing */
.admin-toolbar {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
}
</style>
