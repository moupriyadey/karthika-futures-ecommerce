{% extends '_base.html' %}

{% block title %}Complete Your Payment - Karthika Futures{% endblock %}

{% block extra_css %}{% endblock %} {# Keep this block for any page-specific CSS if needed #}

{% block content %}
<div class="container mx-auto p-4 md:p-8 main-content-area">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-2xl mx-auto">
        <h2 class="text-3xl font-extrabold text-center text-gray-800 mb-6">Complete Your Payment</h2>
        <p class="text-center text-gray-600 mb-6">
            Order <strong class="text-primary">#{{ order.id }}</strong> placed successfully.
            Please pay <strong class="text-primary">{{ amount | currency }}</strong> via UPI to confirm.
        </p>

        <!-- QR Code Section -->
        <div class="bg-gray-50 p-6 rounded-xl shadow-inner text-center mb-6 border border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Scan this QR Code</h3>
            <div id="qrcode" class="mx-auto p-2 rounded-lg border-4 border-white bg-white shadow-2xl" style="width: 220px; height: 220px;">
                <p id="qrcode-fallback" class="text-red-500 text-sm mt-4 hidden">QR generation failed. Use UPI ID below.</p>
            </div>
            <p class="mt-4 text-gray-700 text-sm font-semibold">UPI ID: <span class="text-primary">{{ our_upi_id }}</span></p>

            <!-- UPI Logos -->
            <div class="flex justify-center items-center gap-3 mt-4 flex-wrap">
                <img src="{{ url_for('static', filename='images/upi_logos/bhim.png') }}" alt="BHIM" class="h-8">
                <img src="{{ url_for('static', filename='images/upi_logos/phonepe.png') }}" alt="PhonePe" class="h-8">
                <img src="{{ url_for('static', filename='images/upi_logos/gpay.png') }}" alt="Google Pay" class="h-8">
                <img src="{{ url_for('static', filename='images/upi_logos/paytm.png') }}" alt="Paytm" class="h-8">
            </div>
        </div>

        <!-- Form Section -->
        <form action="{{ url_for('payment_submit', order_id=order.id) }}" method="POST" enctype="multipart/form-data" class="space-y-5">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div>
                <label for="transaction_id" class="block text-sm font-semibold text-gray-700 mb-1 text-center">Transaction ID (12-digit UTR):</label>
                <input type="text" id="transaction_id" name="transaction_id"
                       class="form-control w-full text-center text-lg font-bold"
                       inputmode="numeric" pattern="[0-9]{12}" minlength="12" maxlength="12"
                       placeholder="Enter UTR/Ref No." required
                       title="Enter a 12-digit UTR number">
            </div>

            <div>
                <label for="payment_screenshot" class="block text-sm font-semibold text-gray-700 mb-1 text-center">
                    Upload Payment Screenshot <span class="text-gray-500 text-xs">(Optional)</span>
                </label>
                <input type="file" id="payment_screenshot" name="payment_screenshot" accept="image/*" class="form-control">
                <p class="text-xs text-gray-500 mt-1">Uploading helps us verify your payment faster.</p>
            </div>

            <button type="submit" class="w-full btn btn-primary py-2.5 text-lg rounded-md">Confirm Payment</button>
        </form>

        <div class="text-center mt-6">
            <a href="{{ url_for('user_orders') }}" class="btn btn-link text-sm">‚Üê Back to My Orders</a>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Prevent back button from leaving the payment page (optional, but good for payment flows)
        history.pushState(null, null, location.href);
        window.addEventListener('popstate', function () {
            history.go(1);
        });

        const upiId = "{{ our_upi_id }}"; // Use Flask variable directly
        const bankingName = "{{ our_banking_name }}"; // Use Flask variable directly
        const orderId = "{{ order.id }}";
        const amount = "{{ amount | round(2) }}"; // Ensure amount is rounded for UPI link
        const encodedBankingName = encodeURIComponent(bankingName);
        const upiLink = `upi://pay?pa=${upiId}&pn=${encodedBankingName}&am=${amount}&tn=${orderId}&cu=INR`;

        try {
            const qrDiv = document.getElementById("qrcode");
            const qrFallback = document.getElementById("qrcode-fallback"); // Get fallback element

            if (qrDiv) { // Add null check for qrDiv
                qrDiv.innerHTML = ""; // Clear existing content
                new QRCode(qrDiv, {
                    text: upiLink,
                    width: 200, // Matched with CSS
                    height: 200, // Matched with CSS
                    colorDark: "#000",
                    colorLight: "#fff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                if (qrFallback) { // Add null check for qrFallback
                    qrFallback.style.display = "none";
                }
            } else {
                console.error("QR code container (qrcode) not found.");
                if (qrFallback) {
                    qrFallback.textContent = "QR code generation failed: Container missing.";
                    qrFallback.style.display = "block";
                }
            }
        } catch (error) {
            console.error("QR generation error:", error);
            const qrDiv = document.getElementById("qrcode");
            const qrFallback = document.getElementById("qrcode-fallback");
            if (qrDiv) {
                qrDiv.innerHTML = "QR code generation failed."; // Display message in QR div
            }
            if (qrFallback) { // Add null check for qrFallback
                qrFallback.style.display = "block"; // Show fallback message
            }
        }

        // Optional: Add an input filter for the transaction_id to only allow numbers
        const transactionIdInput = document.getElementById('transaction_id');
        if (transactionIdInput) {
            transactionIdInput.addEventListener('input', function(e) {
                // Remove any non-digit characters
                e.target.value = e.target.value.replace(/\D/g, '');
            });
        }
    });
</script>
{% endblock %}
