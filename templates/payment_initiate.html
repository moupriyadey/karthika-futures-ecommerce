{% extends '_base.html' %}

{% block title %}Complete Your Payment - Karthika Futures{% endblock %}

{% block extra_css %}{% endblock %} {# Keep this block for any page-specific CSS if needed #}

{% block content %}
<div class="container mx-auto p-4 md:p-8 main-content-area">
    <div class="bg-white p-6 rounded-lg shadow-md payment-container">
        <h2 class="text-3xl font-extrabold text-center text-gray-800 mb-6">Complete Your Payment</h2>
        <p class="lead text-center text-gray-600 mb-6">
            Your order #<span class="font-bold text-primary">{{ order.id }}</span> has been placed successfully.
            Please complete the payment of <span class="font-bold text-primary">{{ amount | currency }}</span> to confirm your order.
        </p>

        <div class="flex flex-col items-center space-y-6">
            <!-- UPI QR Code Section -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner text-center w-full max-w-sm">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Scan to Pay (UPI)</h3>
                <div id="qrcode" class="mx-auto border-2 border-gray-300 p-2 rounded-md" style="width: 200px; height: 200px;">
                    <!-- QR code will be generated here by JavaScript -->
                    <p id="qrcode-fallback" class="text-red-500 text-sm mt-4 hidden">QR code generation failed. Please use the UPI ID below.</p>
                </div>
                <p class="text-gray-700 mt-4 font-semibold">UPI ID: <span class="text-primary">{{ our_upi_id }}</span></p>
                {# Removed Banking Name and Bank Name display as requested #}
                {# <p class="text-gray-700 mt-1 font-semibold">Banking Name: <span class="text-primary">{{ our_banking_name }}</span></p> #}
            </div>

            <!-- Transaction ID Submission -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner text-center w-full max-w-sm">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Confirm Payment</h3>
                <p class="text-gray-600 mb-4">After successful payment, please enter the Transaction ID (UTR/Ref No.) below:</p>
                <form action="{{ url_for('payment_submit', order_id=order.id) }}" method="POST" class="space-y-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div>
                        <label for="transaction_id" class="sr-only">Transaction ID</label>
                        <input type="text" id="transaction_id" name="transaction_id" 
                               class="form-control w-full text-center text-lg font-bold"
                               placeholder="Enter Transaction ID (UTR/Ref No.)" required>
                    </div>
                    <button type="submit" class="w-full btn btn-primary py-2.5 text-lg rounded-md">
                        Confirm Payment
                    </button>
                </form>
            </div>
        </div>

        <div class="text-center mt-8">
            <a href="{{ url_for('user_orders') }}" class="btn btn-link">‚Üê Back to My Orders</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Prevent back button from leaving the payment page (optional, but good for payment flows)
        history.pushState(null, null, location.href);
        window.addEventListener('popstate', function () {
            history.go(1);
        });

        const upiId = "{{ our_upi_id }}"; // Use Flask variable directly
        const bankingName = "{{ our_banking_name }}"; // Use Flask variable directly
        const orderId = "{{ order.id }}";
        const amount = "{{ amount | round(2) }}"; // Ensure amount is rounded for UPI link
        const encodedBankingName = encodeURIComponent(bankingName);
        const upiLink = `upi://pay?pa=${upiId}&pn=${encodedBankingName}&am=${amount}&tn=${orderId}&cu=INR`;

        try {
            const qrDiv = document.getElementById("qrcode");
            const qrFallback = document.getElementById("qrcode-fallback"); // Get fallback element

            if (qrDiv) { // Add null check for qrDiv
                qrDiv.innerHTML = ""; // Clear existing content
                new QRCode(qrDiv, {
                    text: upiLink,
                    width: 200, // Matched with CSS
                    height: 200, // Matched with CSS
                    colorDark: "#000",
                    colorLight: "#fff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                if (qrFallback) { // Add null check for qrFallback
                    qrFallback.style.display = "none";
                }
            } else {
                console.error("QR code container (qrcode) not found.");
                if (qrFallback) {
                    qrFallback.textContent = "QR code generation failed: Container missing.";
                    qrFallback.style.display = "block";
                }
            }
        } catch (error) {
            console.error("QR generation error:", error);
            const qrDiv = document.getElementById("qrcode");
            const qrFallback = document.getElementById("qrcode-fallback");
            if (qrDiv) {
                qrDiv.innerHTML = "QR code generation failed."; // Display message in QR div
            }
            if (qrFallback) { // Add null check for qrFallback
                qrFallback.style.display = "block"; // Show fallback message
            }
        }

        // Optional: Add an input filter for the transaction_id to only allow numbers
        const transactionIdInput = document.getElementById('transaction_id');
        if (transactionIdInput) {
            transactionIdInput.addEventListener('input', function(e) {
                // Remove any non-digit characters
                e.target.value = e.target.value.replace(/\D/g, '');
            });
        }
    });
</script>
{% endblock %}
