{% extends '_base.html' %}

{% block title %}Complete Your Payment - Karthika Futures{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f0f2f5; /* Lighter background for a modern feel */
    }

    .payment-container {
        padding: 2.5rem; /* Slightly reduced padding */
        background-color: #ffffff;
        border-radius: 0.75rem; /* Softer corners */
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.08); /* Lighter, more modern shadow */
        margin-top: 2rem; /* Reduced top margin */
        margin-bottom: 2rem; /* Reduced bottom margin */
        text-align: center;
        max-width: 600px; /* Make it more compact overall */
        margin-left: auto;
        margin-right: auto;
    }

    h2 {
        color: #212529; /* Darker heading color */
        font-weight: 700;
        margin-bottom: 1.5rem; /* Reduced margin */
        font-size: 2.2rem; /* Slightly larger for prominence */
    }
    .lead {
        font-size: 1.15rem; /* Slightly smaller for compactness */
        color: #495057;
        margin-bottom: 1rem;
    }
    .upi-details {
        font-size: 1rem; /* Slightly smaller */
        color: #6c757d; /* Softer text color */
        margin-bottom: 2rem; /* More space below details */
        line-height: 1.4;
    }

    #qrcode {
        width: 200px; /* Smaller QR code */
        height: 200px; /* Smaller QR code */
        margin: 20px auto; /* Reduced margin */
        border: 1px solid #e9ecef; /* Lighter border */
        padding: 10px; /* Reduced padding */
        background-color: #fdfdfd; /* Even lighter background */
        border-radius: 0.5rem; /* Softer corners */
        /* Embossed effect */
        box-shadow: 
            inset 0 2px 4px rgba(0,0,0,0.06), /* Inner shadow for embossed effect */
            0 4px 8px rgba(0,0,0,0.08); /* Small shade behind */
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 0.8em;
        color: #adb5bd; /* Lighter fallback text */
    }
    .upi-apps {
        margin-top: 1.5rem;
        display: flex;
        justify-content: center;
        gap: 15px; /* Space between icons */
        flex-wrap: wrap; /* Allow wrapping on small screens */
    }

    .upi-apps img {
        width: 50px; /* Standard icon size */
        height: 50px;
        object-fit: contain;
        border-radius: 8px; /* Slightly rounded corners for icons */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); /* Subtle shadow for icons */
        transition: transform 0.2s ease-in-out;
    }

    .upi-apps img:hover {
        transform: scale(1.08); /* Slight enlarge on hover */
    }

    .payment-instructions {
        margin-top: 2rem; /* Adjusted margin */
        font-size: 0.95rem; /* Slightly smaller font */
        color: #495057;
        line-height: 1.8; /* Increased line height for readability */
        text-align: left;
        padding: 0 15px; /* Reduced horizontal padding */
    }
    .payment-instructions ol {
        padding-left: 25px; /* Indent list */
        margin-bottom: 0;
    }
    .payment-instructions li {
        margin-bottom: 0.75rem; /* Space between list items */
    }
    .payment-form-section {
        margin-top: 2.5rem; /* Reduced top margin */
        border-top: none; /* Remove dashed border for cleaner look */
        padding-top: 2.5rem; /* Keep padding-top for visual separation */
        background-color: #f8f9fa; /* Slightly darker background than main container */
        border-radius: 0.75rem;
        box-shadow: none; /* Remove shadow here, let container handle it */
        padding: 2rem; /* Reduced padding */
        border: 1px solid #e9ecef; /* Add a subtle border */
    }
    .form-label {
        font-weight: 600;
        color: #343a40; /* Darker label text */
    }
    .form-control {
        border-radius: 0.4rem; /* Slightly smaller border-radius */
        padding: 0.65rem 1rem; /* Slightly smaller padding */
        font-size: 0.95rem;
    }
    .form-text {
        font-size: 0.85em; /* Slightly smaller hint text */
        color: #868e96; /* Softer hint text */
    }
    .btn-primary {
        background-color: #1a73e8; /* Google-like blue for primary action */
        border-color: #1a73e8;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border-radius: 0.4rem;
        transition: all 0.2s ease-in-out; /* Smoother transition */
    }
    .btn-primary:hover {
        background-color: #155bb5; /* Darker hover */
        border-color: #155bb5;
        transform: translateY(-1px); /* Slight lift on hover */
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1); /* Subtle shadow on hover */
    }
    .btn-link {
        color: #007bff;
        font-weight: 500;
        text-decoration: none; /* Remove underline by default */
    }
    .btn-link:hover {
        text-decoration: underline; /* Add underline on hover */
    }

    /* Mobile adjustments */
    @media (max-width: 767.98px) {
        .payment-container {
            margin: 0.75rem; /* Smaller margin on mobile */
            padding: 1.5rem; /* Reduced padding */
        }
        h2 {
            font-size: 1.8rem; /* Smaller heading on mobile */
            margin-bottom: 1rem;
        }
        .lead {
            font-size: 1rem;
        }
        .upi-details {
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }
        #qrcode {
            width: 180px; /* Even smaller QR on mobile */
            height: 180px;
            margin: 15px auto;
        }
        .payment-instructions {
            font-size: 0.9rem;
            padding: 0 10px;
        }
        .payment-instructions li {
            margin-bottom: 0.5rem;
        }
        .payment-form-section {
            padding: 1.25rem; /* Reduced padding */
            margin-top: 2rem;
        }
        .form-control {
            padding: 0.6rem 0.8rem;
            font-size: 0.9rem;
        }
        .btn-primary {
            padding: 0.6rem 1.2rem;
            font-size: 0.95rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container payment-container">
    <h2 class="mb-4">üí∞ Complete Your Payment</h2>

    <p class="lead">Please scan the QR code below to pay <strong>‚Çπ{{ "%.2f" | format(amount) }}</strong> for Order ID: <strong>{{ order_id }}</strong>.</p> {# FIXED: floatformat #}
    <p class="upi-details">
        Your UPI ID: <strong>{{ upi_id }}</strong><br>
        Banking Name: <strong>{{ banking_name }}</strong> (Bank: {{ bank_name }})
    </p>

    <div id="qrcode"></div>
    <p id="qrcode-fallback" style="display:none; color: #dc3545; font-size: 0.9em; margin-top: 10px;">QR code generation failed. Please use the UPI ID above to pay manually.</p>

    <div class="upi-apps">
        <img src="https://uxwing.com/wp-content/themes/uxwing/download/brands-social-media/bhim-upi-icon.png" alt="BHIM UPI" title="Pay with BHIM UPI">
        <img src="https://uxwing.com/wp-content/themes/uxwing/download/brands-social-media/google-pay-icon.png" alt="Google Pay" title="Pay with Google Pay">
        <img src="https://uxwing.com/wp-content/themes/uxwing/download/brands-social-media/phonepe-icon.png" alt="PhonePe" title="Pay with PhonePe">
        <img src="https://uxwing.com/wp-content/themes/uxwing/download/brands-social-media/paytm-icon.png" alt="Paytm" title="Pay with Paytm">
    </div>

    <div class="payment-instructions card mt-5">
        <h5>How to Pay:</h5>
        <ol>
            <li>Open any UPI app (Google Pay, PhonePe, Paytm, etc.)</li>
            <li>Tap ‚ÄúScan QR‚Äù and scan the code above.</li>
            <li>Confirm the amount (‚Çπ{{ "%.2f" | format(amount) }}) and recipient ({{ banking_name }}).</li> {# FIXED: floatformat #}
            <li>Complete payment and note down the Transaction/Reference ID (UTR).</li>
        </ol>
    </div>

    <div class="payment-form-section card p-4 shadow-sm">
        <h4 class="mb-3">Confirm Your Payment Details</h4>
        <form method="POST" action="{{ url_for('payment_submit', order_id=order_id) }}" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
                <label for="transaction_id" class="form-label">Transaction ID / UTR <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="transaction_id" name="transaction_id" required placeholder="e.g., 012345678912" pattern="[0-9]{12}" maxlength="12" inputmode="numeric" title="Please enter a 12-digit UTR number">
                <div class="form-text">This helps us verify your payment quickly.</div>
            </div>
            <div class="mb-3">
                <label for="screenshot" class="form-label">Upload Screenshot <small class="text-muted">(Optional)</small></label>
                <input type="file" class="form-control" id="screenshot" name="payment_screenshot" accept="image/*">
                <div class="form-text">Uploading a screenshot can help expedite your payment verification.</div>
            </div>
            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-primary btn-lg">I Have Paid ‚Äì Submit</button>
            </div>
        </form>
    </div>

    <div class="mt-4">
        <p class="text-muted mb-2">Your order will be verified and updated shortly. Thank you for your payment!</p>
        <a href="{{ url_for('my_orders') }}" class="btn btn-link">‚Üê Back to My Orders</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Prevent back button from leaving the payment page
        history.pushState(null, null, location.href);
        window.addEventListener('popstate', function () {
            history.go(1);
        });

        const upiId = "{{ upi_id }}"; // Use Flask variable directly
        const bankingName = "{{ banking_name }}"; // Use Flask variable directly
        const orderId = "{{ order_id }}";
        const amount = "{{ amount | round(2) }}"; // Ensure amount is rounded for UPI link
        const encodedBankingName = encodeURIComponent(bankingName);
        const upiLink = `upi://pay?pa=${upiId}&pn=${encodedBankingName}&am=${amount}&tn=${orderId}&cu=INR`;

        try {
            const qrDiv = document.getElementById("qrcode");
            qrDiv.innerHTML = ""; // Clear existing content
            new QRCode(qrDiv, {
                text: upiLink,
                width: 200, // Matched with CSS
                height: 200, // Matched with CSS
                colorDark: "#000",
                colorLight: "#fff",
                correctLevel: QRCode.CorrectLevel.H
            });
            document.getElementById("qrcode-fallback").style.display = "none";
        } catch (error) {
            console.error("QR generation error:", error);
            document.getElementById("qrcode").innerHTML = "QR code generation failed.";
            document.getElementById("qrcode-fallback").style.display = "block";
        }

        // Optional: Add an input filter for the transaction_id to only allow numbers
        const transactionIdInput = document.getElementById('transaction_id');
        if (transactionIdInput) {
            transactionIdInput.addEventListener('input', function(e) {
                // Remove any non-digit characters
                e.target.value = e.target.value.replace(/\D/g, '');
            });
        }
    });
</script>
{% endblock %}
