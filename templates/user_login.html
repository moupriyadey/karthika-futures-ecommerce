{% extends '_base.html' %}

{% block title %}User Login - Karthika Futures{% endblock %}

{% block content %}
<div class="container main-content-area py-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <h3 class="text-center mb-4">User Login</h3>

      <form method="POST" action="{{ url_for('user_login') }}" class="p-4 border rounded shadow-sm bg-white">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% if next_url %}<input type="hidden" name="next" value="{{ next_url }}">{% endif %}

        <div class="mb-3">
          <label for="email" class="form-label">Email address or Mobile Number</label>
          <input type="text" class="form-control" id="email" name="email" value="{{ prefill_email or '' }}" placeholder="e.g., your.email@example.com or 9876543210" required oninvalid="this.setCustomValidity('Enter your email or mobile')" oninput="setCustomValidity('')">
        </div>

        <div class="mb-3">
          <label for="password" class="form-label">
            Password <small class="text-muted">(leave blank to get OTP)</small>
          </label>
          <div class="input-group">
            <input type="password" class="form-control" id="password" name="password" placeholder="Enter password (optional)">
            <button class="btn btn-outline-secondary toggle-password" type="button" data-target="password">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>

        <div class="alert alert-info small" role="alert">
          If you leave the password field blank, an OTP will be sent to your registered email for verification and login.
        </div>

        <div class="d-grid gap-2">
          <button type="submit" class="btn btn-primary">Login / Get OTP</button>
        </div>
      </form>

      <p class="text-center mt-3">
        Not yet registered? <a href="{{ url_for('signup') }}">Click here to sign up via OTP</a>
      </p>

      <p class="text-center mt-2">
        <a href="{{ url_for('forgot_password') }}">Forgot Password?</a>
      </p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Function to toggle password visibility (reused from signup.html)
  document.querySelectorAll('.toggle-password').forEach(button => {
      button.addEventListener('click', () => {
          const targetId = button.dataset.target;
          const targetInput = document.getElementById(targetId);
          const icon = button.querySelector('i');

          if (targetInput.type === 'password') {
              targetInput.type = 'text';
              icon.classList.remove('fa-eye');
              icon.classList.add('fa-eye-slash');
          } else {
              targetInput.type = 'password';
              icon.classList.remove('fa-eye-slash');
              icon.classList.add('fa-eye');
          }
      });
  });

  const redirectAfterLogin = sessionStorage.getItem('redirect_after_login_endpoint');
  const itemToBuyNow = sessionStorage.getItem('itemToBuyNow');

  if (redirectAfterLogin === 'purchase_form' && itemToBuyNow) {
    // Send to Flask route that handles setting the item in session
    fetch("/create_direct_order", { // This route now handles setting direct_purchase_item
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: itemToBuyNow
    })
    .then(res => res.json())
    .then(data => {
      if (data.success && data.redirect_url) {
        sessionStorage.removeItem('itemToBuyNow');
        sessionStorage.removeItem('redirect_after_login_endpoint');
        window.location.href = data.redirect_url;
      } else {
        console.error("Direct order setup after login failed:", data.message);
        // Optionally show an alert if direct order setup fails
        // showCustomAlert(data.message || "Failed to set up direct purchase after login.", 'danger');
        // And redirect to all products or cart
        window.location.href = '/all-products';
      }
    })
    .catch(err => {
      console.error("Direct order setup error after login:", err);
      // showCustomAlert('An error occurred during direct purchase setup. Please try again.', 'danger');
      window.location.href = '/all-products';
    });
  }
});
</script>
{% endblock %}
