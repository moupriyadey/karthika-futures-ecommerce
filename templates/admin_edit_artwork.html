{% extends '_base.html' %}

{% block title %}Edit Artwork - Karthika Futures{% endblock %}

{% block content %}
<div class="container main-content-area py-5">
    <h2 class="text-center mb-4">Edit Artwork: {{ artwork.name }}</h2>

    <div class="card shadow-sm border-0 rounded-lg">
        <div class="card-header bg-light">
            <h4 class="mb-0">Artwork Details</h4>
        </div>
        <div class="card-body">
            <form action="{{ url_for('admin_edit_artwork', artwork_id=artwork.id) }}" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="mb-3">
                    <label for="sku" class="form-label">SKU (Unique Identifier)</label>
                    <input type="text" class="form-control" id="sku" name="sku" required value="{{ artwork.sku }}" readonly>
                    <small class="form-text text-muted">SKU cannot be changed.</small>
                </div>
                <div class="mb-3">
                    <label for="name" class="form-label">Artwork Name</label>
                    <input type="text" class="form-control" id="name" name="name" required value="{{ form_data.name if form_data.name is defined else artwork.name }}">
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="5">{{ form_data.description if form_data.description is defined else artwork.description }}</textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="original_price" class="form-label">Original Price (Before GST)</label>
                        <input type="number" class="form-control" id="original_price" name="original_price" step="0.01" min="0" required value="{{ form_data.original_price if form_data.original_price is defined else artwork.original_price }}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="stock" class="form-label">Stock Quantity</label>
                        <input type="number" class="form-control" id="stock" name="stock" min="0" required value="{{ form_data.stock if form_data.stock is defined else artwork.stock }}">
                    </div>
                </div>

                <div class="mb-3">
                    <label for="category_id" class="form-label">Category</label>
                    <select class="form-select" id="category_id" name="category_id" required>
                        <option value="">Select a Category</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if (form_data.category_id is defined and form_data.category_id == category.id) or (artwork.category_id == category.id and form_data.category_id is not defined) %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label for="shipping_charge" class="form-label">Shipping Charge (â‚¹)</label>
                    <input type="number" class="form-control" id="shipping_charge" name="shipping_charge" step="0.01" min="0" value="{{ form_data.shipping_charge if form_data.shipping_charge is defined else artwork.shipping_charge }}" required>
                    <small class="form-text text-muted">Enter 0 for free shipping.</small>
                </div>
                
                <h5 class="mt-4 mb-3">GST Details</h5>
                <div class="mb-3">
                    <label for="gst_type" class="form-label">GST Type</label>
                    <select class="form-select" id="gst_type" name="gst_type" required>
                        <option value="intra_state" {% if (form_data.gst_type is defined and form_data.gst_type == 'intra_state') or (artwork.gst_type == 'intra_state' and form_data.gst_type is not defined) %}selected{% endif %}>Intra-State (CGST + SGST)</option>
                        <option value="inter_state" {% if (form_data.gst_type is defined and form_data.gst_type == 'inter_state') or (artwork.gst_type == 'inter_state' and form_data.gst_type is not defined) %}selected{% endif %}>Inter-State (IGST)</option>
                        <option value="union_territory" {% if (form_data.gst_type is defined and form_data.gst_type == 'union_territory') or (artwork.gst_type == 'union_territory' and form_data.gst_type is not defined) %}selected{% endif %}>Union Territory (CGST + UGST)</option>
                    </select>
                </div>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="cgst_percentage" class="form-label">CGST (%)</label>
                        <input type="number" class="form-control" id="cgst_percentage" name="cgst_percentage" step="0.01" min="0" max="100" value="{{ form_data.cgst_percentage if form_data.cgst_percentage is defined else artwork.cgst_percentage }}" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="sgst_percentage" class="form-label">SGST (%)</label>
                        <input type="number" class="form-control" id="sgst_percentage" name="sgst_percentage" step="0.01" min="0" max="100" value="{{ form_data.sgst_percentage if form_data.sgst_percentage is defined else artwork.sgst_percentage }}" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="igst_percentage" class="form-label">IGST (%)</label>
                        <input type="number" class="form-control" id="igst_percentage" name="igst_percentage" step="0.01" min="0" max="100" value="{{ form_data.igst_percentage if form_data.igst_percentage is defined else artwork.igst_percentage }}" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="ugst_percentage" class="form-label">UGST (%)</label>
                        <input type="number" class="form-control" id="ugst_percentage" name="ugst_percentage" step="0.01" min="0" max="100" value="{{ form_data.ugst_percentage if form_data.ugst_percentage is defined else artwork.ugst_percentage }}" required>
                    </div>
                </div>

                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="is_featured" name="is_featured" {% if (form_data.is_featured is defined and form_data.is_featured) or (artwork.is_featured and form_data.is_featured is not defined) %}checked{% endif %}>
                    <label class="form-check-label" for="is_featured">Mark as Featured Artwork</label>
                </div>

                <h5 class="mt-4 mb-3">Artwork Images</h5>
                <div class="mb-3">
                    <label class="form-label">Current Images</label>
                    <div class="d-flex flex-wrap gap-2 mb-3" id="current-images-preview">
                        {% for image_path in artwork.get_images_list() %}
                        <div class="position-relative">
                            <img src="{{ image_path }}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover; border-radius: 0.5rem;">
                            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 rounded-circle p-1 remove-image-btn" data-image-path="{{ image_path }}" style="transform: translate(25%, -25%);">
                                <i class="fas fa-times"></i>
                            </button>
                            <input type="hidden" name="images_to_keep" value="{{ image_path }}">
                        </div>
                        {% else %}
                        <p class="text-muted">No images uploaded yet.</p>
                        {% endfor %}
                    </div>
                    <label for="new_images" class="form-label">Upload New Images (Multiple allowed, existing will be kept unless removed)</label>
                    <input type="file" class="form-control" id="new_images" name="new_images" accept="image/*" multiple>
                </div>

                <h5 class="mt-4 mb-3">Custom Options (e.g., Size, Frame)</h5>
                <div id="custom-options-builder" class="mb-3 p-3 border rounded bg-light">
                    <!-- Custom options will be added here dynamically -->
                    <button type="button" class="btn btn-secondary btn-sm" id="add-option-group-btn"><i class="fas fa-plus me-2"></i>Add Option Group</button>
                    <input type="hidden" name="custom_options_json" id="custom_options_json">
                </div>

                <button type="submit" class="btn btn-primary btn-lg mt-4"><i class="fas fa-save me-2"></i>Update Artwork</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addOptionGroupBtn = document.getElementById('add-option-group-btn');
        const customOptionsBuilder = document.getElementById('custom-options-builder');
        const customOptionsJsonInput = document.getElementById('custom_options_json');

        let optionGroups = {}; // Stores the structure: { "Size": {"Small": 0, "Medium": 100}, "Frame": {"None": 0, "Wood": 500} }

        // Function to render/re-render the custom options UI
        function renderOptionGroups() {
            // Clear existing UI elements, but keep the "Add Option Group" button
            const existingGroups = customOptionsBuilder.querySelectorAll('.option-group-card');
            existingGroups.forEach(group => group.remove());

            for (const groupName in optionGroups) {
                if (optionGroups.hasOwnProperty(groupName)) {
                    addOptionGroupUI(groupName, optionGroups[groupName]);
                }
            }
            updateCustomOptionsJson(); // Update hidden input after rendering
        }

        // Function to add a single option group UI
        function addOptionGroupUI(groupName = '', options = {}) {
            const groupId = `group-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`; // Unique ID for this group

            const groupCard = document.createElement('div');
            groupCard.className = 'option-group-card border rounded p-3 mb-3 bg-white shadow-sm';
            groupCard.id = groupId;
            groupCard.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <input type="text" class="form-control form-control-sm w-50" placeholder="Option Group Name (e.g., Size)" value="${groupName}" data-group-id="${groupId}" data-old-group-name="${groupName}" onchange="updateOptionGroupName(this)">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeOptionGroup('${groupId}')"><i class="fas fa-times me-2"></i>Remove Group</button>
                </div>
                <div class="options-list space-y-2">
                    <!-- Options for this group will go here -->
                </div>
                <button type="button" class="btn btn-success btn-sm mt-3" onclick="addOptionToGroup('${groupId}')"><i class="fas fa-plus me-2"></i>Add Option</button>
            `;
            
            // Insert before the "Add Option Group" button
            customOptionsBuilder.insertBefore(groupCard, addOptionGroupBtn);

            // Populate options within this group
            const optionsListDiv = groupCard.querySelector('.options-list');
            for (const optionLabel in options) {
                if (options.hasOwnProperty(optionLabel)) {
                    addOptionUI(groupId, optionsListDiv, optionLabel, options[optionLabel]);
                }
            }

            // If it's a new group, add a default option
            if (Object.keys(options).length === 0) {
                addOptionUI(groupId, optionsListDiv);
            }
        }

        // Function to add a single option UI to a group
        function addOptionUI(groupId, optionsListDiv, optionLabel = '', optionPrice = '0') {
            const optionId = `option-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;

            const optionRow = document.createElement('div');
            optionRow.className = 'input-group input-group-sm';
            optionRow.id = optionId;
            optionRow.innerHTML = `
                <input type="text" class="form-control" placeholder="Option Label (e.g., Small)" value="${optionLabel}" data-old-label="${optionLabel}" onchange="updateOptionData('${groupId}', '${optionId}', 'label', this.value)">
                <input type="number" class="form-control" placeholder="Price Add (e.g., 100)" step="0.01" min="0" value="${optionPrice}" onchange="updateOptionData('${groupId}', '${optionId}', 'price', this.value)">
                <button type="button" class="btn btn-outline-danger" onclick="removeOption('${groupId}', '${optionId}')"><i class="fas fa-minus"></i></button>
            `;
            optionsListDiv.appendChild(optionRow);

            // Add to internal data structure if it's a new option
            // This part is crucial for initial load and new additions
            const groupNameInput = document.querySelector(`.option-group-card[id="${groupId}"] input[data-group-id="${groupId}"]`);
            const currentGroupName = groupNameInput ? groupNameInput.value : '';
            if (currentGroupName) {
                if (!optionGroups[currentGroupName]) {
                    optionGroups[currentGroupName] = {};
                }
                optionGroups[currentGroupName][optionLabel] = parseFloat(optionPrice);
            }
            updateCustomOptionsJson();
        }

        // Event listener for "Add Option Group" button
        addOptionGroupBtn.addEventListener('click', function() {
            const newGroupName = `New Group ${Object.keys(optionGroups).length + 1}`;
            optionGroups[newGroupName] = {}; // Add to data structure
            addOptionGroupUI(newGroupName, {}); // Render UI
            updateCustomOptionsJson();
        });

        // Functions to manage data structure and UI removal
        window.updateOptionGroupName = function(inputElement) {
            const oldGroupName = inputElement.dataset.oldGroupName;
            const newGroupName = inputElement.value;
            const groupId = inputElement.dataset.groupId;

            if (!newGroupName) {
                showCustomAlert('Option group name cannot be empty.', 'danger');
                inputElement.value = oldGroupName; // Revert
                return;
            }

            // Ensure new group name is unique (case-sensitive for simplicity, can be made case-insensitive)
            if (newGroupName !== oldGroupName && optionGroups.hasOwnProperty(newGroupName)) {
                showCustomAlert('Option group name must be unique.', 'danger');
                inputElement.value = oldGroupName; // Revert to old name
                return;
            }

            if (oldGroupName in optionGroups) {
                const options = optionGroups[oldGroupName];
                delete optionGroups[oldGroupName];
                optionGroups[newGroupName] = options;
            } else {
                // This case should ideally not happen if oldGroupName is always set correctly
                optionGroups[newGroupName] = {}; 
            }
            inputElement.dataset.oldGroupName = newGroupName; // Update old name for next change
            updateCustomOptionsJson();
        };

        window.removeOptionGroup = function(groupId) {
            const groupCard = document.getElementById(groupId);
            const groupNameInput = groupCard.querySelector('input[data-group-id]');
            const groupName = groupNameInput.value;

            if (groupName in optionGroups) {
                delete optionGroups[groupName];
            }
            groupCard.remove();
            updateCustomOptionsJson();
        };

        window.addOptionToGroup = function(groupId) {
            const groupCard = document.getElementById(groupId);
            const optionsListDiv = groupCard.querySelector('.options-list');
            addOptionUI(groupId, optionsListDiv);
        };

        window.updateOptionData = function(groupId, optionId, type, value) {
            const groupCard = document.getElementById(groupId);
            const groupNameInput = groupCard.querySelector('input[data-group-id]');
            const groupName = groupNameInput.value;

            const optionRow = document.getElementById(optionId);
            const labelInput = optionRow.querySelector('input[type="text"]');
            const priceInput = optionRow.querySelector('input[type="number"]');

            const currentLabel = labelInput.value;
            const currentPrice = parseFloat(priceInput.value) || 0;

            if (!optionGroups[groupName]) {
                optionGroups[groupName] = {};
            }

            // Remove old entry if label changed
            if (type === 'label' && labelInput.dataset.oldLabel in optionGroups[groupName]) {
                delete optionGroups[groupName][labelInput.dataset.oldLabel];
            }

            // Update the data structure
            if (type === 'label') {
                if (!value) {
                    showCustomAlert('Option label cannot be empty.', 'danger');
                    labelInput.value = labelInput.dataset.oldLabel; // Revert
                    return;
                }
                optionGroups[groupName][value] = currentPrice;
                labelInput.dataset.oldLabel = value; // Store new label as old for next change
            } else if (type === 'price') {
                optionGroups[groupName][currentLabel] = parseFloat(value) || 0;
            }
            updateCustomOptionsJson();
        };

        window.removeOption = function(groupId, optionId) {
            const groupCard = document.getElementById(groupId);
            const groupNameInput = groupCard.querySelector('input[data-group-id]');
            const groupName = groupNameInput.value;

            const optionRow = document.getElementById(optionId);
            const labelInput = optionRow.querySelector('input[type="text"]');
            const optionLabel = labelInput.value;

            if (optionGroups[groupName] && optionGroups[groupName].hasOwnProperty(optionLabel)) {
                delete optionGroups[groupName][optionLabel];
            }
            optionRow.remove();
            updateCustomOptionsJson();
        };

        function updateCustomOptionsJson() {
            customOptionsJsonInput.value = JSON.stringify(optionGroups);
        }

        // Initialize with any existing custom options from form_data (for re-rendering on error)
        // or from artwork.get_custom_options_dict() (for initial GET request)
        const initialCustomOptions = {{ form_data.custom_option_groups | default(artwork.get_custom_options_dict()) | tojson | safe }};
        if (Object.keys(initialCustomOptions).length > 0) {
            optionGroups = initialCustomOptions;
            renderOptionGroups();
        }

        // --- Image Removal Logic ---
        document.querySelectorAll('.remove-image-btn').forEach(button => {
            button.addEventListener('click', function() {
                const imageContainer = this.closest('.position-relative');
                const imagePathInput = imageContainer.querySelector('input[name="images_to_keep"]');
                if (imagePathInput) {
                    imagePathInput.remove(); // Remove the hidden input so this image is not kept
                }
                imageContainer.remove(); // Remove the image preview from UI
                showCustomAlert('Image marked for removal on save.', 'info');
            });
        });
    });
</script>
{% endblock %}
