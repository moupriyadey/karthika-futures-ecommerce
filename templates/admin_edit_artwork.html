{% extends '_base.html' %}

{% block title %}Edit Artwork - Karthika Futures{% endblock %}

{% block content %}
<div class="container main-content-area py-4">
    <h2 class="text-center mb-4">Edit Artwork: {{ artwork.name }} (SKU: {{ artwork.sku }})</h2>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm border-0 rounded-lg p-4">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('edit_artwork', sku=artwork.sku) }}" enctype="multipart/form-data" id="artworkEditForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="mb-3">
                            <label for="sku" class="form-label">SKU</label>
                            <input type="text" class="form-control" id="sku" name="sku" value="{{ artwork.sku }}" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="name" class="form-label">Artwork Name</label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ form_data.name or '' }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="category_id" class="form-label">Category</label>
                            <select class="form-select" id="category_id" name="category_id" required>
                                <option value="">Select a Category</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}" {% if form_data.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="is_featured" name="is_featured" {% if form_data.is_featured %}checked{% endif %}>
                            <label class="form-check-label" for="is_featured">Featured Artwork</label>
                        </div>
                        <div class="mb-3">
                            <label for="original_price" class="form-label">Original Price (â‚¹)</label>
                            <input type="number" step="0.01" class="form-control" id="original_price" name="original_price" value="{{ form_data.original_price | floatformat(2) }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="gst_percentage" class="form-label">GST Percentage (%)</label>
                            <input type="number" step="0.01" class="form-control" id="gst_percentage" name="gst_percentage" value="{{ form_data.gst_percentage | floatformat(2) }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="stock" class="form-label">Stock Quantity</label>
                            <input type="number" class="form-control" id="stock" name="stock" value="{{ form_data.stock }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="4">{{ form_data.description or '' }}</textarea>
                        </div>

                        <hr class="my-4">
                        <h4>Custom Options</h4>
                        <p class="text-muted">Define groups of options (e.g., "Material") and their labels with additional prices (e.g., "Wood: +500").</p>
                        
                        <div id="customOptionsContainer">
                            {# Existing/repopulated custom option groups will be rendered here by JS #}
                            {% if form_data.custom_option_groups %}
                                {% for group in form_data.custom_option_groups %}
                                    <div class="custom-option-group border p-3 mb-3 rounded" data-group-index="{{ loop.index0 }}">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <input type="text" class="form-control me-2" name="option_group_name_{{ loop.index0 }}" placeholder="Option Group Name (e.g., Material)" value="{{ group.group_name }}" required>
                                            <button type="button" class="btn btn-danger btn-sm remove-group-btn">&times;</button>
                                        </div>
                                        <div class="custom-options-list">
                                            {% for option in group.options %}
                                                <div class="input-group mb-2" data-option-index="{{ loop.index0 }}">
                                                    <input type="text" class="form-control" name="option_label_{{ loop.parent.loop.index0 }}_{{ loop.index0 }}" placeholder="Option Label (e.g., Canvas)" value="{{ option.label || '' }}" required>
                                                    <input type="number" step="0.01" class="form-control" name="option_price_{{ loop.parent.loop.index0 }}_{{ loop.index0 }}" placeholder="Price (e.g., 500)" value="{{ option.price | floatformat(2) }}" required>
                                                    <button type="button" class="btn btn-outline-danger remove-option-btn">&times;</button>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-primary add-option-btn mt-2" data-group-index="{{ loop.index0 }}">Add Option</button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-secondary mt-3" id="addOptionGroupBtn">Add Option Group</button>

                        <hr class="my-4">
                        <h4>Artwork Images</h4>
                        <div class="mb-3">
                            <label for="new_images" class="form-label">Upload New Images (multiple allowed)</label>
                            <input type="file" class="form-control" id="new_images" name="new_images" accept="image/*" multiple>
                        </div>
                        <div class="mb-3">
                            <p class="form-label">Current Images:</p>
                            <div id="currentImagesPreview" class="d-flex flex-wrap gap-2">
                                {% for image_path in artwork.get_images_list() %}
                                <div class="position-relative border rounded p-1" style="width: 100px; height: 100px;">
                                    <img src="{{ url_for('static', filename=image_path) }}" class="img-fluid rounded" style="object-fit: cover; width: 100%; height: 100%;" alt="Artwork Image">
                                    <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 rounded-circle p-0" style="width: 20px; height: 20px; font-size: 0.7rem; line-height: 1; z-index: 10;" data-image-path="{{ image_path }}" onclick="removeImage(this)">
                                        &times;
                                    </button>
                                    <input type="hidden" name="images_to_keep" value="{{ image_path }}">
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">Update Artwork</button>
                            <a href="{{ url_for('admin_artworks_view') }}" class="btn btn-outline-secondary btn-lg">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function removeImage(button) {
        const imageDiv = button.closest('div');
        imageDiv.remove();
    }

    document.addEventListener('DOMContentLoaded', function() {
        const customOptionsContainer = document.getElementById('customOptionsContainer');
        const addOptionGroupBtn = document.getElementById('addOptionGroupBtn');
        let groupIndexCounter = customOptionsContainer.children.length; // Start counter from existing groups

        function addOptionGroup(groupName = '', options = []) {
            const newGroupDiv = document.createElement('div');
            newGroupDiv.className = 'custom-option-group border p-3 mb-3 rounded';
            newGroupDiv.dataset.groupIndex = groupIndexCounter;
            
            let optionsHtml = '';
            if (options.length > 0) {
                options.forEach((option, optionIdx) => {
                    optionsHtml += `
                        <div class="input-group mb-2" data-option-index="${optionIdx}">
                            <input type="text" class="form-control" name="option_label_${groupIndexCounter}_${optionIdx}" placeholder="Option Label (e.g., Canvas)" value="${option.label || ''}" required>
                            <input type="number" step="0.01" class="form-control" name="option_price_${groupIndexCounter}_${optionIdx}" placeholder="Price (e.g., 500)" value="${option.price || '0.00'}" required>
                            <button type="button" class="btn btn-outline-danger remove-option-btn">&times;</button>
                        </div>
                    `;
                });
            } else {
                // Add one empty option by default if no options are passed
                optionsHtml = `
                    <div class="input-group mb-2" data-option-index="0">
                        <input type="text" class="form-control" name="option_label_${groupIndexCounter}_0" placeholder="Option Label (e.g., Canvas)" required>
                        <input type="number" step="0.01" class="form-control" name="option_price_${groupIndexCounter}_0" placeholder="Price (e.g., 500)" value="0.00" required>
                        <button type="button" class="btn btn-outline-danger remove-option-btn">&times;</button>
                    </div>
                `;
            }

            newGroupDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control me-2" name="option_group_name_${groupIndexCounter}" placeholder="Option Group Name (e.g., Material)" value="${groupName}" required>
                    <button type="button" class="btn btn-danger btn-sm remove-group-btn">&times;</button>
                </div>
                <div class="custom-options-list">
                    ${optionsHtml}
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary add-option-btn mt-2" data-group-index="${groupIndexCounter}">Add Option</button>
            `;
            customOptionsContainer.appendChild(newGroupDiv);
            groupIndexCounter++;
            attachEventListeners(); // Re-attach listeners for new elements
        }

        function addOption(groupDiv, optionLabel = '', optionPrice = '0.00') {
            const groupIndex = groupDiv.dataset.groupIndex;
            const optionsList = groupDiv.querySelector('.custom-options-list');
            let optionIndex = optionsList.children.length; // Get next option index for this group

            const newOptionDiv = document.createElement('div');
            newOptionDiv.className = 'input-group mb-2';
            newOptionDiv.dataset.optionIndex = optionIndex;
            newOptionDiv.innerHTML = `
                <input type="text" class="form-control" name="option_label_${groupIndex}_${optionIndex}" placeholder="Option Label (e.g., Canvas)" value="${optionLabel}" required>
                <input type="number" step="0.01" class="form-control" name="option_price_${groupIndex}_${optionIndex}" placeholder="Price (e.g., 500)" value="${optionPrice}" required>
                <button type="button" class="btn btn-outline-danger remove-option-btn">&times;</button>
            `;
            optionsList.appendChild(newOptionDiv);
            attachEventListeners(); // Re-attach listeners for new elements
        }

        function attachEventListeners() {
            document.querySelectorAll('.remove-group-btn').forEach(button => {
                button.onclick = (e) => {
                    e.target.closest('.custom-option-group').remove();
                };
            });

            document.querySelectorAll('.add-option-btn').forEach(button => {
                button.onclick = (e) => {
                    const groupDiv = e.target.closest('.custom-option-group');
                    addOption(groupDiv);
                };
            });

            document.querySelectorAll('.remove-option-btn').forEach(button => {
                button.onclick = (e) => {
                    e.target.closest('.input-group').remove();
                };
            });
        }

        addOptionGroupBtn.addEventListener('click', () => addOptionGroup());
        attachEventListeners(); // Attach for initially loaded elements

        // Repopulate existing options on page load if form_data is available
        {% if form_data.custom_option_groups %}
            // Clear any default empty group added by Jinja if repopulating
            customOptionsContainer.innerHTML = ''; 
            groupIndexCounter = 0; // Reset counter for repopulation
            {% for group in form_data.custom_option_groups %}
                addOptionGroup('{{ group.group_name | js_string }}', [
                    {% for option in group.options %}
                        { label: '{{ option.label | js_string }}', price: '{{ option.price | floatformat(2) }}' },
                    {% endfor %}
                ]);
            {% endfor %}
        {% endif %}
    });
</script>
{% endblock %}
