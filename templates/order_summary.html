{% extends '_base.html' %}

{% block title %}Order Summary #{{ order.id }} - Karthika Futures{% endblock %}

{% block content %}
<!-- Payment screenshot modal CSS -->
<style>
  .modal-img-preview {
    max-width: 100%;
    height: auto;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
</style>

<div class="container mx-auto px-3 py-4 main-content-area">
  <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-4">Order #{{ order.id }}</h1>

  <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
    <div class="space-y-4">
      <div>
        <h2 class="text-xl font-semibold text-gray-800 border-b pb-1 mb-2">Order Details</h2>
        <ul class="text-sm text-gray-700 space-y-1">
          <li><strong>Date:</strong> {{ order.order_date.strftime('%d %b %Y, %I:%M %p') }}</li>
          <li><strong>Status:</strong> 
            <span class="inline-block px-2 py-0.5 rounded text-xs font-medium
              {% if order.status == 'Delivered' %}bg-green-100 text-green-700
              {% elif order.status == 'Shipped' %}bg-blue-100 text-blue-700
              {% elif 'Payment' in order.status %}bg-yellow-100 text-yellow-700
              {% elif 'Cancelled' in order.status %}bg-red-100 text-red-700
              {% else %}bg-gray-100 text-gray-800{% endif %}">
              {{ order.status }}
            </span>
          </li>
          <li><strong>Payment:</strong> 
            <span class="inline-block px-2 py-0.5 rounded text-xs font-medium
              {% if order.payment_status == 'completed' %}bg-green-100 text-green-700
              {% elif order.payment_status == 'pending' %}bg-yellow-100 text-yellow-700
              {% elif order.payment_status == 'failed' %}bg-red-100 text-red-700
              {% else %}bg-gray-100 text-gray-800{% endif %}">
              {{ order.payment_status | capitalize }}
            </span>
          </li>
          {% if order.courier %}<li><strong>Courier:</strong> {{ order.courier }}</li>{% endif %}
          {% if order.tracking_number %}<li><strong>Tracking #:</strong> {{ order.tracking_number }}</li>{% endif %}

          {% if order.remark %}
            <li><strong>Admin Remark:</strong> {{ order.remark.split('Screenshot:')[0] }}</li>
            {% set screenshot_path = order.remark.split('Screenshot:')[-1].strip() %}
            {% if screenshot_path %}
              <li><strong>Payment Screenshot:</strong><br>
                <!-- Thumbnail -->
                <img src="{{ url_for('static', filename=screenshot_path) }}"
                     alt="Payment Screenshot"
                     class="cursor-pointer border rounded"
                     style="max-width: 120px; height: auto; margin-top: 8px;"
                     data-bs-toggle="modal"
                     data-bs-target="#screenshotModal">
              </li>
            {% endif %}
          {% endif %}

          {% if order.cancellation_reason %}
            <li class="text-red-700"><strong>Cancelled:</strong> {{ order.cancellation_reason }}</li>
          {% endif %}
        </ul>
      </div>

      <div>
        <h2 class="text-xl font-semibold text-gray-800 border-b pb-1 mb-2">Shipping Address</h2>
        <ul class="text-sm text-gray-700 space-y-1">
          <li class="font-semibold">{{ order.shipping_address.full_name }}</li>
          <li>{{ order.shipping_address.address_line1 }}</li>
          {% if order.shipping_address.address_line2 %}
            <li>{{ order.shipping_address.address_line2 }}</li>
          {% endif %}
          <li>{{ order.shipping_address.city }}, {{ order.shipping_address.state }} - {{ order.shipping_address.pincode }}</li>
          <li>Phone: {{ order.shipping_address.phone }}</li>
        </ul>
      </div>
    </div>

    <h2 class="text-xl font-semibold text-gray-800 mt-6 border-b pb-1 mb-2">Items in Order</h2>
    <div class="space-y-4">
      {% for item in order.items %}
        <div class="flex items-start gap-3 border rounded-md p-3">
          <img src="{{ url_for('static', filename=item.artwork.get_images_list()[0] if item.artwork.get_images_list() else 'images/placeholder.png') }}" alt="{{ item.artwork.name }}" class="w-20 h-20 rounded object-cover">
          <div class="flex-1 text-sm text-gray-700 space-y-1">
            <p class="font-semibold text-base text-gray-900">{{ item.artwork.name }}</p>
            <p class="text-xs text-gray-500">SKU: {{ item.artwork.sku }}</p>
            {% if item.get_selected_options_dict() %}
              {% for group, option in item.get_selected_options_dict().items() %}
                <p>{{ group }}: {{ option }}</p>
              {% endfor %}
            {% endif %}
            <p>Qty: {{ item.quantity }}</p>
            <p>Unit Price: {{ (item.total_price_incl_gst / item.quantity) | currency }}</p>
            <p class="font-bold">Total: {{ item.total_price_incl_gst | currency }}</p>
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="mt-6 bg-gray-50 p-4 rounded-lg shadow-inner text-sm text-gray-800">
      <h3 class="text-lg font-bold border-b pb-2 mb-2">Payment Summary</h3>
      <div class="flex justify-between py-1">
        <span>Subtotal (Excl. GST):</span>
        <span>
          {% set order_subtotal_before_gst = 0 %}
          {% for item in order.items %}
            {% set order_subtotal_before_gst = order_subtotal_before_gst + item.total_price_before_gst %}
          {% endfor %}
          {{ order_subtotal_before_gst | currency }}
        </span>
      </div>
      <div class="flex justify-between py-1">
        <span>Shipping Charge:</span>
        <span>{{ order.shipping_charge | currency }}</span>
      </div>
      <div class="flex justify-between py-2 text-lg font-bold">
        <span>Grand Total:</span>
        <span class="text-primary text-xl">{{ order.total_amount | currency }}</span>
      </div>

      {% if order.status == 'Pending Payment' %}
        <a href="{{ url_for('payment_initiate', order_id=order.id, amount=order.total_amount) }}" class="btn btn-primary w-full mt-4 py-2 text-center text-sm">Proceed to Payment</a>
      {% else %}
        <div class="mt-4 space-y-2">
          <a href="{{ url_for('thank_you_page', order_id=order.id) }}" class="btn btn-primary w-full text-sm">View Order Confirmation</a>
          <a href="{{ url_for('all_products') }}" class="btn btn-outline-secondary w-full text-sm">Continue Shopping</a>
          <a href="{{ url_for('user_orders') }}" class="btn btn-outline-secondary w-full text-sm">Go to My Orders</a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Screenshot Modal (placed at end for Bootstrap compatibility) -->
<div class="modal fade" id="screenshotModal" tabindex="-1" aria-labelledby="screenshotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content bg-dark">
      <div class="modal-body text-center">
        <img src="{{ url_for('static', filename=screenshot_path) }}" class="modal-img-preview" alt="Full Screenshot">
      </div>
    </div>
  </div>
</div>
{% endblock %}
