{% extends '_base.html' %}

{% block title %}Admin Dashboard - Karthika Futures{% endblock %}

{% block content %}
<div class="container-fluid py-4 main-content-area">
    <h2 class="mb-4 text-center">Admin Dashboard</h2>

    {% include 'admin_navbar.html' %}

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Total Orders</h5>
                    <p class="card-text fs-3">{{ total_orders }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Total Revenue</h5>
                    <p class="card-text fs-3">₹{{ total_revenue | floatformat(2) }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Total Artworks</h5>
                    <p class="card-text fs-3">{{ total_artworks }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Total Users</h5>
                    <p class="card-text fs-3">{{ total_users }}</p>
                </div>
            </div>
        </div>
    </div>

    {# Charts Section #}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header">Monthly Revenue</div>
                <div class="card-body">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header">Stock Status</div>
                <div class="card-body">
                    <p><strong>Low Stock ( &lt;= 10):</strong></p>
                    {% if low_stock_artworks %}
                    <ul class="list-group list-group-flush">
                        {% for artwork in low_stock_artworks %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ artwork.name }} (SKU: {{ artwork.sku }})
                            <span class="badge bg-warning rounded-pill">{{ artwork.stock }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>No artworks currently in low stock.</p>
                    {% endif %}

                    <p class="mt-3"><strong>Out of Stock (0):</strong></p>
                    {% if out_of_stock_artworks %}
                    <ul class="list-group list-group-flush">
                        {% for artwork in out_of_stock_artworks %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ artwork.name }} (SKU: {{ artwork.sku }})
                            <span class="badge bg-danger rounded-pill">{{ artwork.stock }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>No artworks currently out of stock.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Orders Pending Review #}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">Orders Pending Payment Verification or Held Invoices</h5>
        </div>
        <div class="card-body">
            {% if orders_pending_review %}
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Invoice Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders_pending_review %}
                        <tr>
                            <td>{{ order.id }}</td>
                            <td>{{ order.customer_name }} ({{ order.customer_email }})</td>
                            <td>₹{{ order.total_amount | floatformat(2) }}</td>
                            <td><span class="badge bg-warning text-dark">{{ order.status }}</span></td>
                            <td>
                                {% set invoice_det = order.get_invoice_details() %}
                                {% if invoice_det.is_held_by_admin %}
                                <span class="badge bg-danger">Held by Admin</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ invoice_det.invoice_status or 'N/A' }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('admin_edit_invoice', order_id=order.id) }}" class="btn btn-sm btn-info me-2">Manage Invoice</a>
                                {% if order.status == 'Payment Submitted - Awaiting Verification' %}
                                <button type="button" class="btn btn-sm btn-success verify-payment-btn" data-order-id="{{ order.id }}">Verify Payment</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center">No orders currently pending review.</p>
            {% endif %}
        </div>
    </div>

    {# All Orders Section #}
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">All Orders</h5>
        </div>
        <div class="card-body">
            <form class="row g-3 mb-3" action="{{ url_for('admin_dashboard') }}" method="GET">
                <div class="col-md-4">
                    <input type="text" class="form-control" name="search" placeholder="Search by Order ID, Customer Name, Email" value="{{ search_query }}">
                </div>
                <div class="col-md-4">
                    <select class="form-select" name="filter_status">
                        <option value="">All Statuses</option>
                        <option value="Pending Payment" {% if filter_status == 'Pending Payment' %}selected{% endif %}>Pending Payment</option>
                        <option value="Payment Submitted - Awaiting Verification" {% if filter_status == 'Payment Submitted - Awaiting Verification' %}selected{% endif %}>Payment Submitted - Awaiting Verification</option>
                        <option value="Payment Verified – Preparing Order" {% if filter_status == 'Payment Verified – Preparing Order' %}selected{% endif %}>Payment Verified – Preparing Order</option>
                        <option value="Shipped" {% if filter_status == 'Shipped' %}selected{% endif %}>Shipped</option>
                        <option value="Delivered" {% if filter_status == 'Delivered' %}selected{% endif %}>Delivered</option>
                        <option value="Cancelled by User" {% if filter_status == 'Cancelled by User' %}selected{% endif %}>Cancelled by User</option>
                        <option value="Cancelled by Admin" {% if filter_status == 'Cancelled by Admin' %}selected{% endif %}>Cancelled by Admin</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                </div>
                <div class="col-md-2">
                    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary w-100">Clear Filters</a>
                </div>
            </form>

            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Courier</th>
                            <th>Tracking ID</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>{{ order.id }}</td>
                            <td>{{ order.customer_name }} ({{ order.customer_email }})</td>
                            <td>{{ order.order_date.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>₹{{ order.total_amount | floatformat(2) }}</td>
                            <td><span class="badge {% if order.status == 'Delivered' %}bg-success{% elif order.status == 'Shipped' %}bg-primary{% elif 'Pending' in order.status or 'Awaiting' in order.status %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ order.status }}</span></td>
                            <td>{{ order.courier or 'N/A' }}</td>
                            <td>{{ order.tracking_number or 'N/A' }}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary edit-order-btn"
                                        data-bs-toggle="modal" data-bs-target="#editOrderModal"
                                        data-order-id="{{ order.id }}"
                                        data-current-status="{{ order.status }}"
                                        data-remark="{{ order.remark }}"
                                        data-courier="{{ order.courier }}"
                                        data-tracking-number="{{ order.tracking_number }}">
                                    Edit
                                </button>
                                <a href="{{ url_for('admin_edit_invoice', order_id=order.id) }}" class="btn btn-sm btn-info me-1">Invoice</a>
                                <a href="{{ url_for('delete_order', order_id=order.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this order? This action cannot be undone.');">Delete</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{# Edit Order Modal #}
<div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editOrderModalLabel">Edit Order Status & Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editOrderForm">
                    <input type="hidden" id="modal_order_id" name="order_id">
                    <div class="mb-3">
                        <label for="modal_status" class="form-label">Order Status</label>
                        <select class="form-select" id="modal_status" name="status" required>
                            <option value="Pending Payment">Pending Payment</option>
                            <option value="Payment Submitted - Awaiting Verification">Payment Submitted - Awaiting Verification</option>
                            <option value="Payment Verified – Preparing Order">Payment Verified – Preparing Order</option>
                            <option value="Shipped">Shipped</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Cancelled by User">Cancelled by User</option>
                            <option value="Cancelled by Admin">Cancelled by Admin</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="modal_remark" class="form-label">Remark</label>
                        <textarea class="form-control" id="modal_remark" name="remark" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="modal_courier" class="form-label">Courier Name</label>
                        <input type="text" class="form-control" id="modal_courier" name="courier">
                    </div>
                    <div class="mb-3">
                        <label for="modal_tracking_number" class="form-label">Tracking Number</label>
                        <input type="text" class="form-control" id="modal_tracking_number" name="tracking_number">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Chart.js for Monthly Revenue
        const ctx = document.getElementById('revenueChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ revenue_labels | tojson }},
                datasets: [{
                    label: 'Revenue (₹)',
                    data: {{ revenue_values | tojson }},
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Revenue (₹)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    }
                }
            }
        });

        // Helper function to get CSRF token
        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrfToken
            };
        }

        // Helper function to show custom alerts (copied for self-containment)
        function showCustomAlert(message, type = 'info') {
            const container = document.getElementById('flash-messages-container') || document.body;
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} flash-message position-fixed top-0 end-0 m-3 shadow`;
            alertDiv.style.zIndex = 9999;
            alertDiv.textContent = message;
            container.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // Edit Order Modal Logic
        const editOrderModal = document.getElementById('editOrderModal');
        editOrderModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const orderId = button.getAttribute('data-order-id');
            const currentStatus = button.getAttribute('data-current-status');
            const remark = button.getAttribute('data-remark');
            const courier = button.getAttribute('data-courier');
            const trackingNumber = button.getAttribute('data-tracking-number');

            const modalOrderId = editOrderModal.querySelector('#modal_order_id');
            const modalStatus = editOrderModal.querySelector('#modal_status');
            const modalRemark = editOrderModal.querySelector('#modal_remark');
            const modalCourier = editOrderModal.querySelector('#modal_courier');
            const modalTrackingNumber = editOrderModal.querySelector('#modal_tracking_number');

            modalOrderId.value = orderId;
            modalStatus.value = currentStatus;
            modalRemark.value = remark;
            modalCourier.value = courier;
            modalTrackingNumber.value = trackingNumber;
        });

        const editOrderForm = document.getElementById('editOrderForm');
        editOrderForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const orderId = document.getElementById('modal_order_id').value;
            const status = document.getElementById('modal_status').value;
            const remark = document.getElementById('modal_remark').value;
            const courier = document.getElementById('modal_courier').value;
            const tracking_number = document.getElementById('modal_tracking_number').value;

            try {
                const response = await fetch(`/admin/order/update_status/${orderId}`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ status, remark, courier, tracking_number })
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    showCustomAlert(data.message, 'success');
                    const modalInstance = bootstrap.Modal.getInstance(editOrderModal);
                    modalInstance.hide();
                    location.reload(); // Reload page to reflect changes
                } else {
                    showCustomAlert(data.message || 'Failed to update order.', 'danger');
                }
            } catch (error) {
                console.error('Error updating order:', error);
                showCustomAlert('An error occurred while updating the order.', 'danger');
            }
        });

        // Verify Payment Button Logic
        document.querySelectorAll('.verify-payment-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const orderId = this.dataset.orderId;
                if (confirm('Are you sure you want to mark this payment as verified?')) {
                    try {
                        const response = await fetch('/admin/verify-payment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-CSRFToken': window.csrfToken
                            },
                            body: new URLSearchParams({ order_id: orderId }).toString()
                        });
                        const data = await response.json();
                        if (response.ok && data.success) {
                            showCustomAlert(data.message, 'success');
                            location.reload();
                        } else {
                            showCustomAlert(data.message || 'Failed to verify payment.', 'danger');
                        }
                    } catch (error) {
                        console.error('Error verifying payment:', error);
                        showCustomAlert('An error occurred while verifying payment.', 'danger');
                    }
                }
            });
        });
    });
</script>
{% endblock %}
