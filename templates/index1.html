{% extends '_base.html' %}

{% block title %}Karthika Futures - Divine Art Store{% endblock %}

{% block extra_css %}
<style>
    /* General Container Styling */
    .section-container {
        padding: 3rem; /* Generous padding */
        border-radius: 1rem; /* More rounded corners */
        box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.08); /* Professional shadow */
        margin-bottom: 3rem; /* Space between sections */
        background-color: #ffffff; /* White background for sections */
        border: 1px solid #e0e0e0; /* Subtle border */
    }

    /* Section Headers */
    .section-container h2 {
        color: #333;
        font-weight: 700;
        margin-bottom: 2.5rem; /* More space below header */
        text-align: center;
        position: relative;
    }
    .section-container h2::after {
        content: '';
        display: block;
        width: 80px; /* Short underline */
        height: 4px;
        background-color: #28a745; /* Green accent */
        margin: 1rem auto 0;
        border-radius: 2px;
    }

    /* Artwork Card Styling */
    .card.artwork-card {
        border: none;
        border-radius: 0.75rem; /* Consistent rounded corners */
        overflow: hidden;
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        box-shadow: 0 0.25rem 1rem rgba(0,0,0,0.07); /* Subtle card shadow */
        height: 100%; /* Ensures uniform height */
        display: flex;
        flex-direction: column;
        background-color: #fcfcfc; /* Slightly off-white for card background */
    }
    .card.artwork-card:hover {
        transform: translateY(-8px); /* More pronounced lift on hover */
        box-shadow: 0 0.8rem 2rem rgba(0,0,0,0.15); /* Stronger shadow on hover */
    }
    .artwork-card img {
        width: 100%;
        height: 220px; /* Slightly increased image height */
        object-fit: cover;
        border-bottom: 1px solid #f0f0f0; /* Lighter border below image */
        border-top-left-radius: 0.75rem; /* Match card radius */
        border-top-right-radius: 0.75rem; /* Match card radius */
    }
    .card-body {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        padding: 1.5rem; /* More padding inside card body */
    }
    .card-title {
        font-size: 1.4rem; /* Larger title */
        font-weight: 600;
        color: #333;
        margin-bottom: 0.75rem;
    }
    .card-text {
        font-size: 1rem;
        color: #555;
        margin-bottom: 1rem;
    }
    .final-price {
        font-size: 1.75rem; /* Larger final price */
        font-weight: 700;
        color: #28a745; /* Prominent green */
        margin-top: 1rem;
        margin-bottom: 1rem;
    }
    .price-old {
        color: #999;
        font-size: 1rem;
        margin-right: 0.5rem;
    }

    /* Form Selects & Inputs within Cards */
    .form-select, .form-control {
        border-radius: 0.4rem; /* Rounded inputs */
        border: 1px solid #dee2e6;
        padding: 0.6rem 0.9rem;
        font-size: 0.9rem;
    }
    .form-select:focus, .form-control:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
    }
    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.4rem;
        font-size: 0.95rem;
    }
    .mb-2 {
        margin-bottom: 1.25rem !important; /* Increase space between form elements */
    }

    /* Buttons */
    .btn {
        font-weight: 600;
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease-in-out;
    }
    .add-to-cart-btn {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
    }
    .add-to-cart-btn:hover {
        background-color: #0056b3;
        border-color: #0056b3;
        transform: translateY(-2px);
    }
    .buy-now-btn {
        background-color: #28a745;
        border-color: #28a745;
        color: white;
    }
    .buy-now-btn:hover {
        background-color: #218838;
        border-color: #1e7e34;
        transform: translateY(-2px);
    }
    .d-grid.gap-2 {
        margin-top: 1.5rem; /* Space above buttons */
    }

    /* General responsive adjustments */
    @media (max-width: 767.98px) {
        .section-container {
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .section-container h2 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
        }
        .artwork-card img {
            height: 180px;
        }
        .card-body {
            padding: 1rem;
        }
        .card-title {
            font-size: 1.1rem;
        }
        .final-price {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 pt-5"> 

    {% macro render_artwork_section(title, artworks, section_index) %} 
    <section class="py-5 section-container"> {# Applied new container class #}
        <h2 class="fw-bold mb-4">{{ title }}</h2> 
        <div class="container"> 
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"> {# Changed to lg-3 for 3 columns on large screens #}
                {% for art in artworks %} 
                <div class="col"> 
                    <div class="card artwork-card shadow" data-artwork-id="{{ art.sku }}" data-art='{{ art | tojson | safe }}'> 
                        {% if art.image %}
                            <img src="{{ url_for('static', filename=art.image.replace('\\', '/')) }}" class="card-img-top" alt="{{ art.name }}"> 
                        {% else %}
                            <img src="https://placehold.co/400x220/cccccc/333333?text=No+Image" class="card-img-top" alt="No Image Available">
                        {% endif %}
                        <div class="card-body"> 
                            <h5 class="card-title">{{ art.name }}</h5> 
                            <p class="card-text">{{ art.description | truncate(100) }}</p> {# Truncate description #}
                            {# <p>SKU: <code>{{ art.sku }}</code></p> Removed SKU display from card body #}
                            <p class="mb-1"> 
                                {% if art.original_price and (art.size_a4 or art.frame_wooden or art.glass_price) %}
                                    <del class="price-old">‚Çπ{{ art.original_price | round(2) }}</del> 
                                {% endif %}
                                <span class="text-success fw-bold final-price">‚Çπ{{ (art.original_price | default(0) + art.size_a4 | default(0) + art.frame_wooden | default(0) + art.glass_price | default(0)) | round(2) }}</span> 
                            </p> 

                            <div class="mb-2"> 
                                <label class="form-label">Size</label> 
                                <select class="form-select size-select" data-art-sku="{{ art.sku }}"> 
                                    <option value="A4" {% if art.size_a4 %}data-price="{{ art.size_a4 }}"{% endif %}>A4 {% if art.size_a4 %}(+‚Çπ{{ art.size_a4 | round(2) }}){% endif %}</option> 
                                    <option value="A5" {% if art.size_a5 %}data-price="{{ art.size_a5 }}"{% endif %}>A5 {% if art.size_a5 %}(+‚Çπ{{ art.size_a5 | round(2) }}){% endif %}</option> 
                                    <option value="Letter" {% if art.size_letter %}data-price="{{ art.size_letter }}"{% endif %}>Letter {% if art.size_letter %}(+‚Çπ{{ art.size_letter | round(2) }}){% endif %}</option> 
                                    <option value="Legal" {% if art.size_legal %}data-price="{{ art.size_legal }}"{% endif %}>Legal {% if art.size_legal %}(+‚Çπ{{ art.size_legal | round(2) }}){% endif %}</option> 
                                </select> 
                            </div> 
                            <div class="mb-2"> 
                                <label class="form-label">Frame</label> 
                                <select class="form-select frame-select" data-art-sku="{{ art.sku }}"> 
                                    <option value="None" data-price="0">None</option> 
                                    <option value="Wooden" {% if art.frame_wooden %}data-price="{{ art.frame_wooden }}"{% endif %}>Wooden {% if art.frame_wooden %}(+‚Çπ{{ art.frame_wooden | round(2) }}){% endif %}</option> 
                                    <option value="Metal" {% if art.frame_metal %}data-price="{{ art.frame_metal }}"{% endif %}>Metal {% if art.frame_metal %}(+‚Çπ{{ art.frame_metal | round(2) }}){% endif %}</option> 
                                    <option value="PVC" {% if art.frame_pvc %}data-price="{{ art.frame_pvc }}"{% endif %}>PVC {% if art.frame_pvc %}(+‚Çπ{{ art.frame_pvc | round(2) }}){% endif %}</option> 
                                </select> 
                            </div> 
                            <div class="mb-2"> 
                                <label class="form-label">Glass</label> 
                                <select class="form-select glass-select" data-art-sku="{{ art.sku }}"> 
                                    <option value="No" data-price="0">Without Glass</option> 
                                    <option value="Yes" {% if art.glass_price %}data-price="{{ art.glass_price }}"{% endif %}>With Glass {% if art.glass_price %}(+‚Çπ{{ art.glass_price | round(2) }}){% endif %}</option> 
                                </select> 
                            </div> 
                            <div class="mb-2"> 
                                <label class="form-label">Quantity</label> 
                                <input type="number" class="form-control quantity-input" value="1" min="1" max="{{ art.stock }}"> 
                            </div> 
                            <div class="d-grid gap-2 mt-auto"> {# mt-auto pushes buttons to bottom #}
                                <button class="btn btn-outline-primary add-to-cart-btn">üõí Add to Cart</button> 
                                <button class="btn btn-success buy-now-btn">Buy Now</button> 
                            </div> 
                        </div> 
                    </div> 
                </div> 
                {% endfor %} 
            </div> 
        </div> 
    </section> 
    {% endmacro %} 

    {{ render_artwork_section("üåü Popular Artworks", popular, 1) }} 
    {{ render_artwork_section("üèπ Ramayana", ramayana, 2) }} 
    {{ render_artwork_section("üõ°Ô∏è Mahabharata", mahabharata, 3) }} 
    {{ render_artwork_section("üìö Puranas", puranas, 4) }} 

</div> 
{% endblock %}

{% block extra_js %}
<script> 
    // Function to calculate final price based on selected options and quantity
    function calculateFinalPrice(artwork, size, frame, glass) {
        let price = Number(artwork.original_price || 0);

        if (size === "A4") price += Number(artwork.size_a4 || 0);
        else if (size === "A5") price += Number(artwork.size_a5 || 0);
        else if (size === "Letter") price += Number(artwork.size_letter || 0);
        else if (size === "Legal") price += Number(artwork.size_legal || 0);

        if (frame === "Wooden") price += Number(artwork.frame_wooden || 0);
        else if (frame === "Metal") price += Number(artwork.frame_metal || 0);
        else if (frame === "PVC") price += Number(artwork.frame_pvc || 0);

        if (glass === "Yes" || glass === "With Glass") {
            price += Number(artwork.glass_price || 0);
        }
        return price; // Return unit price for the given configuration
    }

    document.addEventListener('DOMContentLoaded', function () { 
        // Loop through each artwork card to attach event listeners 
        document.querySelectorAll('.artwork-card').forEach(card => { 
            const artwork = JSON.parse(card.dataset.art); // Get the full artwork object 
            const sizeSelect = card.querySelector('.size-select'); 
            const frameSelect = card.querySelector('.frame-select'); 
            const glassSelect = card.querySelector('.glass-select'); 
            const quantityInput = card.querySelector('.quantity-input'); 
            const finalPriceDisplay = card.querySelector('.final-price'); 
            const buyNowBtn = card.querySelector('.buy-now-btn'); 
            const addToCartBtn = card.querySelector('.add-to-cart-btn'); 

            function updatePriceDisplay() { 
                const selectedSize = sizeSelect.value; 
                const selectedFrame = frameSelect.value; 
                const selectedGlass = glassSelect.value; 
                const selectedQuantity = parseInt(quantityInput.value); 

                const unitPrice = calculateFinalPrice(artwork, selectedSize, selectedFrame, selectedGlass);
                const calculatedPrice = (unitPrice * selectedQuantity).toFixed(2);
                finalPriceDisplay.textContent = `‚Çπ${calculatedPrice}`; 
            } 

            // Attach event listeners for option changes 
            sizeSelect.addEventListener('change', updatePriceDisplay); 
            frameSelect.addEventListener('change', updatePriceDisplay); 
            glassSelect.addEventListener('change', updatePriceDisplay); 
            quantityInput.addEventListener('change', updatePriceDisplay); 
            quantityInput.addEventListener('input', updatePriceDisplay); // Update on input for quantity

            // Initial price update when the page loads for each card 
            updatePriceDisplay(); 

            // Buy Now button functionality 
            buyNowBtn.addEventListener('click', function () { 
                const selectedSize = sizeSelect.value; 
                const selectedFrame = frameSelect.value; 
                const selectedGlass = glassSelect.value; 
                const selectedQuantity = parseInt(quantityInput.value); 

                if (isNaN(selectedQuantity) || selectedQuantity < 1) {
                    flashMessage('Please enter a valid quantity (minimum 1).', 'danger');
                    quantityInput.value = 1; // Reset to 1
                    updatePriceDisplay(); // Recalculate price
                    return;
                }

                // Get unit price for the configured artwork
                const unitPriceForConfiguredArtwork = calculateFinalPrice(artwork, selectedSize, selectedFrame, selectedGlass);
                const totalPriceForOrderItem = unitPriceForConfiguredArtwork * selectedQuantity;

                // Prepare item for direct checkout (simulating a single-item cart)
                const itemToCheckout = {
                    id: artwork.sku, // Use SKU as ID for simplicity for this one item
                    name: artwork.name,
                    image: artwork.image,
                    size: selectedSize,
                    frame: selectedFrame,
                    glass: selectedGlass,
                    quantity: selectedQuantity,
                    unit_price: unitPriceForConfiguredArtwork,
                    total_price: totalPriceForOrderItem
                };

                // Create a temporary form to submit this single item to purchase-form
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("purchase_form") }}';

                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'cart_json'; // Send it as a list within cart_json
                hiddenInput.value = JSON.stringify([itemToCheckout]); // Wrap in an array for consistency

                form.appendChild(hiddenInput);
                document.body.appendChild(form);
                form.submit();
            }); 

            // Add to Cart button functionality 
            addToCartBtn.addEventListener('click', async function () { // Made async for syncCartToServer
                const selectedSize = sizeSelect.value; 
                const selectedFrame = frameSelect.value; 
                const selectedGlass = glassSelect.value; 
                const selectedQuantity = parseInt(quantityInput.value); 
                
                if (isNaN(selectedQuantity) || selectedQuantity < 1) {
                    flashMessage('Please enter a valid quantity (minimum 1).', 'danger');
                    quantityInput.value = 1; // Reset to 1
                    updatePriceDisplay(); // Recalculate price
                    return;
                }

                const unitPriceForConfiguredArtwork = calculateFinalPrice(artwork, selectedSize, selectedFrame, selectedGlass);
                const totalPriceForOrderItem = unitPriceForConfiguredArtwork * selectedQuantity;

                // Create a unique key for the item in sessionStorage based on SKU and selected options
                const itemKey = `${artwork.sku}-${selectedSize}-${selectedFrame}-${selectedGlass}`;

                const item = { 
                    id: itemKey, // Unique ID for this specific configuration of the artwork
                    sku: artwork.sku, 
                    name: artwork.name, 
                    image: artwork.image, 
                    size: selectedSize, 
                    frame: selectedFrame, 
                    glass: selectedGlass, 
                    quantity: selectedQuantity, 
                    unit_price: unitPriceForConfiguredArtwork,
                    total_price: totalPriceForOrderItem
                }; 

                let cart = JSON.parse(sessionStorage.getItem('cart') || '{}'); 
                
                // If item with this key already exists, update its quantity and total_price
                if (cart[item.id]) {
                    cart[item.id].quantity += item.quantity;
                    cart[item.id].total_price += item.total_price;
                    console.log("Updated existing item in cart:", cart[item.id]);
                } else {
                    // Add new item to the cart object
                    cart[item.id] = item;
                    console.log("Added new item to cart:", item);
                }

                sessionStorage.setItem('cart', JSON.stringify(cart)); 
                
                // Update cart count in the navbar (this function should be global in _base.html)
                if (typeof updateCartCountDisplay === 'function') {
                    updateCartCountDisplay();
                } else {
                    console.error("updateCartCountDisplay function not found.");
                }

                // Sync the updated cart to the server session via AJAX (this function should be global in _base.html)
                if (typeof syncCartToServer === 'function') {
                    await syncCartToServer();
                } else {
                    console.error("syncCartToServer function not found.");
                }

                // Show a Bootstrap toast notification (this function should be global in _base.html or defined here if not)
                if (typeof flashMessage === 'function') {
                    flashMessage(`‚úÖ "${artwork.name}" added to cart for ‚Çπ${totalPriceForOrderItem.toFixed(2)}`, 'success');
                } else {
                    console.error("flashMessage function not found.");
                }
            }); 
        }); 
    }); 
</script> 
{% endblock %}
