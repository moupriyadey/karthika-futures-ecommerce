{% extends '_base.html' %}

{% block title %}Admin Dashboard - Karthika Futures{% endblock %}

{% block content %}
<div class="container-fluid py-4 main-content-area">
    <h2 class="mb-4 text-center">Admin Dashboard</h2>

    {# Updated admin_navbar.html content directly here to fix the URL #}
    <nav class="nav nav-pills flex-column flex-sm-row bg-light p-3 rounded-lg shadow-sm mb-4">
        <a class="flex-sm-fill text-sm-center nav-link {% if request.endpoint == 'admin_dashboard' and not request.args.get('filter_status') and not request.args.get('search') %}active{% endif %}" href="{{ url_for('admin_dashboard') }}">Dashboard</a>
        <a class="flex-sm-fill text-sm-center nav-link {% if request.endpoint == 'admin_dashboard' and (request.args.get('filter_status') or request.args.get('search')) %}active{% endif %}" href="{{ url_for('admin_dashboard') }}">Orders</a> {# Changed endpoint to admin_dashboard #}
        <a class="flex-sm-fill text-sm-center nav-link {% if request.endpoint == 'admin_artworks' %}active{% endif %}" href="{{ url_for('admin_artworks') }}">Artworks</a>
        <a class="flex-sm-fill text-sm-center nav-link {% if request.endpoint == 'admin_categories' %}active{% endif %}" href="{{ url_for('admin_categories') }}">Categories</a>
        <a class="flex-sm-fill text-sm-center nav-link {% if request.endpoint == 'admin_users' %}active{% endif %}" href="{{ url_for('admin_users') }}">Users</a>
        <a class="flex-sm-fill text-sm-center nav-link" href="{{ url_for('user_logout') }}">Logout</a> {# Changed admin_logout to user_logout #}
    </nav>
    {# End of admin_navbar.html content #}

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3 shadow-sm rounded-lg">
                <div class="card-body">
                    <h5 class="card-title">Total Users</h5>
                    <p class="card-text fs-3">{{ total_users }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3 shadow-sm rounded-lg">
                <div class="card-body">
                    <h5 class="card-title">Total Revenue</h5>
                    <p class="card-text fs-3">{{ total_revenue | currency }}</p> {# Changed from floatformat to currency #}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3 shadow-sm rounded-lg">
                <div class="card-body">
                    <h5 class="card-title">Total Artworks</h5>
                    <p class="card-text fs-3">{{ total_artworks }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3 shadow-sm rounded-lg">
                <div class="card-body">
                    <h5 class="card-title">Orders Pending Review</h5>
                    <p class="card-text fs-3">{{ pending_orders }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8 mb-4">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Orders Pending Action</h4>
                    <a href="{{ url_for('admin_dashboard', filter_status='Payment Submitted - Awaiting Verification') }}" class="btn btn-sm btn-outline-primary">View All Pending</a>
                </div>
                <div class="card-body">
                    {% if orders_pending_review %}
                    <div class="table-responsive">
                        <table class="table table-hover table-striped align-middle">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in orders_pending_review %}
                                <tr>
                                    <td>{{ order.id[:8] }}...</td>
                                    <td>{{ order.customer.full_name or order.customer.email }}</td>
                                    <td>{{ order.total_amount | currency }}</td> {# Changed from floatformat to currency #}
                                    <td>
                                        <span class="badge bg-warning">{{ order.status }}</span>
                                    </td>
                                    <td>
                                        <a href="{{ url_for('order_summary', order_id=order.id) }}" class="btn btn-info btn-sm me-2">View</a>
                                        {% if order.status == 'Payment Submitted - Awaiting Verification' %}
                                        <button type="button" class="btn btn-success btn-sm verify-payment-btn" data-order-id="{{ order.id }}">Verify Payment</button>
                                        {% elif order.get_invoice_details().get('is_held_by_admin') %}
                                        <a href="{{ url_for('admin_edit_invoice', order_id=order.id) }}" class="btn btn-primary btn-sm">Review Invoice</a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center text-muted">No orders currently pending action.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Monthly Revenue</h4>
                </div>
                <div class="card-body">
                    <canvas id="monthlyRevenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Low Stock Artworks (< 10 units)</h4>
                </div>
                <div class="card-body">
                    {% if low_stock_artworks %}
                    <ul class="list-group list-group-flush">
                        {% for artwork in low_stock_artworks %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ artwork.name }} (SKU: {{ artwork.sku }})
                            <span class="badge bg-warning rounded-pill">{{ artwork.stock }} units</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-center text-muted">No artworks with low stock.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Out of Stock Artworks</h4>
                </div>
                <div class="card-body">
                    {% if out_of_stock_artworks %}
                    <ul class="list-group list-group-flush">
                        {% for artwork in out_of_stock_artworks %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ artwork.name }} (SKU: {{ artwork.sku }})
                            <span class="badge bg-danger rounded-pill">Out of Stock</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-center text-muted">No artworks currently out of stock.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Manage Products</h4>
                </div>
                <div class="card-body">
                    <p>Add, edit, or delete artworks and manage categories.</p>
                    <a href="{{ url_for('admin_artworks') }}" class="btn btn-primary me-2">Manage Artworks</a>
                    <a href="{{ url_for('admin_categories') }}" class="btn btn-secondary">Manage Categories</a>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Manage Users</h4>
                </div>
                <div class="card-body">
                    <p>View and manage user accounts.</p>
                    <a href="{{ url_for('admin_users') }}" class="btn btn-primary">View Users</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Verify Payment Button Logic ---
        document.querySelectorAll('.verify-payment-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const orderId = this.dataset.orderId;
                // Using a custom alert for confirmation instead of browser's confirm()
                showCustomAlert('Are you sure you want to mark this payment as verified? This action cannot be undone.', 'info', false); // No cart link needed

                // For simplicity, we'll proceed with AJAX call directly after showing alert.
                // In a real app, you might want a separate confirmation modal here.
                try {
                    const response = await fetch('/admin/verify-payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': window.csrfToken
                        },
                        body: new URLSearchParams({ order_id: orderId }).toString()
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        showCustomAlert(data.message, 'success');
                        location.reload(); // Reload to update dashboard
                    } else {
                        showCustomAlert(data.message || 'Failed to verify payment.', 'danger');
                    }
                } catch (error) {
                    console.error('Error verifying payment:', error);
                    showCustomAlert('An error occurred while verifying payment.', 'danger');
                }
            });
        });

        // --- Monthly Revenue Chart ---
        const ctx = document.getElementById('monthlyRevenueChart');
        if (ctx) {
            const revenueLabels = {{ revenue_labels | tojson }};
            const revenueValues = {{ revenue_values | tojson }};

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: revenueLabels,
                    datasets: [{
                        label: 'Revenue (₹)',
                        data: revenueValues,
                        backgroundColor: [
                            'rgba(255, 140, 0, 0.8)', // Saffron
                            'rgba(46, 139, 87, 0.8)', // Bright Green
                            'rgba(255, 165, 0, 0.8)', // Lighter Saffron
                            'rgba(60, 179, 113, 0.8)', // Lighter Green
                            'rgba(255, 191, 0, 0.8)', // Golden Saffron
                            'rgba(34, 139, 34, 0.8)'  // Forest Green
                        ],
                        borderColor: [
                            'rgba(255, 140, 0, 1)',
                            'rgba(46, 139, 87, 1)',
                            'rgba(255, 165, 0, 1)',
                            'rgba(60, 179, 113, 1)',
                            'rgba(255, 191, 0, 1)',
                            'rgba(34, 139, 34, 1)'
                        ],
                        borderWidth: 1,
                        borderRadius: 5 // Rounded bars
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Monthly Revenue',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#333'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Revenue (₹)',
                                color: '#555'
                            },
                            ticks: {
                                callback: function(value, index, ticks) {
                                    return '₹' + value.toLocaleString();
                                },
                                color: '#555'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month',
                                color: '#555'
                            },
                            ticks: {
                                color: '#555'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}
