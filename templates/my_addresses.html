{% extends '_base.html' %}

{% block title %}My Addresses - Karthika Futures{% endblock %}

{% block content %}
<div class="container main-content-area py-4">
    <h2 class="text-center mb-4">My Saved Addresses</h2>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm border-0 rounded-lg p-4">
                <div class="card-header bg-light py-3 rounded-top-lg d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Your Addresses</h5>
                    <a href="{{ url_for('add_address') }}" class="btn btn-sm btn-success">
                        <i class="fas fa-plus me-1"></i> Add New Address
                    </a>
                </div>
                <div class="card-body">
                    {% if addresses %}
                    <div class="list-group">
                        {% for address in addresses %}
                        <div class="list-group-item list-group-item-action mb-3 rounded shadow-sm">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <h5 class="mb-1">{{ address.label }} - {{ address.full_name }}</h5>
                                <div>
                                    <a href="{{ url_for('edit_address', addr_id=address.id) }}" class="btn btn-sm btn-info me-2">Edit</a>
                                    <button type="button" class="btn btn-sm btn-danger delete-address-btn" data-address-id="{{ address.id }}">Delete</button>
                                </div>
                            </div>
                            <p class="mb-1">{{ address.address_line1 }}</p>
                            {% if address.address_line2 %}<p class="mb-1">{{ address.address_line2 }}</p>{% endif %}
                            <p class="mb-1">{{ address.city }}, {{ address.state }} - {{ address.pincode }}</p>
                            <p class="mb-1">Phone: {{ address.phone }}</p>
                            {% if address.is_default %}<span class="badge bg-primary">Default</span>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-center">You haven't added any addresses yet. <a href="{{ url_for('add_address') }}">Add your first address!</a></p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Helper function to get CSRF token
        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrfToken
            };
        }

        // Helper function to show custom alerts
        function showCustomAlert(message, type = 'info') {
            const container = document.getElementById('flash-messages-container') || document.body;
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} flash-message position-fixed top-0 end-0 m-3 shadow`;
            alertDiv.style.zIndex = 9999;
            alertDiv.textContent = message;
            container.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        document.querySelectorAll('.delete-address-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const addressId = this.dataset.addressId;
                if (confirm('Are you sure you want to delete this address?')) {
                    try {
                        const response = await fetch(`/delete-address/${addressId}`, {
                            method: 'POST', // Use POST for deletion for security with CSRF
                            headers: getHeaders()
                        });
                        const data = await response.json();

                        if (response.ok && data.success) {
                            showCustomAlert(data.message || 'Address deleted successfully!', 'success');
                            this.closest('.list-group-item').remove(); // Remove the address div
                            // Check if no addresses left and display message
                            if (document.querySelectorAll('.list-group-item').length === 0) {
                                document.querySelector('.card-body').innerHTML = '<p class="text-center">You haven\'t added any addresses yet. <a href="{{ url_for(\'add_address\') }}">Add your first address!</a></p>';
                            }
                        } else {
                            showCustomAlert(data.message || 'Failed to delete address.', 'danger');
                        }
                    } catch (error) {
                        console.error('Error deleting address:', error);
                        showCustomAlert('An error occurred while deleting the address.', 'danger');
                    }
                }
            });
        });
    });
</script>
{% endblock %}
