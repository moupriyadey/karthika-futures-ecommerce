{% extends '_base.html' %}

{% block title %}Checkout - Karthika Futures{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-8 main-content-area">
    <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-8">Complete Your Purchase</h1>

    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Shipping Address Form -->
        <div class="lg:w-2/3 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-3">Shipping Address</h2>

            <form method="POST" action="{{ url_for('purchase_form') }}" class="space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="mb-6">
                    <label class="block text-gray-700 text-lg font-semibold mb-3">Select an Existing Address or Add New:</label>
                    <div class="space-y-4">
                        {% if user_addresses %}
                            {% for address in user_addresses %}
                            <label class="flex items-start p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition duration-200">
                                <input type="radio" name="shipping_address" value="{{ address.id }}" 
                                       class="form-radio h-5 w-5 text-primary mt-1"
                                       {% if address.id == selected_address_id or (not selected_address_id and address.is_default) %}checked{% endif %}>
                                <div class="ml-4 flex-1">
                                    <p class="text-lg font-semibold text-gray-900">{{ address.full_name }} <span class="text-sm text-gray-500">({{ address.label }})</span></p>
                                    <p class="text-gray-700">{{ address.address_line1 }}{% if address.address_line2 %}, {{ address.address_line2 }}{% endif %}</p>
                                    <p class="text-gray-700">{{ address.city }}, {{ address.state }} - {{ address.pincode }}</p>
                                    <p class="text-gray-700">Phone: {{ address.phone }}</p>
                                    {% if address.is_default %}
                                        <span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full mt-1">Default</span>
                                    {% endif %}
                                </div>
                            </label>
                            {% endfor %}
                        {% endif %}
                        <label class="flex items-start p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition duration-200">
                            <input type="radio" name="shipping_address" value="new" id="addNewAddressRadio" 
                                   class="form-radio h-5 w-5 text-primary mt-1"
                                   {% if not user_addresses or selected_address_id == 'new' %}checked{% endif %}>
                            <div class="ml-4 text-lg font-semibold text-gray-900">Add a New Address</div>
                        </label>
                    </div>
                </div>

                <!-- New Address Fields (initially hidden) -->
                <div id="newAddressFields" class="space-y-5 border border-gray-200 p-6 rounded-lg bg-gray-50">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">New Address Details</h3>
                    <div>
                        <label for="full_name" class="block text-gray-700 text-sm font-semibold mb-2">Full Name</label>
                        <input type="text" id="full_name" name="full_name" class="form-control" value="{{ form_data.full_name }}" placeholder="Enter full name">
                    </div>
                    <div>
                        <label for="phone" class="block text-gray-700 text-sm font-semibold mb-2">Phone Number</label>
                        <input type="tel" id="phone" name="phone" class="form-control" value="{{ form_data.phone }}" placeholder="Enter phone number">
                    </div>
                    <div>
                        <label for="address_line1" class="block text-gray-700 text-sm font-semibold mb-2">Address Line 1</label>
                        <input type="text" id="address_line1" name="address_line1" class="form-control" value="{{ form_data.address_line1 }}" placeholder="House No., Building, Street">
                    </div>
                    <div>
                        <label for="address_line2" class="block text-gray-700 text-sm font-semibold mb-2">Address Line 2 (Optional)</label>
                        <input type="text" id="address_line2" name="address_line2" class="form-control" value="{{ form_data.address_line2 }}" placeholder="Area, Landmark">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="city" class="block text-gray-700 text-sm font-semibold mb-2">City</label>
                            <input type="text" id="city" name="city" class="form-control" value="{{ form_data.city }}" placeholder="City">
                        </div>
                        <div>
                            <label for="state" class="block text-gray-700 text-sm font-semibold mb-2">State</label>
                            <input type="text" id="state" name="state" class="form-control" value="{{ form_data.state }}" placeholder="State">
                        </div>
                        <div>
                            <label for="pincode" class="block text-gray-700 text-sm font-semibold mb-2">Pincode</label>
                            <input type="text" id="pincode" name="pincode" class="form-control" value="{{ form_data.pincode }}" placeholder="Pincode">
                        </div>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="set_as_default" name="set_as_default" class="form-checkbox h-5 w-5 text-primary rounded" {% if form_data.is_default %}checked{% endif %}>
                        <label for="set_as_default" class="ml-2 text-gray-700 text-sm">Set as default address</label>
                    </div>
                </div>

                <button type="submit" class="w-full btn btn-primary py-3 text-xl rounded-md">
                    Place Order
                </button>
            </form>
        </div>

        <!-- Order Summary -->
        <div class="lg:w-1/3 bg-white p-6 rounded-lg shadow-md h-fit sticky top-4">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-3">Order Summary</h2>
            <div class="space-y-4 mb-6">
                {% for item in cart_items %}
                <div class="flex items-center space-x-4 border-b pb-4 last:border-b-0">
                    <img src="{{ url_for('static', filename=item.image_url) }}" alt="{{ item.artwork.name }}" class="w-20 h-20 object-cover rounded-md shadow-sm">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900">{{ item.artwork.name }}</p>
                        <p class="text-sm text-gray-600">Qty: {{ item.quantity }}</p>
                        {% if item.selected_options %}
                            <p class="text-xs text-gray-500">
                                {% for group, option in item.selected_options.items() %}
                                    {{ group }}: {{ option }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </p>
                        {% endif %}
                    </div>
                    <p class="font-bold text-gray-900">{{ item.total_price_incl_gst | currency }}</p>
                </div>
                {% endfor %}
            </div>

            <div class="space-y-2 border-t pt-4">
                <div class="flex justify-between text-gray-700">
                    <span>Subtotal (Excl. GST):</span>
                    <span class="font-semibold">{{ subtotal_before_gst | currency }}</span>
                </div>
                <div class="flex justify-between text-gray-700">
                    <span>CGST:</span>
                    <span class="font-semibold">{{ total_cgst_amount | currency }}</span>
                </div>
                <div class="flex justify-between text-gray-700">
                    <span>SGST:</span>
                    <span class="font-semibold">{{ total_sgst_amount | currency }}</span>
                </div>
                <div class="flex justify-between text-gray-700">
                    <span>IGST:</span>
                    <span class="font-semibold">{{ total_igst_amount | currency }}</span>
                </div>
                <div class="flex justify-between text-gray-700">
                    <span>UGST:</span>
                    <span class="font-semibold">{{ total_ugst_amount | currency }}</span>
                </div>
                <div class="flex justify-between text-gray-700">
                    <span>Total GST:</span>
                    <span class="font-semibold">{{ total_gst_amount | currency }}</span>
                </div>
                <div class="flex justify-between text-gray-700">
                    <span>Shipping Charge:</span>
                    <span class="font-semibold">{{ shipping_charge | currency }}</span>
                </div>
                <div class="flex justify-between items-center text-xl font-bold text-gray-800 pt-2 border-t mt-2">
                    <span>Grand Total:</span>
                    <span class="text-primary text-2xl">{{ grand_total | currency }}</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addNewAddressRadio = document.getElementById('addNewAddressRadio');
        const newAddressFields = document.getElementById('newAddressFields');
        const existingAddressRadios = document.querySelectorAll('input[name="shipping_address"]:not(#addNewAddressRadio)');

        function toggleNewAddressFields() {
            if (addNewAddressRadio.checked) {
                newAddressFields.style.display = 'block';
                // Make new address fields required when "Add New Address" is selected
                newAddressFields.querySelectorAll('input').forEach(input => {
                    if (input.name !== 'address_line2') { // address_line2 is optional
                        input.required = true;
                    }
                });
            } else {
                newAddressFields.style.display = 'none';
                // Make new address fields not required when an existing address is selected
                newAddressFields.querySelectorAll('input').forEach(input => {
                    input.required = false;
                });
            }
        }

        // Initial state on page load
        toggleNewAddressFields();

        // Event listeners for radio button changes
        addNewAddressRadio.addEventListener('change', toggleNewAddressFields);
        existingAddressRadios.forEach(radio => {
            radio.addEventListener('change', toggleNewAddressFields);
        });
    });
</script>
{% endblock %}
