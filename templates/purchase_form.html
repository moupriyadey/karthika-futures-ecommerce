{% extends '_base.html' %}

{% block title %}Checkout - Karthika Futures{% endblock %}

{% block content %}
<div class="container mx-auto px-3 py-4 md:px-4 md:py-6 main-content-area">
    <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-6 md:mb-8">Complete Your Purchase</h1>

    <div class="flex flex-col lg:flex-row gap-6 md:gap-8">
        <div class="lg:w-2/3 bg-white p-4 md:p-6 rounded-lg shadow-sm">
            <h2 class="text-2xl md:text-3xl font-semibold text-gray-800 mb-4 md:mb-6 border-b pb-2">Shipping Address</h2>

            <form method="POST" action="{{ url_for('purchase_form') }}" class="space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="mb-4">
                    <div class="card p-3 md:p-4">
                        <h5 class="mb-2 md:mb-3 text-lg font-semibold">Shipping Address</h5>

                        {% if selected_address %}
                        <div class="border rounded p-3 bg-gray-50 mb-3">
                            <strong>{{ selected_address.full_name }}</strong><br>
                            {{ selected_address.address_line1 }}, {{ selected_address.address_line2 }}<br>
                            {{ selected_address.city }}, {{ selected_address.state }} - {{ selected_address.pincode }}<br>
                            Phone: {{ selected_address.phone }}
                        </div>
                        
                        <a href="{{ url_for('my_addresses') }}" class="btn btn-outline-primary btn-sm mb-3">
                            Change Address
                        </a>

                        <!-- Hidden field -->
                        <input type="hidden" name="selected_address_id" value="{{ selected_address.id }}">

                        {% else %}
                        <p class="text-sm text-muted">No saved address found. Please enter a new shipping address:</p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label for="full_name" class="form-label">Full Name</label>
                                <input type="text" class="form-control" name="full_name" required>
                            </div>
                            <div>
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" name="phone" pattern="[0-9]{10}" maxlength="10" minlength="10" required title="Enter a valid 10-digit phone number">
                            </div>
                            <div class="md:col-span-2">
                                <label for="address_line1" class="form-label">Address Line 1</label>
                                <input type="text" class="form-control" name="address_line1" required>
                            </div>
                            <div class="md:col-span-2">
                                <label for="address_line2" class="form-label">Address Line 2 (optional)</label>
                                <input type="text" class="form-control" name="address_line2">
                            </div>
                            <div>
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" name="city" required>
                            </div>
                            <div>
                                <label for="state" class="form-label">State</label>
                                <input type="text" class="form-control" name="state" required>
                            </div>
                            <div>
                                <label for="pincode" class="form-label">Pincode</label>
                                <input type="text" class="form-control" name="pincode" pattern="[0-9]{6}" maxlength="6" minlength="6" required title="Enter a valid 6-digit pincode">
                            </div>
                        </div>

                        <div class="form-check mt-3">
                            <input type="checkbox" class="form-check-input" name="save_address">
                            <label class="form-check-label">Save this address for future orders</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="set_as_default">
                            <label class="form-check-label">Set as default address</label>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <button type="submit" class="w-full btn btn-primary py-3 text-lg rounded-md">
                    Place Order
                </button>
            </form>
        </div>

        <div class="lg:w-1/3 bg-white p-4 md:p-6 rounded-lg shadow-sm h-fit sticky top-4">
            <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-4 md:mb-6 border-b pb-2">Cart Summary</h2>
            <div class="space-y-2 mb-4">
                <div class="flex justify-between text-sm text-gray-700">
                    <span>Subtotal (Excl. GST):</span>
                    <span class="font-semibold">{{ subtotal_before_gst | currency }}</span>
                </div>
                <div class="flex justify-between text-sm text-gray-700">
                    <span>Shipping Charge:</span>
                    <span class="font-semibold">{{ shipping_charge | currency }}</span>
                </div>
                <div class="flex justify-between items-center text-lg font-bold text-gray-800 pt-2 border-t mt-2">
                    <span>Grand Total:</span>
                    <span class="text-primary text-xl">{{ final_total_amount | currency }}</span>
                </div>
            </div>

            <a href="#checkout-form" class="btn btn-warning text-white w-full text-center mb-4">Proceed to Checkout</a>

            <div class="border-t pt-4">
                <h3 class="text-lg font-semibold mb-2">Items in Cart</h3>
                <div class="space-y-3">
                    {% for item in items_to_process %}
                    <div class="flex items-start gap-3 border rounded p-2">
                        <img src="{{ url_for('static', filename=item.artwork.get_images_list()[0] if item.artwork.get_images_list() else 'images/placeholder.png') }}"
                             alt="{{ item.artwork.name }}"
                             class="w-12 h-12 object-cover rounded">
                        <div class="flex-1 text-sm">
                            <p class="font-semibold">{{ item.artwork.name }}</p>
                            <p class="text-gray-600">Qty: {{ item.quantity }}</p>
                            {% if item.selected_options %}
                            <p class="text-gray-500 text-xs">
                                {% for group, option in item.selected_options.items() %}
                                    {{ group }}: {{ option }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </p>
                            {% endif %}
                            <p class="text-primary font-bold">{{ item.total_price_incl_gst | currency }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@media (max-width: 768px) {
    .main-content-area {
        padding: 1rem !important;
    }
    .card {
        margin-bottom: 1rem;
    }
    .btn {
        width: 100%;
    }
}
</style>

{% endblock %}
