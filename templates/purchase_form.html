{% extends '_base.html' %}

{% block title %}Checkout - Karthika Futures{% endblock %}

{% block content %}
<div class="container mx-auto px-3 py-4 md:px-4 md:py-6 main-content-area">
    <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-6 md:mb-8">Complete Your Purchase</h1>

    <div class="flex flex-col lg:flex-row gap-6 md:gap-8">
        <div class="lg:w-2/3 bg-white p-4 md:p-6 rounded-lg shadow-sm">
            <div class="flex justify-between items-center mb-4 md:mb-6 border-b pb-2">
                <h2 class="text-2xl md:text-3xl font-semibold text-gray-800">Select a Saved Address</h2>
                <a href="#" onclick="toggleNewAddressForm(); return false;" class="text-sm text-blue-600 hover:underline">+ Add New Address</a>
            </div>

            {% if new_address_added %}
            <div class="alert alert-info text-sm mb-4">
                Your new address has been saved. Please select it below before proceeding.
            </div>
            {% endif %}

            <form method="POST" action="{{ url_for('purchase_form') }}" class="space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action_type" value="place_order">

                {% if user_addresses %}
                <div class="space-y-4 mb-4">
                    {% for addr in user_addresses %}
                    <div class="bg-gray-50 border p-3 rounded-lg shadow-sm space-y-2">
                        <label class="flex items-start space-x-3 cursor-pointer">
                            <input type="radio" name="selected_address_id" value="{{ addr.id }}" class="mt-1 address-radio"
                                   {% if selected_address and selected_address.id == addr.id %}checked{% endif %} required>
                            <div>
                                <p class="font-semibold">{{ addr.full_name }}</p>
                                <p>{{ addr.address_line1 }}{% if addr.address_line2 %}, {{ addr.address_line2 }}{% endif %}</p>
                                <p>{{ addr.city }}, {{ addr.state }} - {{ addr.pincode }}</p>
                                <p>Phone: {{ addr.phone }}</p>
                                {% if addr.is_default %}
                                <span class="inline-block text-xs text-green-700 bg-green-100 px-2 py-0.5 rounded">Default</span>
                                {% endif %}
                            </div>
                        </label>
                        <div class="flex justify-end space-x-4 text-sm mt-1">
                            <a href="{{ url_for('edit_address', address_id=addr.id) }}" class="text-blue-600 hover:underline">Edit</a>
                            <a href="{{ url_for('delete_address', address_id=addr.id) }}"
                               onclick="return confirm('Are you sure you want to delete this address?')"
                               class="text-red-600 hover:underline">Delete</a>
                            <a href="{{ url_for('my_addresses') }}" class="text-gray-500 hover:underline">Manage</a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <div id="newAddressForm" class="hidden">
                    <h5 class="text-md font-semibold mb-2">Enter New Address</h5>
                    <input type="hidden" name="action_type" value="add_address">
                    <input type="hidden" name="selected_address_id" value="new">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" name="full_name">
                        </div>
                        <div>
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" name="phone" pattern="[0-9]{10}" maxlength="10" minlength="10" title="Enter a valid 10-digit phone number">
                        </div>
                        <div class="md:col-span-2">
                            <label class="form-label">Address Line 1</label>
                            <input type="text" class="form-control" name="address_line1">
                        </div>
                        <div class="md:col-span-2">
                            <label class="form-label">Address Line 2 (optional)</label>
                            <input type="text" class="form-control" name="address_line2">
                        </div>
                        <div>
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" name="city">
                        </div>
                        <div>
                            <label class="form-label">State</label>
                            <input type="text" class="form-control" name="state">
                        </div>
                        <div>
                            <label class="form-label">Pincode</label>
                            <input type="text" class="form-control" name="pincode" pattern="[0-9]{6}" maxlength="6" minlength="6" title="Enter a valid 6-digit pincode">
                        </div>
                    </div>
                    <div class="form-check mt-3">
                        <input type="checkbox" class="form-check-input" name="save_address">
                        <label class="form-check-label">Save this address for future orders</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="set_as_default">
                        <label class="form-check-label">Set as default address</label>
                    </div>
                    <button type="submit" class="btn btn-success mt-4">Add New Address</button>
                </div>
            </form>
        </div>

        <div class="lg:w-1/3 bg-white p-4 md:p-6 rounded-lg shadow-sm h-fit sticky top-4">
            <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-4 md:mb-6 border-b pb-2">Cart Summary</h2>
            <div class="space-y-2 mb-4">
                <div class="flex justify-between text-sm text-gray-700">
                    <span>Subtotal (Excl. GST):</span>
                    <span class="font-semibold">{{ subtotal_before_gst | currency }}</span>
                </div>
                <div class="flex justify-between text-sm text-gray-700">
                    <span>Shipping Charge:</span>
                    <span class="font-semibold">{{ shipping_charge | currency }}</span>
                </div>
                <div class="flex justify-between items-center text-lg font-bold text-gray-800 pt-2 border-t mt-2">
                    <span>Grand Total:</span>
                    <span class="text-primary text-xl">{{ final_total_amount | currency }}</span>
                </div>
            </div>

            <form method="POST" action="{{ url_for('purchase_form') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action_type" value="place_order">
                <input type="hidden" name="selected_address_id" id="summarySelectedAddressId">
                <button type="submit" class="btn btn-primary w-full py-3 text-lg rounded-md" id="placeOrderButtonSummary" disabled>
                    Place Order
                </button>
            </form>

            <div class="border-t pt-4">
                <h3 class="text-lg font-semibold mb-2">Items in Cart</h3>
                <div class="space-y-3">
                    {% for item in items_to_process %}
                    <div class="flex items-start gap-3 border rounded p-2">
                        <img src="{{ url_for('static', filename=item.artwork.get_images_list()[0] if item.artwork.get_images_list() else 'images/placeholder.png') }}"
                             alt="{{ item.artwork.name }}"
                             class="w-12 h-12 object-cover rounded cursor-pointer popup-image">
                        <div class="flex-1 text-sm">
                            <p class="font-semibold">{{ item.artwork.name }}</p>
                            <p class="text-gray-600">Qty: {{ item.quantity }}</p>
                            {% if item.selected_options %}
                            <p class="text-gray-500 text-xs">
                                {% for group, option in item.selected_options.items() %}
                                    {{ group }}: {{ option }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </p>
                            {% endif %}
                            <p class="text-primary font-bold">{{ item.total_price_incl_gst | currency }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleNewAddressForm() {
        const form = document.getElementById('newAddressForm');
        form.classList.toggle('hidden');
    }

    document.addEventListener("DOMContentLoaded", function () {
        const radios = document.querySelectorAll('input[name="selected_address_id"]');
        const placeOrderBtn = document.getElementById('placeOrderButtonSummary');
        const hiddenInput = document.getElementById('summarySelectedAddressId');

        radios.forEach(radio => {
            radio.addEventListener('change', () => {
                placeOrderBtn.disabled = false;
                hiddenInput.value = radio.value;
            });
        });

        const selected = document.querySelector('input[name="selected_address_id"]:checked');
        if (selected) {
            placeOrderBtn.disabled = false;
            hiddenInput.value = selected.value;
        }

        document.querySelectorAll(".popup-image").forEach(img => {
            img.addEventListener("click", () => {
                document.getElementById("popupImage").src = img.src;
                document.getElementById("imagePopup").classList.remove("hidden");
            });
        });
    });

    function closePopup() {
        document.getElementById("imagePopup").classList.add("hidden");
    }
</script>

<div id="imagePopup" class="fixed inset-0 bg-black bg-opacity-80 hidden z-50 flex items-center justify-center">
    <div class="relative max-w-3xl w-full">
        <img id="popupImage" class="w-full max-h-screen object-contain relative">
        <div class="absolute inset-0 pointer-events-none z-20 flex flex-wrap justify-center items-center text-white text-lg font-bold opacity-40">
            {% for i in range(6) %}<div class="m-4">Karthikafutures</div>{% endfor %}
        </div>
        <button onclick="closePopup()" class="absolute top-4 right-4 text-white text-2xl">&times;</button>
    </div>
</div>

{% endblock %}
