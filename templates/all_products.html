<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Artworks - Karthika Futures</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-image: url('{{ url_for('static', filename='images/background_krishna_motif.jpg') }}');
            background-size: cover;
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-position: center;
        }
        .main-content-area {
            background-color: rgba(255,255,255,0.95);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .product-card {
            border: 3px solid #f3e5ab;
            border-radius: 1rem;
            background: #fff;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
            padding: 1rem;
        }
        .product-card-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #40210f;
        }
        .product-card-price {
            color: #228b22;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .section-header {
            font-family: 'Georgia', serif;
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 2rem;
            color: #4b2e17;
            border-bottom: 3px solid #d2a679;
            padding-bottom: 0.5rem;
        }
        .cart-preview {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 1rem;
            max-width: 300px;
            z-index: 999;
        }
        .cart-preview h5 {
            margin-top: 0;
        }
    </style>
</head>
<body>
    {% include '_navbar.html' %}

    <div class="container main-content-area mt-5">
        <h1 class="section-header">All Artworks</h1>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for artwork in artworks %}
            <div class="col">
                <div class="product-card h-100" data-sku="{{ artwork.sku }}" data-base-price="{{ artwork.original_price }}">
                    <img src="{{ url_for('static', filename=artwork.images[0]) }}" class="img-fluid rounded shadow-sm" alt="{{ artwork.name }}" style="cursor: pointer;" onclick="showFullscreenImage('{{ url_for('static', filename=artwork.images[0]) }}')">

                    <div class="p-2">
                        <h5 class="product-card-title">{{ artwork.name }}</h5>
                        <p class="product-card-category">Category: {{ artwork.category }}</p>
                        <p class="product-card-price">Unit Price: ‚Çπ<span class="base-price">{{ artwork.original_price }}</span></p>
                        <p class="product-card-price text-danger">Total: ‚Çπ<span class="final-price">{{ artwork.original_price }}</span></p>

                        {% if artwork.has_custom_options %}
                            {% for group, values in artwork.custom_options.items() %}
                                <label class="fw-bold d-block mt-2">{{ group }}</label>
                                <div>
                                    {% for label, price in values.items() %}
                                    <label class="me-2">
                                        <input type="radio" name="{{ group }}-{{ artwork.sku }}" value="{{ label }}" data-additional-price="{{ price }}" required> {{ label }} (+‚Çπ{{ price }})
                                    </label>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        {% endif %}

                        <div class="mt-3">
                            <label for="quantity-{{ artwork.sku }}">Quantity:</label>
                            <input type="number" id="quantity-{{ artwork.sku }}" class="form-control quantity-input" value="1" min="1" max="{{ artwork.stock }}">
                            <small class="text-muted">In stock: {{ artwork.stock }}</small>
                        </div>

                        <div class="d-grid gap-2 mt-3">
                            <button class="btn btn-primary add-to-cart-btn" data-sku="{{ artwork.sku }}">Add to Cart</button>
                            <button class="btn btn-success buy-now-btn" data-sku="{{ artwork.sku }}">Buy Now</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="cart-preview" class="cart-preview d-none">
        <h5>Cart Updated ‚úÖ</h5>
        <p id="cart-summary"></p>
        <a href="/cart" class="btn btn-sm btn-outline-primary">View Cart</a>
    </div>

    <footer class="text-center mt-5 mb-4">
        <p class="fw-bold">Please support our dharmic mission</p>
        <img src="{{ url_for('static', filename='qr_code.png') }}" alt="Donation QR" style="height: 160px;">
        <p>Scan the QR code to donate üôè</p>
    </footer>

    <script>
        function showFullscreenImage(url) {
            const win = window.open('', '_blank');
            win.document.write('<img src="' + url + '" style="width:100%; watermark:Karthikafutures">');
            win.document.title = 'Artwork Preview';
        }

        const isUserLoggedIn = {{ 'true' if session.get('user_email') else 'false' }};

        function getOptionsForCard(card) {
            const radios = card.querySelectorAll('input[type=radio]:checked');
            const options = {};
            radios.forEach(radio => {
                const groupName = radio.name.split('-')[0];
                options[groupName] = radio.value;
            });
            return options;
        }

        function calculateFinalPrice(card) {
            const basePrice = parseFloat(card.dataset.basePrice || '0');
            const radios = card.querySelectorAll('input[type=radio]:checked');
            const quantity = parseInt(card.querySelector('.quantity-input')?.value || '1');
            let total = basePrice;

            radios.forEach(radio => {
                const extra = parseFloat(radio.dataset.additionalPrice || '0');
                total += extra;
            });

            return (total * quantity).toFixed(2);
        }

        function updateDisplayedPrice(card) {
            const finalPriceElement = card.querySelector('.final-price');
            finalPriceElement.textContent = calculateFinalPrice(card);
        }

        document.querySelectorAll('.product-card').forEach(card => {
            card.querySelectorAll('input[type=radio]').forEach(radio => {
                radio.addEventListener('change', () => updateDisplayedPrice(card));
            });

            card.querySelector('.quantity-input').addEventListener('input', () => updateDisplayedPrice(card));
        });

        function showCartPreview(sku, quantity, total) {
            const preview = document.getElementById('cart-preview');
            const summary = document.getElementById('cart-summary');
            summary.textContent = `SKU: ${sku} | Qty: ${quantity} | Total: ‚Çπ${total}`;
            preview.classList.remove('d-none');
            setTimeout(() => preview.classList.add('d-none'), 5000);
        }

        document.querySelectorAll('.buy-now-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const card = btn.closest('.product-card');
                const sku = btn.dataset.sku;
                const quantity = parseInt(card.querySelector('.quantity-input')?.value || '1');
                const options = getOptionsForCard(card);

                fetch('/set_direct_purchase_item', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sku, quantity, ...options })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/purchase-form';
                    } else if (!isUserLoggedIn) {
                        window.location.href = '/login?next=purchase-form';
                    } else {
                        alert('Error: ' + (data.message || 'Unexpected error'));
                    }
                });
            });
        });

        document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const card = btn.closest('.product-card');
                const sku = btn.dataset.sku;
                const quantity = parseInt(card.querySelector('.quantity-input')?.value || '1');
                const total = calculateFinalPrice(card);
                const options = getOptionsForCard(card);

                fetch('/add-to-cart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sku, quantity, ...options })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        if (isUserLoggedIn) {
                            const cartCount = document.getElementById('cart-count');
                            if (cartCount) {
                                fetch('/get_cart_count')
                                    .then(res => res.json())
                                    .then(data => {
                                        cartCount.textContent = data.count;
                                    });
                            }
                            showCartPreview(sku, quantity, total);
                        } else {
                            window.location.href = '/login?next=all-products';
                        }
                    } else {
                        alert('Error: ' + (data.message || 'Unexpected error'));
                    }
                });
            });
        });
    </script>
</body>
</html>
