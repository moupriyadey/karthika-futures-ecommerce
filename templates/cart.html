{% extends '_base.html' %}

{% block title %}Your Cart - Karthika Futures{% endblock %}

{% block content %}
<div class="container main-content-area py-5">
    <h2 class="text-center mb-4">Your Shopping Cart</h2>

    {% if cart_summary and cart_summary.cart_items %}
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4 border-0 rounded-lg">
                <div class="card-header bg-light py-3 rounded-top-lg">
                    <h5 class="mb-0">Items in Your Cart</h5>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped align-middle">
                            <thead>
                                <tr>
                                    <th scope="col">Product</th>
                                    <th scope="col">SKU</th>
                                    <th scope="col">Options</th>
                                    <th scope="col">Unit Price</th>
                                    <th scope="col">Quantity</th>
                                    <th scope="col">Item Total</th>
                                    <th scope="col"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cart_summary.cart_items %}
                                <tr id="cart-item-{{ item.id }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ url_for('static', filename=item.image) }}" alt="{{ item.name }}" class="img-fluid rounded-lg me-3" style="width: 80px; height: 80px; object-fit: cover;">
                                            <div>
                                                <h6 class="mb-0">{{ item.name }}</h6>
                                                <small class="text-muted">{{ item.category }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ item.sku }}</td>
                                    <td>Size: {{ item.size }}<br>Frame: {{ item.frame }}<br>Glass: {{ item.glass }}</td>
                                    <td>₹{{ item.unit_price_before_gst | floatformat(2) }}</td>
                                    <td>
                                        <div class="input-group input-group-sm w-auto" style="max-width: 120px;">
                                            <button class="btn btn-outline-secondary btn-decrease-quantity" type="button" data-id="{{ item.id }}" data-sku="{{ item.sku }}" data-size="{{ item.size }}" data-frame="{{ item.frame }}" data-glass="{{ item.glass }}">-</button>
                                            <input type="number" class="form-control text-center cart-item-quantity" value="{{ item.quantity }}" min="1" data-id="{{ item.id }}" data-sku="{{ item.sku }}" data-size="{{ item.size }}" data-frame="{{ item.frame }}" data-glass="{{ item.glass }}">
                                            <button class="btn btn-outline-secondary btn-increase-quantity" type="button" data-id="{{ item.id }}" data-sku="{{ item.sku }}" data-size="{{ item.size }}" data-frame="{{ item.frame }}" data-glass="{{ item.glass }}">+</button>
                                        </div>
                                    </td>
                                    <td class="fw-bold">₹<span id="item-total-{{ item.id }}">{{ item.total_price | floatformat(2) }}</span></td>
                                    <td><button class="btn btn-sm btn-outline-danger btn-remove-item" data-id="{{ item.id }}" data-sku="{{ item.sku }}" data-size="{{ item.size }}" data-frame="{{ item.frame }}" data-glass="{{ item.glass }}"><i class="fas fa-times"></i></button></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-light py-3 rounded-top-lg">
                    <h5 class="mb-0">Order Summary</h5>
                </div>
                <div class="card-body p-4">
                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item d-flex justify-content-between align-items-center">Subtotal (excl. GST): <span>₹<span id="cart-subtotal-before-gst">{{ cart_summary.subtotal_before_gst | floatformat(2) }}</span></span></li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">Total GST: <span>₹<span id="cart-total-gst">{{ cart_summary.total_gst_amount | floatformat(2) }}</span></span></li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">Shipping Charge: <span>₹<span id="cart-shipping-charge">{{ cart_summary.shipping_charge | floatformat(2) }}</span></span></li>
                        <li class="list-group-item d-flex justify-content-between align-items-center fs-5 fw-bold bg-light">Grand Total: <span>₹<span id="cart-grand-total">{{ cart_summary.grand_total | floatformat(2) }}</span></span></li>
                    </ul>

                    <div class="d-grid gap-2 mt-4">
                        <form action="{{ url_for('process_checkout_from_cart') }}" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-primary btn-lg w-100">Proceed to Checkout</button>
                        </form>
                        <a href="{{ url_for('all_products') }}" class="btn btn-outline-secondary btn-lg w-100 mt-2">Continue Shopping</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-shopping-cart fa-5x text-muted mb-4"></i>
        <p class="lead mb-4">Your cart is currently empty. Start shopping now!</p>
        <a href="{{ url_for('all_products') }}" class="btn btn-primary btn-lg">Browse Artworks</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const updateCartItem = async (itemId, sku, size, frame, glass, newQuantity) => {
            try {
                const response = await fetch('{{ url_for("update_cart_item_quantity") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: itemId, sku, size, frame, glass, quantity: newQuantity })
                });
                const data = await response.json();
                if (data.success) {
                    document.getElementById(`item-total-${itemId}`).textContent = parseFloat(data.updated_item.total_price).toFixed(2);
                    document.getElementById('cart-subtotal-before-gst').textContent = parseFloat(data.cart_summary.subtotal_before_gst).toFixed(2);
                    document.getElementById('cart-total-gst').textContent = parseFloat(data.cart_summary.total_gst_amount).toFixed(2);
                    document.getElementById('cart-shipping-charge').textContent = parseFloat(data.cart_summary.shipping_charge).toFixed(2);
                    document.getElementById('cart-grand-total').textContent = parseFloat(data.cart_summary.grand_total).toFixed(2);
                    updateCartCountDisplay();
                    showCustomAlert(`Quantity updated for "${data.updated_item.name}"`, 'success');
                } else {
                    showCustomAlert(`Error: ${data.message}`, 'danger');
                }
            } catch (err) {
                console.error(err);
                showCustomAlert("Failed to update cart. Please try again.", 'danger');
            }
        };

        const removeCartItem = async (itemId, sku, size, frame, glass) => {
            try {
                const response = await fetch('{{ url_for("remove_from_cart") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: itemId, sku, size, frame, glass })
                });
                const data = await response.json();
                if (data.success) {
                    const itemRow = document.getElementById(`cart-item-${itemId}`);
                    if (itemRow) itemRow.remove();
                    if (data.cart_summary) {
                        document.getElementById('cart-subtotal-before-gst').textContent = parseFloat(data.cart_summary.subtotal_before_gst).toFixed(2);
                        document.getElementById('cart-total-gst').textContent = parseFloat(data.cart_summary.total_gst_amount).toFixed(2);
                        document.getElementById('cart-shipping-charge').textContent = parseFloat(data.cart_summary.shipping_charge).toFixed(2);
                        document.getElementById('cart-grand-total').textContent = parseFloat(data.cart_summary.grand_total).toFixed(2);
                    } else {
                        document.querySelector('.container.main-content-area.py-5').innerHTML = `
                            <div class="text-center py-5">
                                <i class="fas fa-shopping-cart fa-5x text-muted mb-4"></i>
                                <p class="lead mb-4">Your cart is currently empty. Start shopping now!</p>
                                <a href="{{ url_for('all_products') }}" class="btn btn-primary btn-lg">Browse Artworks</a>
                            </div>`;
                    }
                    updateCartCountDisplay();
                    showCustomAlert("Item removed from cart.", 'success');
                } else {
                    showCustomAlert(`Error: ${data.message}`, 'danger');
                }
            } catch (err) {
                console.error(err);
                showCustomAlert("Network error. Try again.", 'danger');
            }
        };

        document.querySelectorAll('.cart-item-quantity').forEach(input => {
            input.addEventListener('change', function() {
                const itemId = this.dataset.id;
                const sku = this.dataset.sku;
                const size = this.dataset.size;
                const frame = this.dataset.frame;
                const glass = this.dataset.glass;
                const newQuantity = parseInt(this.value);
                if (newQuantity < 1) {
                    this.value = 1;
                    showCustomAlert("Quantity cannot be less than 1.", 'warning');
                    return;
                }
                updateCartItem(itemId, sku, size, frame, glass, newQuantity);
            });
        });

        document.querySelectorAll('.btn-increase-quantity, .btn-decrease-quantity').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.dataset.id;
                const sku = this.dataset.sku;
                const size = this.dataset.size;
                const frame = this.dataset.frame;
                const glass = this.dataset.glass;
                const quantityInput = document.querySelector(`.cart-item-quantity[data-id="${itemId}"]`);
                let currentQuantity = parseInt(quantityInput.value);
                currentQuantity += this.classList.contains('btn-increase-quantity') ? 1 : -1;
                if (currentQuantity < 1) {
                    showCustomAlert("Quantity cannot be less than 1.", 'warning');
                    return;
                }
                quantityInput.value = currentQuantity;
                updateCartItem(itemId, sku, size, frame, glass, currentQuantity);
            });
        });

        document.querySelectorAll('.btn-remove-item').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.dataset.id;
                const sku = this.dataset.sku;
                const size = this.dataset.size;
                const frame = this.dataset.frame;
                const glass = this.dataset.glass;
                if (confirm("Are you sure you want to remove this item from your cart?")) {
                    removeCartItem(itemId, sku, size, frame, glass);
                }
            });
        });
    });
</script>
{% endblock %}
