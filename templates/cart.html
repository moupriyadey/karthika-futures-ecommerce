{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto p-4 bg-white bg-opacity-90 rounded-lg shadow-lg">
    <h2 class="text-4xl font-bold text-gray-800 mb-6 text-center">Your Shopping Cart</h2>

    {% if cart_items %}
    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Cart Items List -->
        <div class="lg:w-2/3 space-y-4">
            {% for item in cart_items %}
            <div class="flex items-center bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                <img src="{{ url_for('static', filename=item.image) }}" alt="{{ item.name }}" class="w-24 h-24 object-cover rounded-md mr-4 shadow-md">
                <div class="flex-grow">
                    <h3 class="text-xl font-bold text-gray-900">{{ item.name }}</h3>
                    <p class="text-gray-600 text-sm">
                        {% if item.size and item.size != 'Original' %}Size: {{ item.size }} &nbsp;{% endif %}
                        {% if item.frame and item.frame != 'None' %}Frame: {{ item.frame }} &nbsp;{% endif %}
                        {% if item.glass and item.glass != 'None' %}Glass: {{ item.glass }}{% endif %}
                    </p>
                    <p class="text-gray-700 font-semibold mt-1">Unit Price: ₹{{ item.unit_price | float | int }}</p>
                    <div class="flex items-center mt-2">
                        <label for="quantity-{{ item.id }}" class="mr-2 text-gray-700">Quantity:</label>
                        <input type="number" id="quantity-{{ item.id }}" value="{{ item.quantity }}" min="1"
                               class="w-20 p-2 border border-gray-300 rounded-md text-center quantity-input"
                               data-item-id="{{ item.id }}">
                    </div>
                </div>
                <div class="text-right flex flex-col items-end">
                    <p class="text-lg font-bold text-blue-600">Total: ₹{{ item.calculated_display_price | float | int }}</p>
                    <button class="bg-red-500 hover:bg-red-600 text-white py-1.5 px-3 rounded-md mt-2 text-sm remove-from-cart-btn"
                            data-item-id="{{ item.id }}">
                        Remove
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Order Summary -->
        <div class="lg:w-1/3 bg-gray-50 p-6 rounded-lg shadow-md border border-gray-200 h-fit sticky top-24">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Order Summary</h3>
            <div class="space-y-3 text-gray-700">
                <div class="flex justify-between">
                    <span>Subtotal (before GST):</span>
                    <span class="font-semibold">₹{{ subtotal_before_gst | float | int }}</span>
                </div>
                <div class="flex justify-between">
                    <span>GST (Total):</span>
                    <span class="font-semibold">₹{{ total_gst_amount | float | int }}</span>
                </div>
                <div class="flex justify-between text-sm ml-4">
                    <span>CGST:</span>
                    <span>₹{{ cgst_amount | float | int }}</span>
                </div>
                <div class="flex justify-between text-sm ml-4">
                    <span>SGST:</span>
                    <span>₹{{ sgst_amount | float | int }}</span>
                </div>
                <div class="flex justify-between border-t border-gray-200 pt-3 mt-3">
                    <span>Shipping Charges:</span>
                    <span class="font-semibold">
                        {% if shipping_charge > 0 %}
                            ₹{{ shipping_charge | float | int }}
                        {% else %}
                            Free Shipping
                        {% endif %}
                    </span>
                </div>
                <div class="flex justify-between text-xl font-bold text-gray-900 border-t-2 border-gray-300 pt-4 mt-4">
                    <span>Grand Total:</span>
                    <span>₹{{ grand_total | float | int }}</span>
                </div>
            </div>
            <form action="{{ url_for('purchase_form') }}" method="POST" class="mt-6">
                <input type="hidden" name="cart_json" id="cart-json-input">
                <input type="hidden" name="shipping_charge" value="{{ shipping_charge }}">
                <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 transform hover:scale-105 shadow-md">
                    Proceed to Checkout
                </button>
            </form>
        </div>
    </div>
    {% else %}
    <p class="text-center text-gray-600 text-lg py-8">Your cart is empty. Start shopping now!</p>
    <div class="lg:w-1/3 mx-auto bg-gray-50 p-6 rounded-lg shadow-md border border-gray-200 h-fit">
        <h3 class="text-2xl font-bold text-gray-800 mb-4">Order Summary</h3>
        <div class="space-y-3 text-gray-700">
            <div class="flex justify-between">
                <span>Subtotal (before GST):</span>
                <span class="font-semibold">₹0</span>
            </div>
            <div class="flex justify-between">
                <span>GST (Total):</span>
                <span class="font-semibold">₹0</span>
            </div>
            <div class="flex justify-between text-sm ml-4">
                <span>CGST:</span>
                <span>₹0</span>
            </div>
            <div class="flex justify-between text-sm ml-4">
                <span>SGST:</span>
                <span>₹0</span>
            </div>
            <div class="flex justify-between border-t border-gray-200 pt-3 mt-3">
                <span>Shipping Charges:</span>
                <span class="font-semibold">Free Shipping</span>
            </div>
            <div class="flex justify-between text-xl font-bold text-gray-900 border-t-2 border-gray-300 pt-4 mt-4">
                <span>Grand Total:</span>
                <span>₹0</span>
            </div>
        </div>
        <a href="{{ url_for('all_products') }}" class="w-full text-center block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 transform hover:scale-105 shadow-md mt-6">
            Continue Shopping
        </a>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Function to update cart item quantity and trigger server sync
        const quantityInputs = document.querySelectorAll('.quantity-input');
        quantityInputs.forEach(input => {
            input.addEventListener('change', (event) => {
                const itemId = event.target.dataset.itemId;
                let newQuantity = parseInt(event.target.value);

                if (isNaN(newQuantity) || newQuantity < 0) {
                    newQuantity = 1; // Default to 1 if invalid
                    event.target.value = 1;
                }

                updateCartItemQuantity(itemId, newQuantity);
                // Reload the page after updating to reflect new totals.
                // In a real application, you might update the UI dynamically with AJAX.
                window.location.reload(); 
            });
        });

        // Function to remove item from cart
        const removeButtons = document.querySelectorAll('.remove-from-cart-btn');
        removeButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const itemId = event.target.dataset.itemId;
                removeFromCart(itemId);
                // Reload the page after removing to reflect new totals.
                window.location.reload(); 
            });
        });

        // Populate hidden input with cart data before form submission
        const purchaseForm = document.querySelector('form[action*="purchase-form"]');
        if (purchaseForm) {
            purchaseForm.addEventListener('submit', (event) => {
                document.getElementById('cart-json-input').value = JSON.stringify(Object.values(cart));
            });
        }
    });

    // Client-side cart functions (from base.html, repeated here for clarity if this file is viewed standalone)
    // Should generally be loaded once via base.html's script block
    // These are placeholders/references, actual functions are in base.html script tag
    // let cart = JSON.parse(localStorage.getItem('cart')) || {}; // Already defined in base.html
    // function updateCartCount() { /* ... defined in base.html ... */ }
    // function addToCart() { /* ... defined in base.html ... */ }
    // function removeFromCart() { /* ... defined in base.html ... */ }
    // function updateCartItemQuantity() { /* ... defined in base.html ... */ }
    // function syncCartWithServer() { /* ... defined in base.html ... */ }

</script>
{% endblock %}
